<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>目标检测/分割/图像描述_MS COCO数据集及pycocotools的使用 | Miraclo’s Blog</title><meta name="author" content="Miraclo"><meta name="copyright" content="Miraclo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考内容来自霹雳吧啦Wz up主的b站链接：https:&#x2F;&#x2F;space.bilibili.com&#x2F;18161609&#x2F;channel&#x2F;index up主的github：https:&#x2F;&#x2F;github.com&#x2F;WZMIAOMIAO&#x2F;deep-learning-for-image-processing up主的CSDN博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_37541097&#x2F;articl">
<meta property="og:type" content="article">
<meta property="og:title" content="目标检测&#x2F;分割&#x2F;图像描述_MS COCO数据集及pycocotools的使用">
<meta property="og:url" content="http://unicorn-acc.github.io/DeepLearning/dataset/MSCOCO/index.html">
<meta property="og:site_name" content="Miraclo’s Blog">
<meta property="og:description" content="参考内容来自霹雳吧啦Wz up主的b站链接：https:&#x2F;&#x2F;space.bilibili.com&#x2F;18161609&#x2F;channel&#x2F;index up主的github：https:&#x2F;&#x2F;github.com&#x2F;WZMIAOMIAO&#x2F;deep-learning-for-image-processing up主的CSDN博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_37541097&#x2F;articl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg">
<meta property="article:published_time" content="2022-11-11T16:17:35.000Z">
<meta property="article:modified_time" content="2022-11-15T11:33:20.203Z">
<meta property="article:author" content="Miraclo">
<meta property="article:tag" content="DeepLearning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://unicorn-acc.github.io/DeepLearning/dataset/MSCOCO/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":2000},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":500,"languages":{"author":"作者: Miraclo","link":"链接: ","source":"来源: Miraclo’s Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '目标检测/分割/图像描述_MS COCO数据集及pycocotools的使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-15 11:33:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">159</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span> </span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Miraclo’s Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span> </span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">目标检测/分割/图像描述_MS COCO数据集及pycocotools的使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-11T16:17:35.000Z" title="发表于 2022-11-11 16:17:35">2022-11-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-15T11:33:20.203Z" title="更新于 2022-11-15 11:33:20">2022-11-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">深度学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E9%9B%86/">数据集</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="目标检测/分割/图像描述_MS COCO数据集及pycocotools的使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>参考内容来自霹雳吧啦Wz</p>
<p>up主的b站链接：https://space.bilibili.com/18161609/channel/index</p>
<p>up主的github：https://github.com/WZMIAOMIAO/deep-learning-for-image-processing</p>
<p>up主的CSDN博客：https://blog.csdn.net/qq_37541097/article/details/103482003</p>
<p>文章链接：https://blog.csdn.net/qq_37541097/article/details/113247318</p>
</blockquote>
<h1 id="一microsoft-coco数据集简介">一、Microsoft COCO数据集简介</h1>
<p>官网地址：https://cocodataset.org/</p>
<p>简介MS COCO是一个非常大型且常用的数据集，其中包括了目标检测，分割，图像描述等。其主要特性如下： - <code>Object segmentation</code>: 目标级分割 - <code>Recognition in context</code>: 图像情景识别 - <code>Superpixel stuff segmentation</code>: 超像素分割 - <code>330K images (&gt;200K labeled)</code>: 超过33万张图像，标注过的图像超过20万张 - <code>1.5 million object instances</code>: 150万个对象实例 - <code>80 object categories</code>: 80个目标类别 - <code>91 stuff categories</code>: 91个材料类别 - <code>5 captions per image</code>: 每张图像有5段情景描述 - <code>250,000 people with keypoints</code>: 对25万个人进行了关键点标注 <img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111742936.png" /></p>
<p>注意事项 - 这里需要注意的一个点是“什么是stuff类别”，在官方的介绍论文中是这么定义的： <code>where “stuff” categories include materials and objects with no clear boundaries (sky, street, grass)</code> 简单的理解就是<strong>stuff中包含没有明确边界的材料和对象</strong>。 - object的80类与stuff中的91类的区别在哪？在官方的介绍论文中有如下说明： <code>Note that we have limited the 2014 release to a subset of 80 categories. We did not collect segmentations for the following 11 categories: hat, shoe, eyeglasses (too many instances), mirror, window, door, street sign (ambiguous and difficult to label), plate, desk (due to confusion with bowl and dining table, respectively) and blender, hair brush (too few instances).</code> 简单的理解就是<strong>object80类是stuff91类的子集</strong>。对于我们自己使用，如果仅仅是做目标检测，基本只用object80类即可。</p>
<p>简单与PASCAL VOC数据集对比 下图是官方介绍论文中统计的对比图，通过对比很明显，<strong>不仅类别更多，每个类别标注的目标也更多。</strong></p>
<ul>
<li>预训练效果更好，但更费时</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111742416.png" /></p>
<p>如果想进一步了解该数据集，可以去阅读下官方的介绍论文： Microsoft COCO: Common Objects in Context https://arxiv.org/pdf/1405.0312.pdf</p>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111742066.png" style="zoom: 50%;" /></p>
<h1 id="二ms-coco数据集下载目标检测">二、MS COCO数据集下载（目标检测）</h1>
<p>这里以下载coco2017数据集为例，主要下载三个文件：</p>
<ul>
<li><code>2017 Train images [118K/18GB]</code>：训练过程中使用到的所有图像文件</li>
<li><code>2017 Val images [5K/1GB]</code>：验证过程中使用到的所有图像文件</li>
<li><code>2017 Train/Val annotations [241MB]</code>：对应训练集和验证集的标注json文件</li>
</ul>
<p>下载后都解压到<code>coco2017</code>目录下，可以得到如下目录结构：</p>
<pre class="line-numbers language-none"><code class="language-none">├── coco2017: 数据集根目录
     ├── train2017: 所有训练图像文件夹(118287张)
     ├── val2017: 所有验证图像文件夹(5000张)
     └── annotations: 对应标注文件夹
     		  ├── instances_train2017.json: 对应目标检测、分割任务的训练集标注文件
     		  ├── instances_val2017.json: 对应目标检测、分割任务的验证集标注文件
     		  ├── captions_train2017.json: 对应图像描述的训练集标注文件
     		  ├── captions_val2017.json: 对应图像描述的验证集标注文件
     		  ├── person_keypoints_train2017.json: 对应人体关键点检测的训练集标注文件
     		  └── person_keypoints_val2017.json: 对应人体关键点检测的验证集标注文件夹<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="三ms-coco标注文件格式">三、MS COCO标注文件格式</h1>
<p>官网有给出一个关于标注文件的格式说明，可以通过以下链接查看： https://cocodataset.org/#format-data</p>
<h2 id="使用python的json库查看">3.1 使用Python的json库查看</h2>
<p>对着官方给的说明，我们可以自己用Python的json库自己读取看下，下面以读取<code>instances_val2017.json</code>为例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json

json_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/annotations/instances_val2017.json"</span>
json_labels <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>json_labels<span class="token punctuation">[</span><span class="token string">"info"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>单步调试可以看到读入进来后是个字典的形式，包括了<code>info</code>、<code>licenses</code>、<code>images</code>、<code>annotations</code>以及<code>categories</code>信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111742721.png" /></p>
<p>其中：</p>
<ul>
<li><code>images</code>是一个列表（元素个数对应图像的张数），列表中每个元素都是一个<code>dict</code>，对应一张图片的相关信息。包括对应<strong>图像名称</strong>、<strong>图像宽度</strong>、<strong>高度</strong>等信息。 <img src="https://img-blog.csdnimg.cn/20210127150138181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3NTQxMDk3,size_16,color_FFFFFF,t_70#pic_center" alt="images_info" /></li>
<li><code>annotations</code>是一个列表（元素个数对应数据集中所有标注的目标个数，注意不是图像的张数），列表中每个元素都是一个<code>dict</code>对应一个目标的标注信息。包括目标的<strong>分割信息</strong>（<code>polygons</code>多边形）、<strong>目标边界框信息[x,y,width,height]（左上角x,y坐标，以及宽高）</strong>、<strong>目标面积</strong>、<strong>对应图像id</strong>以及<strong>类别id</strong>等。<code>iscrowd</code>参数只有0或1两种情况，一般0代表单个对象，1代表对象集合。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111743452.png" /></p>
<ul>
<li><code>categories</code>是一个列表（元素个数对应检测目标的类别数）列表中每个元素都是一个<code>dict</code>对应一个类别的目标信息。包括<strong>类别id</strong>、<strong>类别名称</strong>和<strong>所属超类</strong>。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211111743318.png" /></p>
<h2 id="使用官方cocoapi查看">3.2 使用官方cocoAPI查看</h2>
<p>官方有给出一个读取MS COCO数据集信息的API（当然，该API还有其他重要功能），下面是对应github的连接，里面有关于该API的使用demo： https://github.com/cocodataset/cocoapi</p>
<ul>
<li>Linux系统安装pycocotools：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> pycocotools  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Windows系统安装pycocotools：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">pip install pycocotools-windows<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="读取每张图片的bbox信息">读取每张图片的bbox信息</h4>
<p>下面是使用<code>pycocotools</code>读取图像以及对应bbox信息的简单示例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> pycocotools<span class="token punctuation">.</span>coco <span class="token keyword">import</span> COCO
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDraw
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

json_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/annotations/instances_val2017.json"</span>
img_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/val2017"</span>

<span class="token comment"># load coco data</span>
coco <span class="token operator">=</span> COCO<span class="token punctuation">(</span>annotation_file<span class="token operator">=</span>json_path<span class="token punctuation">)</span>

<span class="token comment"># get all image index info</span>
ids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>coco<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"number of images: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># get all coco class labels</span>
coco_classes <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> coco<span class="token punctuation">.</span>cats<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 遍历前三张图像</span>
<span class="token keyword">for</span> img_id <span class="token keyword">in</span> ids<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取对应图像id的所有annotations idx信息</span>
    ann_ids <span class="token operator">=</span> coco<span class="token punctuation">.</span>getAnnIds<span class="token punctuation">(</span>imgIds<span class="token operator">=</span>img_id<span class="token punctuation">)</span>

    <span class="token comment"># 根据annotations idx信息获取所有标注信息</span>
    targets <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadAnns<span class="token punctuation">(</span>ann_ids<span class="token punctuation">)</span>

    <span class="token comment"># get image file name</span>
    path <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadImgs<span class="token punctuation">(</span>img_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span>

    <span class="token comment"># read image</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># draw box to image</span>
    <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">:</span> <span class="token comment"># 遍历图片的每个目标的标注，获取boundingbox</span>
        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"bbox"</span><span class="token punctuation">]</span>
        x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">+</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> h<span class="token punctuation">)</span> <span class="token comment"># 左上角和右下角坐标</span>
        draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> coco_classes<span class="token punctuation">[</span>target<span class="token punctuation">[</span><span class="token string">"category_id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># show image</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>pycocotools</code>读取的图像以及对应的targets信息，配合matplotlib库绘制标注图像如下： <img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211112141317.png" /></p>
<h4 id="读取每张图像的segmentation信息">读取每张图像的segmentation信息</h4>
<p>下面是使用<code>pycocotools</code>读取图像segmentation信息的简单示例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> pycocotools<span class="token punctuation">.</span>coco <span class="token keyword">import</span> COCO
<span class="token keyword">from</span> pycocotools <span class="token keyword">import</span> mask <span class="token keyword">as</span> coco_mask
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDraw
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

json_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/annotations/instances_val2017.json"</span>
img_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/val2017"</span>

<span class="token comment"># random pallette</span>
pallette <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># load coco data</span>
coco <span class="token operator">=</span> COCO<span class="token punctuation">(</span>annotation_file<span class="token operator">=</span>json_path<span class="token punctuation">)</span>

<span class="token comment"># get all image index info</span>
ids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>coco<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"number of images: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># get all coco class labels</span>
coco_classes <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> coco<span class="token punctuation">.</span>cats<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 遍历前三张图像</span>
<span class="token keyword">for</span> img_id <span class="token keyword">in</span> ids<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取对应图像id的所有annotations idx信息</span>
    ann_ids <span class="token operator">=</span> coco<span class="token punctuation">.</span>getAnnIds<span class="token punctuation">(</span>imgIds<span class="token operator">=</span>img_id<span class="token punctuation">)</span>
    <span class="token comment"># 根据annotations idx信息获取所有标注信息</span>
    targets <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadAnns<span class="token punctuation">(</span>ann_ids<span class="token punctuation">)</span>

    <span class="token comment"># get image file name</span>
    path <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadImgs<span class="token punctuation">(</span>img_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span>
    <span class="token comment"># read image</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>img_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    img_w<span class="token punctuation">,</span> img_h <span class="token operator">=</span> img<span class="token punctuation">.</span>size

    masks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    cats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">:</span>
        cats<span class="token punctuation">.</span>append<span class="token punctuation">(</span>target<span class="token punctuation">[</span><span class="token string">"category_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># get object class id</span>
        polygons <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"segmentation"</span><span class="token punctuation">]</span>   <span class="token comment"># get object polygons</span>
        rles <span class="token operator">=</span> coco_mask<span class="token punctuation">.</span>frPyObjects<span class="token punctuation">(</span>polygons<span class="token punctuation">,</span> img_h<span class="token punctuation">,</span> img_w<span class="token punctuation">)</span>
        mask <span class="token operator">=</span> coco_mask<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>rles<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> mask<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        masks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>

    cats <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>cats<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    <span class="token keyword">if</span> masks<span class="token punctuation">:</span>
        masks <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        masks <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    <span class="token comment"># merge all instance masks into a single segmentation map</span>
    <span class="token comment"># with its corresponding categories</span>
    target <span class="token operator">=</span> <span class="token punctuation">(</span>masks <span class="token operator">*</span> cats<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># discard overlapping instances</span>
    target<span class="token punctuation">[</span>masks<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
    target <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>target<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">)</span>

    target<span class="token punctuation">.</span>putpalette<span class="token punctuation">(</span>pallette<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>pycocotools</code>读取的图像segmentation信息，配合matplotlib库绘制标注图像如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211112142148.png" /></p>
<h4 id="读取人体关键点信息">读取人体关键点信息</h4>
<p>在MS COCO任务中，对每个人体都标注了17的关键点，这17个关键点的部位分别如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[&quot;nose&quot;,&quot;left_eye&quot;,&quot;right_eye&quot;,&quot;left_ear&quot;,&quot;right_ear&quot;,&quot;left_shoulder&quot;,&quot;right_shoulder&quot;,&quot;left_elbow&quot;,&quot;right_elbow&quot;,&quot;left_wrist&quot;,&quot;right_wrist&quot;,&quot;left_hip&quot;,&quot;right_hip&quot;,&quot;left_knee&quot;,&quot;right_knee&quot;,&quot;left_ankle&quot;,&quot;right_ankle&quot;]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在COCO给出的标注文件中，针对每个人体的标注格式如下所示。其中每3个值为一个关键点的相关信息，因为有17个关键点所以总共有51个数值。按照3个一组进行划分，前2个值代表关键点的x，y坐标，第3个值代表该关键点的可见度，它只会取{ 0 , 1 , 2 } {0, 1, 2}{0,1,2}三个值。<code>0</code>表示该点一般是在图像外无法标注，<code>1</code>表示虽然该点不可见但大概能猜测出位置（比如人侧着站时虽然有一只耳朵被挡住了，但大概也能猜出位置），<code>2</code>表示该点可见。如果第3个值为<code>0</code>，那么对应的x，y也都等于0：</p>
<pre class="line-numbers language-none"><code class="language-none">[427, 170, 1, 429, 169, 2, 0, 0, 0, 434, 168, 2, 0, 0, 0, 441, 177, 2, 446, 177, 2, 437, 200, 2, 430, 206, 2, 430, 220, 2, 420, 215, 2, 445, 226, 2, 452, 223, 2, 447, 260, 2, 454, 257, 2, 455, 290, 2, 459, 286, 2]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下面是使用<code>pycocotools</code>读取图像keypoints信息的简单示例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> pycocotools<span class="token punctuation">.</span>coco <span class="token keyword">import</span> COCO

json_path <span class="token operator">=</span> <span class="token string">"/data/coco2017/annotations/person_keypoints_val2017.json"</span>
coco <span class="token operator">=</span> COCO<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span>
img_ids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>coco<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 遍历前5张图片中的人体关键点信息(注意，并不是每张图片里都有人体信息)</span>
<span class="token keyword">for</span> img_id <span class="token keyword">in</span> img_ids<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    idx <span class="token operator">=</span> <span class="token number">0</span>
    img_info <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadImgs<span class="token punctuation">(</span>img_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    ann_ids <span class="token operator">=</span> coco<span class="token punctuation">.</span>getAnnIds<span class="token punctuation">(</span>imgIds<span class="token operator">=</span>img_id<span class="token punctuation">)</span>
    anns <span class="token operator">=</span> coco<span class="token punctuation">.</span>loadAnns<span class="token punctuation">(</span>ann_ids<span class="token punctuation">)</span>
    <span class="token keyword">for</span> ann <span class="token keyword">in</span> anns<span class="token punctuation">:</span>
        xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> ann<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span>
        <span class="token comment"># 打印人体bbox信息</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[image id: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>img_id<span class="token punctuation">&#125;</span></span><span class="token string">] person </span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string"> bbox: [</span><span class="token interpolation"><span class="token punctuation">&#123;</span>xmin<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ymin<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>xmin <span class="token operator">+</span> w<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ymin <span class="token operator">+</span> h<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string">]"</span></span><span class="token punctuation">)</span>
        keypoints_info <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>ann<span class="token punctuation">[</span><span class="token string">"keypoints"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        visible <span class="token operator">=</span> keypoints_info<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        keypoints <span class="token operator">=</span> keypoints_info<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># 打印关键点信息以及可见度信息</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[image id: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>img_id<span class="token punctuation">&#125;</span></span><span class="token string">] person </span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string"> keypoints: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>keypoints<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[image id: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>img_id<span class="token punctuation">&#125;</span></span><span class="token string">] person </span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string"> keypoints visible: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>visible<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        idx <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>终端输出信息如下，通过以下信息可知，验证集中前5张图片里只有一张图片包含人体关键点信息：</p>
<pre class="line-numbers language-none"><code class="language-none">[image id: 139] person 0 bbox: [412.80, 157.61, 465.85, 295.62]
[image id: 139] person 0 keypoints: [[427, 170], [429, 169], [0, 0], [434, 168], [0, 0], [441, 177], [446, 177], [437, 200], [430, 206], [430, 220], [420, 215], [445, 226], [452, 223], [447, 260], [454, 257], [455, 290], [459, 286]]
[image id: 139] person 0 keypoints visible: [1, 2, 0, 2, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
[image id: 139] person 1 bbox: [384.43, 172.21, 399.55, 207.95]
[image id: 139] person 1 keypoints: [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [0, 0]]
[image id: 139] person 1 keypoints visible: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="四验证目标检测任务map">四、验证目标检测任务mAP</h1>
<p>首先要弄清楚cocoapi指定的数据格式（训练网络预测的结果），在官网的<code>Evaluate</code>下拉框中选择<code>Results Format</code>，可以看到每种任务的指定数据格式要求。 <img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211112143231.png" />这里主要讲讲针对目标检测的格式。根据官方文档给的预测结果格式可以看到，我们需要以列表的形式保存结果，列表中的每个元素对应一个检测目标（每个元素都是字典类型)，每个目标记录了四个信息：</p>
<ul>
<li><code>image_id</code>记录该目标所属图像的id（<code>int</code>类型）</li>
<li><code>category_id</code>记录预测该目标的类别索引，注意这里索引是对应stuff中91个类别的索引信息（<code>int</code>类型）</li>
<li><code>bbox</code>记录预测该目标的边界框信息，注意对应目标的[xmin, ymin, width, height] (<code>list[float]</code>类型)</li>
<li><code>score</code>记录预测该目标的概率（<code>float</code>类型）</li>
</ul>
<p>下图是训练Faster R-CNN后在coco2017验证集上预测的结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211112145231.png" style="zoom:67%;" /></p>
<p>接着将预测结果保存成json文件，后面需要使用到：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json

results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有预测的结果都保存在该list中</span>
<span class="token comment"># write predict results into json file</span>
json_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>results<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'predict_results.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> json_file<span class="token punctuation">:</span>
    json_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>数据准备：</p>
<ul>
<li>COCO2017验证集json文件<code>instances_val2017.json</code> 链接: https://pan.baidu.com/s/1ArWe8Igt_q0iJG6FCcH8mg 密码: sa0j</li>
<li>自己训练的Faster R-CNN(VGG16)在验证集上预测的结果<code>predict_results.json</code>（刚刚上面生成的） 链接: https://pan.baidu.com/s/1h5RksfkPFTvH82N2qN95TA 密码: 8alm</li>
</ul>
<p>示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pycocotools<span class="token punctuation">.</span>coco <span class="token keyword">import</span> COCO
<span class="token keyword">from</span> pycocotools<span class="token punctuation">.</span>cocoeval <span class="token keyword">import</span> COCOeval


<span class="token comment"># accumulate predictions from all images</span>
<span class="token comment"># 载入coco2017验证集标注文件</span>
coco_true <span class="token operator">=</span> COCO<span class="token punctuation">(</span>annotation_file<span class="token operator">=</span><span class="token string">"/data/coco2017/annotations/instances_val2017.json"</span><span class="token punctuation">)</span>
<span class="token comment"># 载入网络在coco2017验证集上预测的结果</span>
coco_pre <span class="token operator">=</span> coco_true<span class="token punctuation">.</span>loadRes<span class="token punctuation">(</span><span class="token string">'predict_results.json'</span><span class="token punctuation">)</span>

coco_evaluator <span class="token operator">=</span> COCOeval<span class="token punctuation">(</span>cocoGt<span class="token operator">=</span>coco_true<span class="token punctuation">,</span> cocoDt<span class="token operator">=</span>coco_pre<span class="token punctuation">,</span> iouType<span class="token operator">=</span><span class="token string">"bbox"</span><span class="token punctuation">)</span>
coco_evaluator<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span><span class="token punctuation">)</span>
coco_evaluator<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span><span class="token punctuation">)</span>
coco_evaluator<span class="token punctuation">.</span>summarize<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">loading annotations into memory...
Done (t&#x3D;0.43s)
creating index...
index created!
Loading and preparing results...
DONE (t&#x3D;0.65s)
creating index...
index created!
Running per image evaluation...
Evaluate annotation type *bbox*
DONE (t&#x3D;21.15s).
Accumulating evaluation results...
DONE (t&#x3D;2.88s).
 Average Precision  (AP) @[ IoU&#x3D;0.50:0.95 | area&#x3D;   all | maxDets&#x3D;100 ] &#x3D; 0.233
 Average Precision  (AP) @[ IoU&#x3D;0.50      | area&#x3D;   all | maxDets&#x3D;100 ] &#x3D; 0.415
 Average Precision  (AP) @[ IoU&#x3D;0.75      | area&#x3D;   all | maxDets&#x3D;100 ] &#x3D; 0.233
 Average Precision  (AP) @[ IoU&#x3D;0.50:0.95 | area&#x3D; small | maxDets&#x3D;100 ] &#x3D; 0.104
 Average Precision  (AP) @[ IoU&#x3D;0.50:0.95 | area&#x3D;medium | maxDets&#x3D;100 ] &#x3D; 0.262
 Average Precision  (AP) @[ IoU&#x3D;0.50:0.95 | area&#x3D; large | maxDets&#x3D;100 ] &#x3D; 0.323
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D;   all | maxDets&#x3D;  1 ] &#x3D; 0.216
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D;   all | maxDets&#x3D; 10 ] &#x3D; 0.319
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D;   all | maxDets&#x3D;100 ] &#x3D; 0.327
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D; small | maxDets&#x3D;100 ] &#x3D; 0.145
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D;medium | maxDets&#x3D;100 ] &#x3D; 0.361
 Average Recall     (AR) @[ IoU&#x3D;0.50:0.95 | area&#x3D; large | maxDets&#x3D;100 ] &#x3D; 0.463<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://Unicorn-acc.github.io">Miraclo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://unicorn-acc.github.io/DeepLearning/dataset/MSCOCO/">http://unicorn-acc.github.io/DeepLearning/dataset/MSCOCO/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Unicorn-acc.github.io" target="_blank">Miraclo’s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DeepLearning/">DeepLearning</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Algorithm/LC-501-1000/LC-790/"><img class="prev-cover" src="https://w.wallhaven.cc/full/x6/wallhaven-x619o3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LC-790.多米诺和托米诺平铺</div></div></a></div><div class="next-post pull-right"><a href="/DeepLearning/dataset/PASCALVOC2010/"><img class="next-cover" src="https://w.wallhaven.cc/full/kx/wallhaven-kx3p1q.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">目标检测/分割_PASCAL VOC2012数据集与制作自己的数据集(VOC格式)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/DeepLearning/CAM/" title="CV可解释性分析_CAM热力图"><img class="cover" src="https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-03</div><div class="title">CV可解释性分析_CAM热力图</div></div></a></div><div><a href="/DeepLearning/Grad-CAM/" title="CV可解释性分析_Grad-CAM"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-03</div><div class="title">CV可解释性分析_Grad-CAM</div></div></a></div><div><a href="/DeepLearning/dataset/CIFAR10/" title="图像分类_CIFAR10数据集"><img class="cover" src="https://w.wallhaven.cc/full/d6/wallhaven-d65mzm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">图像分类_CIFAR10数据集</div></div></a></div><div><a href="/DeepLearning/dataset/Fashion-MNIST/" title="图像分类_Fashion-MNIST数据集(ResNet18进行迁移学习)"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-04</div><div class="title">图像分类_Fashion-MNIST数据集(ResNet18进行迁移学习)</div></div></a></div><div><a href="/DeepLearning/dataset/PASCALVOC2010/" title="目标检测&#x2F;分割_PASCAL VOC2012数据集与制作自己的数据集(VOC格式)"><img class="cover" src="https://w.wallhaven.cc/full/kx/wallhaven-kx3p1q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-11</div><div class="title">目标检测&#x2F;分割_PASCAL VOC2012数据集与制作自己的数据集(VOC格式)</div></div></a></div><div><a href="/DeepLearning/dataset/flower-photos/" title="图像分类_花分类数据集"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-06</div><div class="title">图像分类_花分类数据集</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80microsoft-coco%E6%95%B0%E6%8D%AE%E9%9B%86%E7%AE%80%E4%BB%8B"><span class="toc-text">一、Microsoft COCO数据集简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8Cms-coco%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%8B%E8%BD%BD%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B"><span class="toc-text">二、MS COCO数据集下载（目标检测）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89ms-coco%E6%A0%87%E6%B3%A8%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-text">三、MS COCO标注文件格式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8python%E7%9A%84json%E5%BA%93%E6%9F%A5%E7%9C%8B"><span class="toc-text">3.1 使用Python的json库查看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%98%E6%96%B9cocoapi%E6%9F%A5%E7%9C%8B"><span class="toc-text">3.2 使用官方cocoAPI查看</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%AF%8F%E5%BC%A0%E5%9B%BE%E7%89%87%E7%9A%84bbox%E4%BF%A1%E6%81%AF"><span class="toc-text">读取每张图片的bbox信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%AF%8F%E5%BC%A0%E5%9B%BE%E5%83%8F%E7%9A%84segmentation%E4%BF%A1%E6%81%AF"><span class="toc-text">读取每张图像的segmentation信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E4%BA%BA%E4%BD%93%E5%85%B3%E9%94%AE%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-text">读取人体关键点信息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E9%AA%8C%E8%AF%81%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%BB%BB%E5%8A%A1map"><span class="toc-text">四、验证目标检测任务mAP</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By Miraclo</div><div class="footer_custom_text">人只有在走上坡路的时候才会累和迷茫。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><link rel="stylesheet" href="/css/Lete.css"><script src="/js/custom.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/Java技术栈/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Java技术栈相关 (50)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/深度学习笔记/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 深度学习笔记相关 (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/深度学习笔记/网络模型/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 网络模型 (9)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/算法刷题记录/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">‍💻 算法刷题记录 (55)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">‍👓 数据库相关 (36)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="http://Unicorn-acc.github.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>
<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>硅谷权限系统-06-权限管理 | Miraclo</title><meta name="author" content="Miraclo"><meta name="copyright" content="Miraclo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="硅谷通用权限系统：权限管理 一、权限管理 1、权限管理介绍 每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：页面权限(菜单级)、操作权限（按钮级）、数据权限。当前系统只是讲解：菜单权限与按钮权限的控制。 1.1、菜单权限 菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访问，它是以整个"><meta property="og:type" content="article"><meta property="og:title" content="硅谷权限系统-06-权限管理"><meta property="og:url" content="http://unicorn-acc.github.io/posts/16785.html"><meta property="og:site_name" content="Miraclo"><meta property="og:description" content="硅谷通用权限系统：权限管理 一、权限管理 1、权限管理介绍 每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：页面权限(菜单级)、操作权限（按钮级）、数据权限。当前系统只是讲解：菜单权限与按钮权限的控制。 1.1、菜单权限 菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访问，它是以整个"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg"><meta property="article:published_time" content="2022-12-27T21:58:11.000Z"><meta property="article:modified_time" content="2023-03-29T14:53:52.954Z"><meta property="article:author" content="Miraclo"><meta property="article:tag" content="硅谷权限系统"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://unicorn-acc.github.io/posts/16785"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:2e3},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:800,languages:{author:"作者: Miraclo",link:"链接: ",source:"来源: Miraclo",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"硅谷权限系统-06-权限管理",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-03-29 14:53:52"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/mouth.css"><link rel="stylesheet" href="/css/codecolor.css"><link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/medium.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 6.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">153</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span></span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Miraclo</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-film"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span></span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">硅谷权限系统-06-权限管理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-12-27T21:58:11.000Z" title="发表于 2022-12-27 21:58:11">2022-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E7%A1%85%E8%B0%B7%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F/">硅谷权限系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="硅谷权限系统-06-权限管理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="硅谷通用权限系统权限管理">硅谷通用权限系统：权限管理</h1><h2 id="一权限管理">一、权限管理</h2><h3 id="权限管理介绍">1、权限管理介绍</h3><p>每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。不过不管是怎样的权限设计，大致可归为三种：<strong>页面权限(菜单级)、操作权限（按钮级）、数据权限</strong>。当前系统只是讲解：菜单权限与按钮权限的控制。</p><h4 id="菜单权限">1.1、菜单权限</h4><p>菜单权限就是对页面的控制，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访问，它是以整个页面为维度，对权限的控制并没有那么细，所以是一种<strong>粗颗粒权限</strong>。</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155717.png" alt="image-20220606155704023"><figcaption aria-hidden="true">image-20220606155704023</figcaption></figure><h4 id="按钮权限">1.2、按钮权限</h4><p>按钮权限就是将页面的<strong>操作</strong>视为资源，比如删除操作，有些人可以操作有些人不能操作。对于后端来说，操作就是一个接口。于前端来说，操作往往是一个按钮，是一种<strong>细颗粒权限</strong>。</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155718.png" alt="image-20220606160034229"><figcaption aria-hidden="true">image-20220606160034229</figcaption></figure><h4 id="权限管理设计思路">1.3、权限管理设计思路</h4><p>前面我们讲解了用户管理、角色管理及菜单管理，我们把菜单权限分配给角色，把角色分配给用户，那么用户就拥有了角色的所有权限（权限包含：菜单权限与按钮权限）。</p><p>接下来需要实现这两个接口：</p><p>1、用户登录</p><p>2、登录成功根据token获取用户相关信息（菜单权限及按钮权限数据等）</p><p>用户登录我们需要用到JWT，接下来讲解JWT。</p><h3 id="jwt">2、JWT</h3><h4 id="jwt介绍">2.1、JWT介绍</h4><p>JWT是JSON Web Token的缩写，即JSON Web令牌，是一种自包含令牌。 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。</p><p>JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上。</p><p>JWT最重要的作用就是对 token信息的防伪作用。</p><h4 id="jwt令牌的组成">2.2、JWT令牌的组成</h4><p>一个JWT由三个部分组成：<strong>JWT头、有效载荷、签名哈希</strong> 最后由这三者组合进行base64url编码得到JWT</p><p>典型的，一个JWT看起来如下图：该对象为一个很长的字符串，字符之间通过"."分隔符分为三个子串。 https://jwt.io/</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155719.png" alt="3402e929-2225-4c64-8f2e-4471b63366d0"><figcaption aria-hidden="true">3402e929-2225-4c64-8f2e-4471b63366d0</figcaption></figure><p><strong>JWT头</strong></p><p>JWT头部分是一个描述JWT元数据的JSON对象，通常如下所示。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>在上面的代码中，alg属性表示签名使用的算法，默认为HMAC SHA256（写为HS256）；</p><p>typ属性表示令牌的类型，JWT令牌统一写为JWT。</p><p>最后，使用Base64 URL算法将上述JSON对象转换为字符串保存。</p><p><strong>有效载荷</strong></p><p>有效载荷部分，是JWT的主体内容部分，也是一个JSON对象，包含需要传递的数据。 JWT指定七个默认字段供选择。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">iss<span class="hljs-punctuation">:</span> jwt签发者<br>sub<span class="hljs-punctuation">:</span> 主题<br>aud<span class="hljs-punctuation">:</span> 接收jwt的一方<br>exp<span class="hljs-punctuation">:</span> jwt的过期时间，这个过期时间必须要大于签发时间<br>nbf<span class="hljs-punctuation">:</span> 定义在什么时间之前，该jwt都是不可用的.<br>iat<span class="hljs-punctuation">:</span> jwt的签发时间<br>jti<span class="hljs-punctuation">:</span> jwt的唯一身份标识，主要用来作为一次性token<span class="hljs-punctuation">,</span>从而回避重放攻击。<br></code></pre></td></tr></table></figure><p>除以上默认字段外，我们还可以自定义私有字段，如下例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Helen&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;editor&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;avatar&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;helen.jpg&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>请注意，默认情况下JWT是未加密的，任何人都可以解读其内容，因此不要构建隐私信息字段，存放保密信息，以防止信息泄露。</p><p>JSON对象也使用Base64 URL算法转换为字符串保存。</p><p><strong>签名哈希</strong></p><p>签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。</p><p>首先，需要指定一个密码（secret）。该密码仅仅为保存在服务器中，并且不能向用户公开。然后，使用标头中指定的签名算法（默认情况下为HMAC SHA256）根据以下公式生成签名。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(claims), secret)    ==&gt;   签名hash<br></code></pre></td></tr></table></figure><p>在计算出签名哈希后，JWT头，有效载荷和签名哈希的三个部分组合成一个字符串，每个部分用"."分隔，就构成整个JWT对象。</p><p><strong>Base64URL算法</strong></p><p>如前所述，JWT头和有效载荷序列化的算法都用到了Base64URL。该算法和常见Base64算法类似，稍有差别。</p><p>作为令牌的JWT可以放在URL中（例如api.example/?token=xxx）。 Base64中用的三个字符是"+"，"/"和"="，由于在URL中有特殊含义，因此Base64URL中对他们做了替换："="去掉，"+"用"-"替换，"/"用"_"替换，这就是Base64URL算法。</p><h4 id="项目集成jwt">2.3、项目集成JWT</h4><p>操作模块：common-util</p><h5 id="引入依赖前面已经引入">2.3.1、 引入依赖（前面已经引入）</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="添加jwt帮助类">2.3.2、 添加JWT帮助类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.common.helper;<br><br><span class="hljs-keyword">import</span> io.jsonwebtoken.*;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 生成JSON Web令牌的工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtHelper</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">tokenExpiration</span> <span class="hljs-operator">=</span> <span class="hljs-number">365</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">tokenSignKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">(Long userId, String username)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> Jwts.builder()<br>                .setSubject(<span class="hljs-string">&quot;AUTH-USER&quot;</span>)<br>                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + tokenExpiration))<br>                .claim(<span class="hljs-string">&quot;userId&quot;</span>, userId)<br>                .claim(<span class="hljs-string">&quot;username&quot;</span>, username)<br>                .signWith(SignatureAlgorithm.HS512, tokenSignKey)<br>                .compressWith(CompressionCodecs.GZIP)<br>                .compact();<br>        <span class="hljs-keyword">return</span> token;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title function_">getUserId</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>            Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(tokenSignKey).parseClaimsJws(token);<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> claimsJws.getBody();<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (Integer) claims.get(<span class="hljs-string">&quot;userId&quot;</span>);<br>            <span class="hljs-keyword">return</span> userId.longValue();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (StringUtils.isEmpty(token)) <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>            Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(tokenSignKey).parseClaimsJws(token);<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> claimsJws.getBody();<br>            <span class="hljs-keyword">return</span> (String) claims.get(<span class="hljs-string">&quot;username&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeToken</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-comment">//jwttoken无需删除，客户端扔掉即可。</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtHelper.createToken(<span class="hljs-number">1L</span>, <span class="hljs-string">&quot;admin&quot;</span>);<span class="hljs-comment">//&quot;eyJhbGciOiJIUzUxMiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAAKtWKi5NUrJSCjAK0A0Ndg1S0lFKrShQsjI0MzY2sDQ3MTbQUSotTi3yTFGyMjKEsP0Sc1OBWp6unfB0f7NSLQDxzD8_QwAAAA.2eCJdsJXOYaWFmPTJc8gl1YHTRl9DAeEJprKZn4IgJP9Fzo5fLddOQn1Iv2C25qMpwHQkPIGukTQtskWsNrnhQ&quot;;//JwtHelper.createToken(7L, &quot;admin&quot;);</span><br>        System.out.println(token);<br>        System.out.println(JwtHelper.getUserId(token));<br>        System.out.println(JwtHelper.getUsername(token));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="用户登录">3、用户登录</h3><h4 id="修改登录方法">3.1、修改登录方法</h4><p>修改IndexController类登录方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SysUserService sysUserService;<br>    <br><span class="hljs-meta">@ApiOperation(value = &quot;登录&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginVo loginVo)</span> &#123;<br>    <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> sysUserService.getByUsername(loginVo.getUsername());<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == sysUser) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.ACCOUNT_ERROR);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!MD5.encrypt(loginVo.getPassword()).equals(sysUser.getPassword())) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.PASSWORD_ERROR);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(sysUser.getStatus().intValue() == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.ACCOUNT_STOP);<br>    &#125;<br><br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;token&quot;</span>, JwtHelper.createToken(sysUser.getId(), sysUser.getUsername()));<br>    <span class="hljs-keyword">return</span> Result.ok(map);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="添加service接口及实现">3.2、添加service接口及实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SysUser <span class="hljs-title function_">getByUsername</span><span class="hljs-params">(String username)</span>;<br></code></pre></td></tr></table></figure><p>接口实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> SysUser <span class="hljs-title function_">getByUsername</span><span class="hljs-params">(String username)</span> &#123;<br>   <span class="hljs-keyword">return</span> sysUserMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;SysUser&gt;().eq(<span class="hljs-string">&quot;username&quot;</span>,username));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取用户信息">4、获取用户信息</h3><p>接口数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;roles&quot;</span>,<span class="hljs-string">&quot;[admin]&quot;</span>);<br>map.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>);<br>map.put(<span class="hljs-string">&quot;avatar&quot;</span>,<span class="hljs-string">&quot;https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg&quot;</span>);<br>map.put(<span class="hljs-string">&quot;buttons&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());<br>map.put(<span class="hljs-string">&quot;routers&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());<br></code></pre></td></tr></table></figure><p>说明：主要是获取当前登录用户的菜单权限及按钮权限数据</p><h4 id="获取用户菜单权限">4.1、获取用户菜单权限</h4><p>说明：获取菜单权限数据，我们要将菜单数据构建成路由数据结构</p><h5 id="定义接口">4.1.1、定义接口</h5><p>SysMenuService类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取用户菜单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;RouterVo&gt; <span class="hljs-title function_">findUserMenuList</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure><h5 id="接口实现">4.1.2、接口实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;RouterVo&gt; <span class="hljs-title function_">findUserMenuList</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">//超级管理员admin账号id为：1</span><br>    List&lt;SysMenu&gt; sysMenuList = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (userId.longValue() == <span class="hljs-number">1</span>) &#123;<br>        sysMenuList = sysMenuMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;SysMenu&gt;().eq(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">1</span>).orderByAsc(<span class="hljs-string">&quot;sort_value&quot;</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        sysMenuList = sysMenuMapper.findListByUserId(userId);<br>    &#125;<br>    <span class="hljs-comment">//构建树形数据</span><br>    List&lt;SysMenu&gt; sysMenuTreeList = MenuHelper.buildTree(sysMenuList);<br><br>    <span class="hljs-comment">//构建路由</span><br>    List&lt;RouterVo&gt; routerVoList = RouterHelper.buildRouters(sysMenuTreeList);<br>    <span class="hljs-keyword">return</span> routerVoList;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="添加router帮助类">4.1.3、添加Router帮助类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.common.helper;<br><br><span class="hljs-keyword">import</span> com.atguigu.model.system.SysMenu;<br><span class="hljs-keyword">import</span> com.atguigu.model.vo.MetaVo;<br><span class="hljs-keyword">import</span> com.atguigu.model.vo.RouterVo;<br><span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *根据菜单数据构建路由的工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterHelper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据菜单构建路由</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> menus</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;RouterVo&gt; <span class="hljs-title function_">buildRouters</span><span class="hljs-params">(List&lt;SysMenu&gt; menus)</span> &#123;<br>        List&lt;RouterVo&gt; routers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;RouterVo&gt;();<br>        <span class="hljs-keyword">for</span> (SysMenu menu : menus) &#123;<br>            <span class="hljs-type">RouterVo</span> <span class="hljs-variable">router</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RouterVo</span>();<br>            router.setHidden(<span class="hljs-literal">false</span>);<br>            router.setAlwaysShow(<span class="hljs-literal">false</span>);<br>            router.setPath(getRouterPath(menu));<br>            router.setComponent(menu.getComponent());<br>            router.setMeta(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetaVo</span>(menu.getName(), menu.getIcon()));<br>            List&lt;SysMenu&gt; children = menu.getChildren();<br>            <span class="hljs-comment">//如果当前是菜单，需将按钮对应的路由加载出来，如：“角色授权”按钮对应的路由在“系统管理”下面</span><br>            <span class="hljs-keyword">if</span>(menu.getType().intValue() == <span class="hljs-number">1</span>) &#123;<br>                List&lt;SysMenu&gt; hiddenMenuList = children.stream().filter(item -&gt; !StringUtils.isEmpty(item.getComponent())).collect(Collectors.toList());<br>                <span class="hljs-keyword">for</span> (SysMenu hiddenMenu : hiddenMenuList) &#123;<br>                    <span class="hljs-type">RouterVo</span> <span class="hljs-variable">hiddenRouter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RouterVo</span>();<br>                    hiddenRouter.setHidden(<span class="hljs-literal">true</span>);<br>                    hiddenRouter.setAlwaysShow(<span class="hljs-literal">false</span>);<br>                    hiddenRouter.setPath(getRouterPath(hiddenMenu));<br>                    hiddenRouter.setComponent(hiddenMenu.getComponent());<br>                    hiddenRouter.setMeta(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetaVo</span>(hiddenMenu.getName(), hiddenMenu.getIcon()));<br>                    routers.add(hiddenRouter);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(children)) &#123;<br>                    <span class="hljs-keyword">if</span>(children.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                        router.setAlwaysShow(<span class="hljs-literal">true</span>);<br>                    &#125;<br>                    router.setChildren(buildRouters(children));<br>                &#125;<br>            &#125;<br>            routers.add(router);<br>        &#125;<br>        <span class="hljs-keyword">return</span> routers;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取路由地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> menu 菜单信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 路由地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRouterPath</span><span class="hljs-params">(SysMenu menu)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">routerPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span> + menu.getPath();<br>        <span class="hljs-keyword">if</span>(menu.getParentId().intValue() != <span class="hljs-number">0</span>) &#123;<br>            routerPath = menu.getPath();<br>        &#125;<br>        <span class="hljs-keyword">return</span> routerPath;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="添加mapper接口">4.1.4、添加mapper接口</h5><p>SysMenuMapper类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;SysMenu&gt; <span class="hljs-title function_">findListByUserId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span> Long userId)</span>;<br></code></pre></td></tr></table></figure><h5 id="添加xml方法">4.1.5、添加xml方法</h5><p>新建SysMenuMapper.xml文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;<br>&lt;!DOCTYPE mapper<br>        PUBLIC <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br>        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;<br><br><br>&lt;mapper namespace=<span class="hljs-string">&quot;com.atguigu.system.mapper.SysMenuMapper&quot;</span>&gt;<br><br>   &lt;resultMap id=<span class="hljs-string">&quot;sysMenuMap&quot;</span> type=<span class="hljs-string">&quot;com.atguigu.model.system.SysMenu&quot;</span> autoMapping=<span class="hljs-string">&quot;true&quot;</span>&gt;<br>   &lt;/resultMap&gt;<br><br>   &lt;!-- 用于select查询公用抽取的列 --&gt;<br>   &lt;sql id=<span class="hljs-string">&quot;columns&quot;</span>&gt;<br>      m.id,m.parent_id,m.name,m.type,m.path,m.component,m.perms,m.icon,m.sort_value,m.status,m.create_time,m.update_time,m.is_deleted<br>   &lt;/sql&gt;<br><br><br>    &lt;select id=<span class="hljs-string">&quot;findListByUserId&quot;</span> resultMap=<span class="hljs-string">&quot;sysMenuMap&quot;</span>&gt;<br>      select<br>      distinct &lt;include refid=<span class="hljs-string">&quot;columns&quot;</span> /&gt;<br>      from sys_menu m<br>      inner join sys_role_menu rm on rm.menu_id = m.id<br>      inner join sys_user_role ur on ur.role_id = rm.role_id<br>      where<br>      ur.user_id = #&#123;userId&#125;<br>      and m.status = <span class="hljs-number">1</span><br>      and rm.is_deleted = <span class="hljs-number">0</span><br>      and ur.is_deleted = <span class="hljs-number">0</span><br>      and m.is_deleted = <span class="hljs-number">0</span><br>   &lt;/select&gt;<br><br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure><h4 id="获取用户按钮权限">4.2、获取用户按钮权限</h4><p>说明：只需要获取按钮标识即可</p><h5 id="定义接口-1">4.1.1、定义接口</h5><p>SysMenuService类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取用户按钮权限</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;String&gt; <span class="hljs-title function_">findUserPermsList</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure><h5 id="接口实现-1">4.1.2、接口实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">findUserPermsList</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">//超级管理员admin账号id为：1</span><br>    List&lt;SysMenu&gt; sysMenuList = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (userId.longValue() == <span class="hljs-number">1</span>) &#123;<br>        sysMenuList = sysMenuMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;SysMenu&gt;().eq(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">1</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        sysMenuList = sysMenuMapper.findListByUserId(userId);<br>    &#125;<br>    <span class="hljs-comment">//创建返回的集合</span><br>    List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (SysMenu sysMenu : sysMenuList) &#123;<br>        <span class="hljs-keyword">if</span>(sysMenu.getType() == <span class="hljs-number">2</span>)&#123;<br>            permissionList.add(sysMenu.getPerms());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> permissionList;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改controller方法">4.3、修改Controller方法</h4><p>IndexController类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation(value = &quot;获取用户信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/info&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">info</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> JwtHelper.getUsername(request.getHeader(<span class="hljs-string">&quot;token&quot;</span>));<br>    Map&lt;String, Object&gt; map = sysUserService.getUserInfo(username);<br>    <span class="hljs-keyword">return</span> Result.ok(map);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="定义service接口">4.4、定义service接口</h4><p>SysUserService类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户名获取用户登录信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Map&lt;String, Object&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(String username)</span>;<br></code></pre></td></tr></table></figure><h4 id="service接口实现">4.5、service接口实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SysMenuService sysMenuService;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(String username)</span> &#123;<br>   Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>   <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getByUsername(username);<br><br>   <span class="hljs-comment">//根据用户id获取菜单权限值</span><br>   List&lt;RouterVo&gt; routerVoList = sysMenuService.findUserMenuList(sysUser.getId());<br>   <span class="hljs-comment">//根据用户id获取用户按钮权限</span><br>   List&lt;String&gt; permsList = sysMenuService.findUserPermsList(sysUser.getId());<br><br>   result.put(<span class="hljs-string">&quot;name&quot;</span>, sysUser.getName());<br>   result.put(<span class="hljs-string">&quot;avatar&quot;</span>, <span class="hljs-string">&quot;https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif&quot;</span>);<br>   <span class="hljs-comment">//当前权限控制使用不到，我们暂时忽略</span><br>   result.put(<span class="hljs-string">&quot;roles&quot;</span>,  <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;());<br>   result.put(<span class="hljs-string">&quot;buttons&quot;</span>, permsList);<br>   result.put(<span class="hljs-string">&quot;routers&quot;</span>, routerVoList);<br>   <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="前端对接">5、前端对接</h3><p>参考前端对接文档：《前端权限对接文档》</p><p>可直接引入前端项目完整代码</p><h3 id="总结">6、总结</h3><p>当前我们已经实现前端菜单及按钮的权限控制，服务器端还没加任何控制，那么服务器端怎么控制呢？其实很简单，就是要在页面按钮对应的controller方法上面加对应的权限控制，即在进入controller方法前判断当前用户是否有访问权限。</p><p>怎么实现呢？如果我们自己实现，那么肯定想到的就是Fillter加Aop就可以实现，有现成的开源技术框架吗？答案是肯定的，如：Spring Security、Shiro等一系列开源框架可供选择。</p><h2 id="二spring-security介绍">二、Spring Security介绍</h2><h3 id="spring-security简介">1、Spring Security简介</h3><p>Spring 是非常流行和成功的 Java 应用开发框架，Spring Security 正是 Spring 家族中的成员。Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案。</p><p>正如你可能知道的关于安全方面的两个核心功能是“<strong>认证</strong>”和“<strong>授权</strong>”，一般来说，Web 应用的安全性包括<strong>用户认证（Authentication）和用户授权（Authorization）</strong>两个部分，这两点也是 SpringSecurity 重要核心功能。</p><p>（1）用户认证指的是：验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程。</p><p><strong>通俗点说就是系统认为用户是否能登录</strong></p><p>（2）用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。</p><p><strong>通俗点讲就是系统判断用户是否有权限去做某些事情。</strong></p><h3 id="历史">2、历史</h3><p>“Spring Security 开始于 2003 年年底,““spring 的 acegi 安全系统”。 起因是 Spring开发者邮件列表中的一个问题,有人提问是否考虑提供一个基于 spring 的安全实现。</p><p>Spring Security 以“The Acegi Secutity System for Spring” 的名字始于 2013 年晚些时候。一个问题提交到 Spring 开发者的邮件列表，询问是否已经有考虑一个机遇 Spring 的安全性社区实现。那时候 Spring 的社区相对较小（相对现在）。实际上 Spring 自己在2013 年只是一个存在于 ScourseForge 的项目，这个问题的回答是一个值得研究的领域，虽然目前时间的缺乏组织了我们对它的探索。</p><p>考虑到这一点，一个简单的安全实现建成但是并没有发布。几周后，Spring 社区的其他成员询问了安全性，这次这个代码被发送给他们。其他几个请求也跟随而来。到 2014 年一月大约有 20 万人使用了这个代码。这些创业者的人提出一个 SourceForge 项目加入是为了，这是在 2004 三月正式成立。</p><p>在早些时候，这个项目没有任何自己的验证模块，身份验证过程依赖于容器管理的安全性和 Acegi 安全性。而不是专注于授权。开始的时候这很适合，但是越来越多的用户请求额外的容器支持。容器特定的认证领域接口的基本限制变得清晰。还有一个相关的问题增加新的容器的路径，这是最终用户的困惑和错误配置的常见问题。</p><p>Acegi 安全特定的认证服务介绍。大约一年后，Acegi 安全正式成为了 Spring 框架的子项目。1.0.0 最终版本是出版于 2006 -在超过两年半的大量生产的软件项目和数以百计的改进和积极利用社区的贡献。</p><p>Acegi 安全 2007 年底正式成为了 Spring 组合项目，更名为"Spring Security"。</p><h3 id="同款产品对比">3、同款产品对比</h3><h4 id="spring-security">3.1、Spring Security</h4><p>Spring 技术栈的组成部分。</p><p>https://spring.io/projects/spring-security</p><p>通过提供完整可扩展的认证和授权支持保护你的应用程序。</p><p><strong>SpringSecurity 特点：</strong></p><p>⚫ 和 Spring 无缝整合。</p><p>⚫ 全面的权限控制。</p><p>⚫ 专门为 Web 开发而设计。</p><p>​ ◼旧版本不能脱离 Web 环境使用。</p><p>​ ◼新版本对整个框架进行了分层抽取，分成了核心模块和 Web 模块。单独引入核心模块就可以脱离 Web 环境。</p><p>⚫ 重量级。</p><h4 id="shiro">3.2、 Shiro</h4><p>Apache 旗下的轻量级权限控制框架。</p><p><strong>特点：</strong></p><p>⚫ 轻量级。Shiro 主张的理念是把复杂的事情变简单。针对对性能有更高要求</p><p>的互联网应用有更好表现。</p><p>⚫ 通用性。</p><p>​ ◼好处：不局限于 Web 环境，可以脱离 Web 环境使用。</p><p>​ ◼缺陷：在 Web 环境下一些特定的需求需要手动编写代码定制。</p><p>Spring Security 是 Spring 家族中的一个安全管理框架，实际上，在 Spring Boot 出现之前，Spring Security 就已经发展了多年了，但是使用的并不多，安全管理这个领域，一直是 Shiro 的天下。</p><p>相对于 Shiro，在 SSM 中整合 Spring Security 都是比较麻烦的操作，所以，Spring Security 虽然功能比 Shiro 强大，但是使用反而没有 Shiro 多（Shiro 虽然功能没有Spring Security 多，但是对于大部分项目而言，Shiro 也够用了）。</p><p>自从有了 Spring Boot 之后，Spring Boot 对于 Spring Security 提供了自动化配置方案，可以使用更少的配置来使用 Spring Security。</p><p>因此，一般来说，常见的安全管理技术栈的组合是这样的：</p><p>• SSM + Shiro</p><p>• Spring Boot/Spring Cloud + Spring Security</p><p><strong>以上只是一个推荐的组合而已，如果单纯从技术上来说，无论怎么组合，都是可以运行的</strong></p><h2 id="三spring-security实现权限">三、Spring Security实现权限</h2><p>要对Web资源进行保护，最好的办法莫过于Filter 要想对方法调用进行保护，最好的办法莫过于<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020">AOP</a>。</p><p>Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/20201231155747261.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><p>如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。进过一系列拦截最终访问到我们的API。</p><p>这里面我们只需要重点关注两个过滤器即可：<code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<code>FilterSecurityInterceptor</code>负责权限授权。</p><p>说明：<strong>Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p><h3 id="spring-security入门">1、Spring Security入门</h3><p>我们在现有的项目基础上做集成，Spring Security权限控制部分也是公共模块，后续哪个service服务模块需要，直接引入即可。</p><p>后续我们的Spring Cloud微服务项目可能就基于该权限系统开发，因此我们要做好技术扩展。</p><h4 id="创建spring-security模块">1.1、创建spring-security模块</h4><p>在common模块下创建spring-security公共模块，创建方式如：service-util模块</p><h4 id="添加依赖">1.2、添加依赖</h4><p>修改pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-util<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Spring Security依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided <span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>说明：依赖包（spring-boot-starter-security）导入后，Spring Security就默认提供了许多功能将整个应用给保护了起来：</p><p>​ 1、要求经过身份验证的用户才能与应用程序进行交互</p><p>​ 2、创建好了默认登录表单</p><p>​ 3、生成用户名为<code>user</code>的随机密码并打印在控制台上</p><p>​ 4、<code>CSRF</code>攻击防护、<code>Session Fixation</code>攻击防护</p><p>​ 5、等等等等......</p><h4 id="添加配置类">1.3、添加配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span> <span class="hljs-comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="service-system模块引入">1.4、service-system模块引入</h4><p>在service-system引入权限模块，将依赖添加到pom.mxl文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="启动项目测试">1.5、启动项目测试</h4><p>在浏览器访问：http://localhost:8800/admin/system/sysRole/findAll</p><p>自动跳转到了登录页面</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155720.png" alt="image-20220606095319741"><figcaption aria-hidden="true">image-20220606095319741</figcaption></figure><p>默认的用户名：user</p><p>密码在项目启动的时候在控制台会打印，<strong>注意每次启动的时候密码都会发生变化！</strong></p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155722.png" alt="image-20220607103826495"><figcaption aria-hidden="true">image-20220607103826495</figcaption></figure><p>输入用户名，密码，成功访问到controller方法并返回数据，说明Spring Security默认安全保护生效。</p><p>在实际开发中，这些默认的配置是不能满足我们需要的，我们需要扩展Spring Security组件，完成自定义配置，实现我们的项目需求。</p><h3 id="用户认证">2、用户认证</h3><p>用户认证流程：</p><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155723.png" alt="image-20220620115942257"><figcaption aria-hidden="true">image-20220620115942257</figcaption></figure><h4 id="用户认证核心组件">2.1、用户认证核心组件</h4><p>我们系统中会有许多用户，确认当前是哪个用户正在使用我们系统就是登录认证的最终目的。这里我们就提取出了一个核心概念：<strong>当前登录用户/当前认证用户</strong>。整个系统安全都是围绕当前登录用户展开的，这个不难理解，要是当前登录用户都不能确认了，那A下了一个订单，下到了B的账户上这不就乱套了。这一概念在Spring Security中的体现就是 <strong><code>Authentication</code></strong>，它存储了认证信息，代表当前登录用户。</p><p>我们在程序中如何获取并使用它呢？我们需要通过 <strong><code>SecurityContext</code></strong> 来获取<code>Authentication</code>，<code>SecurityContext</code>就是我们的上下文对象！这个上下文对象则是交由 <strong><code>SecurityContextHolder</code></strong> 进行管理，你可以在程序<strong>任何地方</strong>使用它：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();<br></code></pre></td></tr></table></figure><p><code>SecurityContextHolder</code>原理非常简单，就是使用<code>ThreadLocal</code>来保证一个线程中传递同一个对象！</p><p><strong>现在我们已经知道了Spring Security中三个核心组件：</strong></p><p>​ 1、<code>Authentication</code>：存储了认证信息，代表当前登录用户</p><p>​ 2、<code>SeucirtyContext</code>：上下文对象，用来获取<code>Authentication</code></p><p>​ 3、<code>SecurityContextHolder</code>：上下文管理对象，用来在程序任何地方获取<code>SecurityContext</code></p><p><strong><code>Authentication</code>中是什么信息呢：</strong></p><p>​ 1、<code>Principal</code>：用户信息，没有认证时一般是用户名，认证后一般是用户对象</p><p>​ 2、<code>Credentials</code>：用户凭证，一般是密码</p><p>​ 3、<code>Authorities</code>：用户权限</p><h4 id="用户认证-1">2.2、用户认证</h4><p>Spring Security是怎么进行用户认证的呢？</p><p><strong><code>AuthenticationManager</code></strong> 就是Spring Security用于执行身份验证的组件，只需要调用它的<code>authenticate</code>方法即可完成认证。Spring Security默认的认证方式就是在<code>UsernamePasswordAuthenticationFilter</code>这个过滤器中进行认证的，该过滤器负责认证逻辑。</p><p>Spring Security用户认证关键代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 生成一个包含账号密码的认证信息</span><br><span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, passwrod);<br><span class="hljs-comment">// AuthenticationManager校验这个认证信息，返回一个已认证的Authentication</span><br><span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> authenticationManager.authenticate(authenticationToken);<br><span class="hljs-comment">// 将返回的Authentication存到上下文中</span><br>SecurityContextHolder.getContext().setAuthentication(authentication);<br></code></pre></td></tr></table></figure><p>下面我们来分析一下。</p><h5 id="认证接口分析">2.2.1、认证接口分析</h5><p><code>AuthenticationManager</code>的校验逻辑非常简单：</p><p>根据用户名先查询出用户对象(没有查到则抛出异常)将用户对象的密码和传递过来的密码进行校验，密码不匹配则抛出异常。</p><p>这个逻辑没啥好说的，再简单不过了。重点是这里每一个步骤Spring Security都提供了组件：</p><p>​ 1、是谁执行 <strong>根据用户名查询出用户对象</strong> 逻辑的呢？用户对象数据可以存在内存中、文件中、数据库中，你得确定好怎么查才行。这一部分就是交由<strong><code>UserDetialsService</code></strong> 处理，该接口只有一个方法<code>loadUserByUsername(String username)</code>，通过用户名查询用户对象，默认实现是在内存中查询。</p><p>​ 2、那查询出来的 <strong>用户对象</strong> 又是什么呢？每个系统中的用户对象数据都不尽相同，咱们需要确认我们的用户数据是啥样的才行。Spring Security中的用户数据则是由<strong><code>UserDetails</code></strong> 来体现，该接口中提供了账号、密码等通用属性。</p><p>​ 3、<strong>对密码进行校验</strong>大家可能会觉得比较简单，<code>if、else</code>搞定，就没必要用什么组件了吧？但框架毕竟是框架考虑的比较周全，除了<code>if、else</code>外还解决了密码加密的问题，这个组件就是<strong><code>PasswordEncoder</code></strong>，负责密码加密与校验。</p><p>我们可以看下<code>AuthenticationManager</code>校验逻辑的大概源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>...省略其他代码<br><br>    <span class="hljs-comment">// 传递过来的用户名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authentication.getName();<br>    <span class="hljs-comment">// 调用UserDetailService的方法，通过用户名查询出用户对象UserDetail（查询不出来UserDetailService则会抛出异常）</span><br>    <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">presentedPassword</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();<br><br>    <span class="hljs-comment">// 传递过来的密码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();<br>    <span class="hljs-comment">// 使用密码解析器PasswordEncoder传递过来的密码是否和真实的用户密码匹配</span><br>    <span class="hljs-keyword">if</span> (!passwordEncoder.matches(password, userDetails.getPassword())) &#123;<br>        <span class="hljs-comment">// 密码错误则抛出异常</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-string">&quot;错误信息...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 注意哦，这里返回的已认证Authentication，是将整个UserDetails放进去充当Principal</span><br>    <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(userDetails,<br>            authentication.getCredentials(), userDetails.getAuthorities());<br>    <span class="hljs-keyword">return</span> result;<br><br>...省略其他代码<br>&#125;<br></code></pre></td></tr></table></figure><p><code>UserDetialsService</code>、<code>UserDetails</code>、<code>PasswordEncoder</code>，这三个组件Spring Security都有默认实现，这一般是满足不了我们的实际需求的，所以这里我们自己来实现这些组件！</p><p>下面我们就在项目里面来实现用户认证。</p><h5 id="加密器passwordencoder">2.2.3、加密器PasswordEncoder</h5><p>加密我们项目采取MD5加密</p><p>操作模块：spring-security模块</p><p><strong>自定义加密处理组件：CustomMd5PasswordEncoder</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.custom;<br><br><span class="hljs-keyword">import</span> com.atguigu.common.util.MD5;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 密码处理</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMd5PasswordEncoder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> MD5.encrypt(rawPassword.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> encodedPassword.equals(MD5.encrypt(rawPassword.toString()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="用户对象userdetails">2.2.4、用户对象UserDetails</h5><p>该接口就是我们所说的用户对象，它提供了用户的一些通用属性，源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户权限集合（这个权限对象现在不管它，到权限时我会讲解）</span><br><span class="hljs-comment">     */</span><br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户密码</span><br><span class="hljs-comment">     */</span><br>    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户名</span><br><span class="hljs-comment">     */</span><br>    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户没过期返回true，反之则false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户没锁定返回true，反之则false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户凭据(通常为密码)没过期返回true，反之则false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户是启用状态返回true，反之则false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>实际开发中我们的用户属性各种各样，这些默认属性可能是满足不了，所以我们一般会自己实现该接口，然后设置好我们实际的用户实体对象。实现此接口要重写很多方法比较麻烦，我们可以继承Spring Security提供的<code>org.springframework.security.core.userdetails.User</code>类，该类实现了<code>UserDetails</code>接口帮我们省去了重写方法的工作：</p><p>操作模块：spring-security模块</p><p><strong>添加CustomUser对象</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.custom;<br><br><span class="hljs-keyword">import</span> com.atguigu.model.system.SysUser;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<br><br><span class="hljs-keyword">import</span> java.util.Collection;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 我们自己的用户实体对象，要调取用户信息时直接获取这个实体对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> SysUser sysUser;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomUser</span><span class="hljs-params">(SysUser sysUser, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;<br>        <span class="hljs-built_in">super</span>(sysUser.getUsername(), sysUser.getPassword(), authorities);<br>        <span class="hljs-built_in">this</span>.sysUser = sysUser;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> SysUser <span class="hljs-title function_">getSysUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sysUser;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSysUser</span><span class="hljs-params">(SysUser sysUser)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sysUser = sysUser;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h5 id="业务对象userdetailsservice">2.2.5 业务对象UserDetailsService</h5><p>该接口很简单只有一个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据用户名获取用户对象（获取不到直接抛异常）</span><br><span class="hljs-comment">     */</span><br>    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们实现该接口，就完成了自己的业务</p><p><strong>操作模块：service-system</strong></p><p><strong>添加UserDetailsServiceImpl类，实现UserDetailsService接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.service.impl;<br><br><span class="hljs-keyword">import</span> com.atguigu.common.execption.GuiguException;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.ResultCodeEnum;<br><span class="hljs-keyword">import</span> com.atguigu.model.system.SysUser;<br><span class="hljs-keyword">import</span> com.atguigu.security.custom.CustomUser;<br><span class="hljs-keyword">import</span> com.atguigu.system.service.SysUserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Collections;<br><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SysUserService sysUserService;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> sysUserService.getByUsername(username);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == sysUser) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户名不存在！&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(sysUser.getStatus().intValue() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号已停用&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUser</span>(sysUser, Collections.emptyList());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>AuthenticationManager</code>校验所调用的三个组件我们就已经做好实现了！</p><h5 id="自定义用户认证接口">2.2.6、自定义用户认证接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.fillter;<br><br><br><span class="hljs-keyword">import</span> com.atguigu.common.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.ResultCodeEnum;<br><span class="hljs-keyword">import</span> com.atguigu.common.util.ResponseUtil;<br><span class="hljs-keyword">import</span> com.atguigu.security.custom.CustomUser;<br><span class="hljs-keyword">import</span> com.atguigu.vo.system.LoginVo;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<br><span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;<br><span class="hljs-keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;<br><br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 登录过滤器，继承UsernamePasswordAuthenticationFilter，对用户名密码进行登录校验</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenLoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TokenLoginFilter</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setAuthenticationManager(authenticationManager);<br>        <span class="hljs-built_in">this</span>.setPostOnly(<span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//指定登录接口及提交方式，可以指定任意路径</span><br>        <span class="hljs-built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/admin/system/index/login&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> res</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse res)</span><br>            <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">LoginVo</span> <span class="hljs-variable">loginVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(req.getInputStream(), LoginVo.class);<br><br>            <span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(loginVo.getUsername(), loginVo.getPassword());<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authenticationToken);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录成功</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chain</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> auth</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">successfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span><br><span class="hljs-params">                                            Authentication auth)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">CustomUser</span> <span class="hljs-variable">customUser</span> <span class="hljs-operator">=</span> (CustomUser) auth.getPrincipal();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtHelper.createToken(customUser.getSysUser().getId(), customUser.getSysUser().getUsername());<br><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;token&quot;</span>, token);<br>        ResponseUtil.out(response, Result.ok(map));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unsuccessfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">                                              AuthenticationException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <br>        <span class="hljs-keyword">if</span>(e.getCause() <span class="hljs-keyword">instanceof</span> RuntimeException) &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, <span class="hljs-number">204</span>, e.getMessage()));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, ResultCodeEnum.LOGIN_MOBLE_ERROR));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加工具类：ResponseUtil</p><p>添加模块：common-util</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.common.util;<br><br><span class="hljs-keyword">import</span> com.atguigu.common.result.Result;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">out</span><span class="hljs-params">(HttpServletResponse response, Result r)</span> &#123;<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        response.setStatus(HttpStatus.OK.value());<br>        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);<br>        <span class="hljs-keyword">try</span> &#123;<br>            mapper.writeValue(response.getWriter(), r);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="认证解析token">2.2.7、认证解析token</h5><p>因为用户登录状态在token中存储在客户端，所以每次请求接口请求头携带token， 后台通过自定义token过滤器拦截解析token完成认证并填充用户信息实体。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.fillter;<br><br><br><span class="hljs-keyword">import</span> com.atguigu.common.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.ResultCodeEnum;<br><span class="hljs-keyword">import</span> com.atguigu.common.util.ResponseUtil;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<br><br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 认证解析token过滤器</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TokenAuthenticationFilter</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>            <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        logger.info(<span class="hljs-string">&quot;uri:&quot;</span>+request.getRequestURI());<br>        <span class="hljs-comment">//如果是登录接口，直接放行</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;/admin/system/index/login&quot;</span>.equals(request.getRequestURI())) &#123;<br>            chain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> getAuthentication(request);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != authentication) &#123;<br>            SecurityContextHolder.getContext().setAuthentication(authentication);<br>            chain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, ResultCodeEnum.PERMISSION));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> UsernamePasswordAuthenticationToken <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-comment">// token置于header里</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        logger.info(<span class="hljs-string">&quot;token:&quot;</span>+token);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(token)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">useruame</span> <span class="hljs-operator">=</span> JwtHelper.getUsername(token);<br>            logger.info(<span class="hljs-string">&quot;useruame:&quot;</span>+useruame);<br>            <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(useruame)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(useruame, <span class="hljs-literal">null</span>, Collections.emptyList());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="配置用户认证">2.2.8、配置用户认证</h5><p>修改WebSecurityConfig配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.security.config;<br><br><span class="hljs-keyword">import</span> com.atguigu.security.custom.CustomAuthenticationEntryPoint;<br><span class="hljs-keyword">import</span> com.atguigu.security.custom.CustomMd5PasswordEncoder;<br><span class="hljs-keyword">import</span> com.atguigu.security.fillter.TokenLoginFilter;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<br><span class="hljs-keyword">import</span> org.springframework.web.cors.CorsUtils;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span> <span class="hljs-comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomMd5PasswordEncoder customMd5PasswordEncoder;<br>    <br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationManager <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManager();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 这是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span><br>        http<br>                <span class="hljs-comment">//关闭csrf</span><br>                .csrf().disable()<br>                <span class="hljs-comment">// 开启跨域以便前端调用接口</span><br>                .cors().and()<br>                .authorizeRequests()<br>                <span class="hljs-comment">// 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span><br>                .antMatchers(<span class="hljs-string">&quot;/admin/system/index/login&quot;</span>).permitAll()<br>                <span class="hljs-comment">// 这里意思是其它所有接口需要认证才能访问</span><br>                .anyRequest().authenticated()<br>                .and()<br>                <span class="hljs-comment">//TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span><br>                .addFilterBefore(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenAuthenticationFilter</span>(), UsernamePasswordAuthenticationFilter.class)<br>                .addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenLoginFilter</span>(authenticationManager()));<br><br>    	<span class="hljs-comment">//禁用session</span><br>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 指定UserDetailService和加密器</span><br>        auth.userDetailsService(userDetailsService).passwordEncoder(customMd5PasswordEncoder);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 配置哪些请求不拦截</span><br><span class="hljs-comment">     * 排除swagger相关请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> web</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/favicon.ico&quot;</span>,<span class="hljs-string">&quot;/swagger-resources/**&quot;</span>, <span class="hljs-string">&quot;/webjars/**&quot;</span>, <span class="hljs-string">&quot;/v2/**&quot;</span>, <span class="hljs-string">&quot;/swagger-ui.html/**&quot;</span>, <span class="hljs-string">&quot;/doc.html&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>说明：</strong></p><p><strong>1、我们是前后端分离项目，使用<code>jwt</code>生成token ，即用户状态保存在客户端中，前后端交互通过api接口 <code>无session</code>生成，所以我们不需要配置<code>formLogin</code>，session禁用</strong></p><p><strong>2、在浏览器访问：http://localhost:8800/admin/system/sysRole/findAll</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&#123;<br>    &quot;code&quot;: 209,<br>    &quot;message&quot;: &quot;没有权限&quot;,<br>    &quot;data&quot;: null<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="通过swagger测试登录">2.2.9、通过swagger测试登录</h5><p>http://localhost:8800/doc.html</p><p>在相应的自定义组件设置断点，查看是否按照预期执行。</p><p>1、先输入正确的用户名与密码</p><p>2、输入错误的用户名与密码</p><p>结论：跟预期一致</p><h3 id="用户授权">3、用户授权</h3><p>在SpringSecurity中，会使用默认的FilterSecurityInterceptor来进行权限校验。在FilterSecurityInterceptor中会从SecurityContextHolder获取其中的<strong>Authentication</strong>，然后获取其中的权限信息。判断当前用户是否拥有访问当前资源所需的权限。</p><p><strong>SpringSecurity中的Authentication类：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable &#123;<br>	<span class="hljs-comment">//权限数据列表</span><br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<br><br>    Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;<br><br>    Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;<br>&#125;<br></code></pre></td></tr></table></figure><p>前面登录时执行loadUserByUsername方法时，return new CustomUser(sysUser, Collections.emptyList());后面的空数据对接就是返回给Spring Security的权限数据。</p><p>在TokenAuthenticationFilter中怎么获取权限数据呢？登录时我们把权限数据保存到redis中（用户名为key，权限数据为value即可），这样通过token获取用户名即可拿到权限数据，这样就可构成出完整的Authentication对象。</p><h4 id="修改loaduserbyusername接口方法">3.1、修改loadUserByUsername接口方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SysMenuService sysMenuService;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>    <span class="hljs-type">SysUser</span> <span class="hljs-variable">sysUser</span> <span class="hljs-operator">=</span> sysUserService.getByUsername(username);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == sysUser) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户名不存在！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(sysUser.getStatus().intValue() == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号已停用&quot;</span>);<br>    &#125;<br>    List&lt;String&gt; userPermsList = sysMenuService.findUserPermsList(sysUser.getId());<br>    List&lt;SimpleGrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (String perm : userPermsList) &#123;<br>        authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(perm.trim()));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomUser</span>(sysUser, authorities);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="spring-security模块配置redis">3.2、spring-security模块配置redis</h4><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="修改tokenloginfilter登录成功方法">3.3、修改TokenLoginFilter登录成功方法</h4><p>登录成功我们将权限数据保存到reids</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenLoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TokenLoginFilter</span><span class="hljs-params">(AuthenticationManager authenticationManager, RedisTemplate redisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setAuthenticationManager(authenticationManager);<br>        <span class="hljs-built_in">this</span>.setPostOnly(<span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//指定登录接口及提交方式，可以指定任意路径</span><br>        <span class="hljs-built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/admin/system/index/login&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>));<br>        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> req</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> res</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse res)</span><br>            <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">LoginVo</span> <span class="hljs-variable">loginVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(req.getInputStream(), LoginVo.class);<br><br>            <span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(loginVo.getUsername(), loginVo.getPassword());<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authenticationToken);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录成功</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chain</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> auth</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">successfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span><br><span class="hljs-params">                                            Authentication auth)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">CustomUser</span> <span class="hljs-variable">customUser</span> <span class="hljs-operator">=</span> (CustomUser) auth.getPrincipal();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtHelper.createToken(customUser.getSysUser().getId(), customUser.getSysUser().getUsername());<br>        <span class="hljs-comment">//保存权限数据</span><br>        redisTemplate.opsForValue().set(customUser.getUsername(), JSON.toJSONString(customUser.getAuthorities()));<br><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;token&quot;</span>, token);<br>        ResponseUtil.out(response, Result.ok(map));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 登录失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ServletException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unsuccessfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params">                                              AuthenticationException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <br>        <span class="hljs-keyword">if</span>(e.getCause() <span class="hljs-keyword">instanceof</span> RuntimeException) &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, <span class="hljs-number">204</span>, e.getMessage()));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, ResultCodeEnum.LOGIN_MOBLE_ERROR));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改tokenauthenticationfilter">3.4、修改TokenAuthenticationFilter</h4><p>认证是redis里面获取权限数据</p><p>完整代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.fillter;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.atguigu.common.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.common.result.ResultCodeEnum;<br><span class="hljs-keyword">import</span> com.atguigu.common.util.ResponseUtil;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br><span class="hljs-keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;<br><span class="hljs-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<br><br><span class="hljs-keyword">import</span> javax.servlet.FilterChain;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 认证解析token过滤器</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TokenAuthenticationFilter</span><span class="hljs-params">(RedisTemplate redisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br>            <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        logger.info(<span class="hljs-string">&quot;uri:&quot;</span>+request.getRequestURI());<br>        <span class="hljs-comment">//如果是登录接口，直接放行</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;/admin/system/index/login&quot;</span>.equals(request.getRequestURI())) &#123;<br>            chain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> getAuthentication(request);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != authentication) &#123;<br>            SecurityContextHolder.getContext().setAuthentication(authentication);<br>            chain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ResponseUtil.out(response, Result.build(<span class="hljs-literal">null</span>, ResultCodeEnum.PERMISSION));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> UsernamePasswordAuthenticationToken <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-comment">// token置于header里</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        logger.info(<span class="hljs-string">&quot;token:&quot;</span>+token);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(token)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">useruame</span> <span class="hljs-operator">=</span> JwtHelper.getUsername(token);<br>            logger.info(<span class="hljs-string">&quot;useruame:&quot;</span>+useruame);<br>            <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(useruame)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">authoritiesString</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(useruame);<br>                List&lt;Map&gt; mapList = JSON.parseArray(authoritiesString, Map.class);<br>                List&lt;SimpleGrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-keyword">for</span> (Map map : mapList) &#123;<br>                    authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>((String)map.get(<span class="hljs-string">&quot;authority&quot;</span>)));<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(useruame, <span class="hljs-literal">null</span>, authorities);<br>                <span class="hljs-comment">//return new UsernamePasswordAuthenticationToken(useruame, null, Collections.emptyList());</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改配置类">3.5、修改配置类</h4><p>修改WebSecurityConfig类</p><p>配置类添加注解：</p><p>开启基于方法的安全认证机制，也就是说在web层的controller启用注解机制的安全确认</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br></code></pre></td></tr></table></figure><p>添加注入bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br></code></pre></td></tr></table></figure><p>添加参数：</p><p>两个fillter添加redisTemplate参数</p><p><strong>完整代码如下：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.system.config;<br><br><span class="hljs-keyword">import</span> com.atguigu.security.custom.CustomMd5PasswordEncoder;<br><span class="hljs-keyword">import</span> com.atguigu.security.fillter.TokenAuthenticationFilter;<br><span class="hljs-keyword">import</span> com.atguigu.security.fillter.TokenLoginFilter;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<br><span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span> <span class="hljs-comment">//@EnableWebSecurity是开启SpringSecurity的默认行为</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><span class="hljs-comment">//开启注解功能，默认禁用注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CustomMd5PasswordEncoder customMd5PasswordEncoder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationManager <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManager();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 这是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span><br>        http<br>                <span class="hljs-comment">//关闭csrf</span><br>                .csrf().disable()<br>                <span class="hljs-comment">// 开启跨域以便前端调用接口</span><br>                .cors().and()<br>                .authorizeRequests()<br>                <span class="hljs-comment">// 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span><br>                <span class="hljs-comment">//.antMatchers(&quot;/admin/system/index/login&quot;).permitAll()</span><br>                <span class="hljs-comment">// 这里意思是其它所有接口需要认证才能访问</span><br>                .anyRequest().authenticated()<br>                .and()<br>                <span class="hljs-comment">//TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span><br>                .addFilterBefore(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenAuthenticationFilter</span>(redisTemplate), UsernamePasswordAuthenticationFilter.class)<br>                .addFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenLoginFilter</span>(authenticationManager(), redisTemplate));<br><br>        <span class="hljs-comment">//禁用session</span><br>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 指定UserDetailService和加密器</span><br>        auth.userDetailsService(userDetailsService).passwordEncoder(customMd5PasswordEncoder);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 配置哪些请求不拦截</span><br><span class="hljs-comment">     * 排除swagger相关请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> web</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/favicon.ico&quot;</span>,<span class="hljs-string">&quot;/swagger-resources/**&quot;</span>, <span class="hljs-string">&quot;/webjars/**&quot;</span>, <span class="hljs-string">&quot;/v2/**&quot;</span>, <span class="hljs-string">&quot;/swagger-ui.html/**&quot;</span>, <span class="hljs-string">&quot;/doc.html&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="service-system模块添加redis配置">3.6、service-system模块添加redis配置</h4><p>application-dev.yml配文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.6</span><span class="hljs-number">.100</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800000</span><br>    <span class="hljs-attr">password:</span><br>    <span class="hljs-attr">jedis:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span> <span class="hljs-comment">#最大连接数</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">-1</span>    <span class="hljs-comment">#最大阻塞等待时间(负数表示没限制)</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span>    <span class="hljs-comment">#最大空闲</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span>     <span class="hljs-comment">#最小空闲</span><br></code></pre></td></tr></table></figure><h4 id="控制controller层接口权限">3.7、控制controller层接口权限</h4><p><strong>Spring Security默认是禁用注解的，要想开启注解，需要在继承WebSecurityConfigurerAdapter的类上加@EnableGlobalMethodSecurity注解，来判断用户对某个控制层的方法是否具有访问权限</strong></p><p>通过@PreAuthorize标签控制controller层接口权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysRoleController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SysRoleService sysRoleService;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.list&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;获取分页列表&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;page&#125;/&#123;limit&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">index</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@ApiParam(name = &quot;page&quot;, value = &quot;当前页码&quot;, required = true)</span></span><br><span class="hljs-params">            <span class="hljs-meta">@PathVariable</span> Long page,</span><br><span class="hljs-params"></span><br><span class="hljs-params">            <span class="hljs-meta">@ApiParam(name = &quot;limit&quot;, value = &quot;每页记录数&quot;, required = true)</span></span><br><span class="hljs-params">            <span class="hljs-meta">@PathVariable</span> Long limit,</span><br><span class="hljs-params"></span><br><span class="hljs-params">            <span class="hljs-meta">@ApiParam(name = &quot;roleQueryVo&quot;, value = &quot;查询对象&quot;, required = false)</span></span><br><span class="hljs-params">                    SysRoleQueryVo roleQueryVo)</span> &#123;<br>        Page&lt;SysRole&gt; pageParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(page, limit);<br>        IPage&lt;SysRole&gt; pageModel = sysRoleService.selectPage(pageParam, roleQueryVo);<br>        <span class="hljs-keyword">return</span> Result.ok(pageModel);<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.list&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;获取&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-type">SysRole</span> <span class="hljs-variable">role</span> <span class="hljs-operator">=</span> sysRoleService.getById(id);<br>        <span class="hljs-keyword">return</span> Result.ok(role);<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.add&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;新增角色&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/save&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated</span> SysRole role)</span> &#123;<br>        sysRoleService.save(role);<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.update&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;修改角色&quot;)</span><br>    <span class="hljs-meta">@PutMapping(&quot;/update&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">updateById</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SysRole role)</span> &#123;<br>        sysRoleService.updateById(role);<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.remove&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;删除角色&quot;)</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/remove/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        sysRoleService.removeById(id);<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br><br>    <span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;bnt.sysRole.remove&#x27;)&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;根据id列表删除&quot;)</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/batchRemove&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">batchRemove</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;Long&gt; idList)</span> &#123;<br>        sysRoleService.removeByIds(idList);<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试服务器端权限">3.8、测试服务器端权限</h4><p>登录后台，分配权限进行测试，页面如果添加了按钮权限控制，可临时去除方便测试</p><p>测试结论：</p><p>​ 1、分配了权限的能够成功返回接口数据</p><p>​ 2、没有分配权限的会抛出异常：org.springframework.security.access.AccessDeniedException: 不允许访问</p><h4 id="异常处理">3.9、异常处理</h4><p>异常处理有2种方式：</p><p>​ 1、扩展Spring Security异常处理类：AccessDeniedHandler、AuthenticationEntryPoint</p><p>​ 2、在spring boot全局异常统一处理</p><p><strong>第一种方案说明：如果系统实现了全局异常处理，那么全局异常首先会获取AccessDeniedException异常，要想Spring Security扩展异常生效，必须在全局异常再次抛出该异常。</strong></p><p><strong>第二种方案最简单，我们使用第二种方案，第一种方案自行研究。</strong></p><p><strong>全局异常添加处理</strong></p><p>操作模块：service-util</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * spring security异常</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> e</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ExceptionHandler(AccessDeniedException.class)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">error</span><span class="hljs-params">(AccessDeniedException e)</span> <span class="hljs-keyword">throws</span> AccessDeniedException &#123;<br>    <span class="hljs-keyword">return</span> Result.build(<span class="hljs-literal">null</span>, ResultCodeEnum.PERMISSION);<br>&#125;<br></code></pre></td></tr></table></figure><p>AccessDeniedException需要引入依赖，Spring Security对应的异常</p><p>在service-util模块引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="硅谷通用权限系统前端权限对接">硅谷通用权限系统：前端权限对接</h1><h2 id="一菜单权限及按钮权限">一、菜单权限及按钮权限</h2><p>按照下面步骤即可完成前端框架权限对接</p><h3 id="修改request.js文件">1、修改request.js文件</h3><figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs02/202212272155724.png" alt="image-20221009093919396"><figcaption aria-hidden="true">image-20221009093919396</figcaption></figure><h3 id="storemodulesuser.js">2、store/modules/user.js</h3><p>新增菜单及按钮处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultState</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">token</span>: <span class="hljs-title function_">getToken</span>(),<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">avatar</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br><br>    <span class="hljs-attr">buttons</span>: [], <span class="hljs-comment">// 新增</span><br>    <span class="hljs-attr">menus</span>: <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-comment">//新增</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> mutations = &#123;<br>  <span class="hljs-attr">RESET_STATE</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> &#123;<br>    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(state, <span class="hljs-title function_">getDefaultState</span>())<br>  &#125;,<br>  <span class="hljs-attr">SET_TOKEN</span>: <span class="hljs-function">(<span class="hljs-params">state, token</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">token</span> = token<br>  &#125;,<br>  <span class="hljs-attr">SET_NAME</span>: <span class="hljs-function">(<span class="hljs-params">state, name</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">name</span> = name<br>  &#125;,<br>  <span class="hljs-attr">SET_AVATAR</span>: <span class="hljs-function">(<span class="hljs-params">state, avatar</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">avatar</span> = avatar<br>  &#125;,<br>  <br>  <span class="hljs-comment">// 新增</span><br>  <span class="hljs-attr">SET_BUTTONS</span>: <span class="hljs-function">(<span class="hljs-params">state, buttons</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">buttons</span> = buttons<br>  &#125;,<br>  <span class="hljs-comment">// 新增</span><br>  <span class="hljs-attr">SET_MENUS</span>: <span class="hljs-function">(<span class="hljs-params">state, menus</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">menus</span> = menus<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// get user info</span><br><span class="hljs-title function_">getInfo</span>(<span class="hljs-params">&#123; commit, state &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">getInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> &#123; data &#125; = response<br><br>      <span class="hljs-keyword">if</span> (!data) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;Verification failed, please Login again.&#x27;</span>)<br>      &#125;<br><br>      <span class="hljs-keyword">const</span> &#123; name, avatar &#125; = data<br><br>      <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;SET_NAME&#x27;</span>, name)<br>      <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;SET_AVATAR&#x27;</span>, avatar)<br><br>      <span class="hljs-title function_">commit</span>(<span class="hljs-string">&quot;SET_BUTTONS&quot;</span>, data.<span class="hljs-property">buttons</span>)<br>      <span class="hljs-title function_">commit</span>(<span class="hljs-string">&quot;SET_MENUS&quot;</span>, data.<span class="hljs-property">routers</span>)<br>      <span class="hljs-title function_">resolve</span>(data)<br>    &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>      <span class="hljs-title function_">reject</span>(error)<br>    &#125;)<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="storegetters.js">3、store/getters.js</h3><p>新增菜单及按钮处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> getters = &#123;<br>  <span class="hljs-attr">sidebar</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">app</span>.<span class="hljs-property">sidebar</span>,<br>  <span class="hljs-attr">device</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">app</span>.<span class="hljs-property">device</span>,<br>  <span class="hljs-attr">token</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">token</span>,<br>  <span class="hljs-attr">avatar</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">avatar</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>,<br><br>  <span class="hljs-comment">//新增</span><br>  <span class="hljs-attr">buttons</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">buttons</span>,<br>  <span class="hljs-attr">menus</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">menus</span><br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> getters<br></code></pre></td></tr></table></figure><h3 id="srcrouter">4、src/router</h3><p>先在router这个目录下新建两个js文件，开发环境和生产环境导入组件的方式略有不同</p><p>_import_production.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 生产环境导入组件</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/&#x27;</span> + file + <span class="hljs-string">&#x27;.vue&#x27;</span>)<br></code></pre></td></tr></table></figure><p>_import_development.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 开发环境导入组件</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@/views/&#x27;</span> + file + <span class="hljs-string">&#x27;.vue&#x27;</span>).<span class="hljs-property">default</span> <span class="hljs-comment">// vue-loader at least v13.0.0+</span><br></code></pre></td></tr></table></figure><h3 id="srcpermission.js">5、src/permission.js</h3><p>整体替换该文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./store&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getToken &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/auth&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Message</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-ui&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">NProgress</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nprogress&#x27;</span> <span class="hljs-comment">// 水平进度条提示: 在跳转路由时使用</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;nprogress/nprogress.css&#x27;</span> <span class="hljs-comment">// 水平进度条样式</span><br><span class="hljs-keyword">import</span> getPageTitle <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/get-page-title&#x27;</span> <span class="hljs-comment">// 获取应用头部标题的函数</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/layout&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ParentView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ParentView&#x27;</span><br><span class="hljs-keyword">const</span> _import = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./router/_import_&#x27;</span>+process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>) <span class="hljs-comment">// 获取组件的方法</span><br><br><span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">configure</span>(&#123; <span class="hljs-attr">showSpinner</span>: <span class="hljs-literal">false</span> &#125;) <span class="hljs-comment">// NProgress Configuration</span><br><span class="hljs-keyword">const</span> whiteList = [<span class="hljs-string">&#x27;/login&#x27;</span>] <span class="hljs-comment">// no redirect whitelist</span><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">async</span>(to, <span class="hljs-keyword">from</span>, next) =&gt; &#123;<br>  <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">start</span>()<br><span class="hljs-comment">// set page title</span><br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-title function_">getPageTitle</span>(to.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)<br><span class="hljs-comment">// determine whether the user has logged in</span><br>  <span class="hljs-keyword">const</span> hasToken = <span class="hljs-title function_">getToken</span>()<br>  <span class="hljs-keyword">if</span> (hasToken) &#123;<br>    <span class="hljs-keyword">if</span> (to.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/login&#x27;</span>) &#123;<br>      <span class="hljs-comment">// if is logged in, redirect to the home page</span><br>      <span class="hljs-title function_">next</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span> &#125;)<br>      <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">done</span>()<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">const</span> hasGetUserInfo = store.<span class="hljs-property">getters</span>.<span class="hljs-property">name</span><br>      <span class="hljs-keyword">if</span> (hasGetUserInfo) &#123;<br>        <span class="hljs-title function_">next</span>()<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// get user info</span><br>          <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">&#x27;user/getInfo&#x27;</span>)<span class="hljs-comment">// 请求获取用户信息</span><br>          <span class="hljs-keyword">if</span> (store.<span class="hljs-property">getters</span>.<span class="hljs-property">menus</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-variable language_">global</span>.<span class="hljs-property">antRouter</span> = []<br>            <span class="hljs-title function_">next</span>()<br>          &#125;<br>          <span class="hljs-keyword">const</span> menus = <span class="hljs-title function_">filterAsyncRouter</span>(store.<span class="hljs-property">getters</span>.<span class="hljs-property">menus</span>)<span class="hljs-comment">// 1.过滤路由</span><br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(menus)<br>          router.<span class="hljs-title function_">addRoutes</span>(menus) <span class="hljs-comment">// 2.动态添加路由</span><br>          <span class="hljs-keyword">let</span> lastRou = [&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/404&#x27;</span>, <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span> &#125;]<br>          router.<span class="hljs-title function_">addRoutes</span>(lastRou)<br>          <span class="hljs-variable language_">global</span>.<span class="hljs-property">antRouter</span> = menus <span class="hljs-comment">// 3.将路由数据传递给全局变量，做侧边栏菜单渲染工作</span><br>          <span class="hljs-title function_">next</span>(&#123;<br>            ...to,<br>            <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span><br>          &#125;)<br>          <span class="hljs-comment">//next()</span><br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          <span class="hljs-comment">// remove token and go to login page to re-login</span><br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>          <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">&#x27;user/resetToken&#x27;</span>)<br>          <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(error || <span class="hljs-string">&#x27;Has Error&#x27;</span>)<br>          <span class="hljs-title function_">next</span>(<span class="hljs-string">`/login?redirect=<span class="hljs-subst">$&#123;to.path&#125;</span>`</span>)<br>          <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">done</span>()<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">/* has no token*/</span><br>    <span class="hljs-keyword">if</span> (whiteList.<span class="hljs-title function_">indexOf</span>(to.<span class="hljs-property">path</span>) !== -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// in the free login whitelist, go directly</span><br>      <span class="hljs-title function_">next</span>()<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// other pages that do not have permission to access are redirected to the login page.</span><br>      <span class="hljs-title function_">next</span>(<span class="hljs-string">`/login?redirect=<span class="hljs-subst">$&#123;to.path&#125;</span>`</span>)<br>      <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">done</span>()<br>    &#125;<br>  &#125;<br>&#125;)<br><br>router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">// finish progress bar</span><br>  <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">done</span>()<br>&#125;) <span class="hljs-comment">// // 遍历后台传来的路由字符串，转换为组件对象</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">filterAsyncRouter</span>(<span class="hljs-params">asyncRouterMap</span>) &#123;<br>  <span class="hljs-keyword">const</span> accessedRouters = asyncRouterMap.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (route.<span class="hljs-property">component</span>) &#123;<br>      <span class="hljs-keyword">if</span> (route.<span class="hljs-property">component</span> === <span class="hljs-string">&#x27;Layout&#x27;</span>) &#123;<br>        route.<span class="hljs-property">component</span> = <span class="hljs-title class_">Layout</span><br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (route.<span class="hljs-property">component</span> === <span class="hljs-string">&#x27;ParentView&#x27;</span>) &#123;<br>        route.<span class="hljs-property">component</span> = <span class="hljs-title class_">ParentView</span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          route.<span class="hljs-property">component</span> = <span class="hljs-title function_">_import</span>(route.<span class="hljs-property">component</span>)<span class="hljs-comment">// 导入组件</span><br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          <span class="hljs-keyword">debugger</span><br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>          route.<span class="hljs-property">component</span> = <span class="hljs-title function_">_import</span>(<span class="hljs-string">&#x27;dashboard/index&#x27;</span>)<span class="hljs-comment">// 导入组件</span><br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (route.<span class="hljs-property">children</span> &amp;&amp; route.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      route.<span class="hljs-property">children</span> = <span class="hljs-title function_">filterAsyncRouter</span>(route.<span class="hljs-property">children</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">delete</span> route.<span class="hljs-property">children</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;)<br>  <span class="hljs-keyword">return</span> accessedRouters<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="srcrouter-1">6、src/router</h3><p>删除index.js中自定义的路由，以下注释内容即为要删除的内容</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> constantRoutes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/login/index&#x27;</span>),<br>    <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span><br>  &#125;,<br><br>  <span class="hljs-comment">// &#123;</span><br>  <span class="hljs-comment">//   path: &#x27;/404&#x27;,</span><br>  <span class="hljs-comment">//   component: () =&gt; import(&#x27;@/views/404&#x27;),</span><br>  <span class="hljs-comment">//   hidden: true</span><br>  <span class="hljs-comment">// &#125;,</span><br><br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span>,<br>    <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">children</span>: [&#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;dashboard&#x27;</span>,<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Dashboard&#x27;</span>,<br>      <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/dashboard/index&#x27;</span>),<br>      <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Dashboard&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;dashboard&#x27;</span> &#125;<br>    &#125;]<br>  &#125;<br><br><br>  <span class="hljs-comment">//添加我们的路由</span><br>  <span class="hljs-comment">// &#123;</span><br>  <span class="hljs-comment">//   path: &#x27;/system&#x27;,</span><br>  <span class="hljs-comment">//   component: Layout,</span><br>  <span class="hljs-comment">//   meta: &#123;</span><br>  <span class="hljs-comment">//     title: &#x27;系统管理&#x27;,</span><br>  <span class="hljs-comment">//     icon: &#x27;el-icon-s-tools&#x27;</span><br>  <span class="hljs-comment">//   &#125;,</span><br>  <span class="hljs-comment">//   alwaysShow: true,</span><br>  <span class="hljs-comment">//   children: [</span><br>  <span class="hljs-comment">//     &#123;</span><br>  <span class="hljs-comment">//       path: &#x27;sysRole&#x27;,</span><br>  <span class="hljs-comment">//       component: () =&gt; import(&#x27;@/views/system/sysRole/list&#x27;),</span><br>  <span class="hljs-comment">//       meta: &#123;</span><br>  <span class="hljs-comment">//         title: &#x27;角色管理&#x27;,</span><br>  <span class="hljs-comment">//         icon: &#x27;el-icon-s-help&#x27;</span><br>  <span class="hljs-comment">//       &#125;,</span><br>  <span class="hljs-comment">//     &#125;,</span><br>  <span class="hljs-comment">//     &#123;</span><br>  <span class="hljs-comment">//       path: &#x27;sysUser&#x27;,</span><br>  <span class="hljs-comment">//       component: () =&gt; import(&#x27;@/views/system/sysUser/list&#x27;),</span><br>  <span class="hljs-comment">//       meta: &#123;</span><br>  <span class="hljs-comment">//         title: &#x27;用户管理&#x27;,</span><br>  <span class="hljs-comment">//         icon: &#x27;el-icon-s-help&#x27;</span><br>  <span class="hljs-comment">//       &#125;,</span><br>  <span class="hljs-comment">//     &#125;,</span><br><br>  <span class="hljs-comment">//     &#123;</span><br>  <span class="hljs-comment">//       name: &#x27;sysMenu&#x27;,</span><br>  <span class="hljs-comment">//       path: &#x27;sysMenu&#x27;,</span><br>  <span class="hljs-comment">//       component: () =&gt; import(&#x27;@/views/system/sysMenu/list&#x27;),</span><br>  <span class="hljs-comment">//       meta: &#123;</span><br>  <span class="hljs-comment">//         title: &#x27;菜单管理&#x27;,</span><br>  <span class="hljs-comment">//         icon: &#x27;el-icon-s-unfold&#x27;</span><br>  <span class="hljs-comment">//       &#125;,</span><br>  <span class="hljs-comment">//     &#125;,</span><br><br>  <span class="hljs-comment">//     &#123;</span><br>  <span class="hljs-comment">//       path: &#x27;assignAuth&#x27;,</span><br>  <span class="hljs-comment">//       component: () =&gt; import(&#x27;@/views/system/sysRole/assignAuth&#x27;),</span><br>  <span class="hljs-comment">//       meta: &#123;</span><br>  <span class="hljs-comment">//         activeMenu: &#x27;/system/sysRole&#x27;,</span><br>  <span class="hljs-comment">//         title: &#x27;角色授权&#x27;</span><br>  <span class="hljs-comment">//       &#125;,</span><br>  <span class="hljs-comment">//       hidden: true,</span><br>  <span class="hljs-comment">//     &#125;</span><br>  <span class="hljs-comment">//   ]</span><br>  <span class="hljs-comment">// &#125;,</span><br><br><br>  <span class="hljs-comment">// 404 page must be placed at the end !!!</span><br>  <span class="hljs-comment">// &#123; path: &#x27;*&#x27;, redirect: &#x27;/404&#x27;, hidden: true &#125;</span><br>]<br></code></pre></td></tr></table></figure><h3 id="srccomponents">7、src/components</h3><p>在scr/components目录下新建ParentView文件夹，添加index.vue</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="layoutcomponentssidebarindex.vue">8、layout/components/SideBar/index.vue</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">computed</span>: &#123;<br>  ...<span class="hljs-title function_">mapGetters</span>([<br>    <span class="hljs-string">&#x27;sidebar&#x27;</span><br>  ]),<br>  <span class="hljs-title function_">routes</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//return this.$router.options.routes</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-property">options</span>.<span class="hljs-property">routes</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-variable language_">global</span>.<span class="hljs-property">antRouter</span>)<br>  &#125;,<br></code></pre></td></tr></table></figure><h3 id="utilsbtn-permission.js">9、utils/btn-permission.js</h3><p>在uitls目录添加btn-permission.js文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store&#x27;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 判断当前用户是否有此按钮权限</span><br><span class="hljs-comment"> * 按钮权限字符串 permission </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasBtnPermission</span>(<span class="hljs-params">permission</span>) &#123;<br>  <span class="hljs-comment">// 得到当前用户的所有按钮权限</span><br>  <span class="hljs-keyword">const</span> myBtns = store.<span class="hljs-property">getters</span>.<span class="hljs-property">buttons</span><br>  <span class="hljs-comment">// 如果指定的功能权限在myBtns中, 返回true ==&gt; 这个按钮就会显示, 否则隐藏</span><br>  <span class="hljs-keyword">return</span> myBtns.<span class="hljs-title function_">indexOf</span>(permission) !== -<span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="main.js">10、main.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//新增</span><br><span class="hljs-keyword">import</span> hasBtnPermission <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/btn-permission&#x27;</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$hasBP</span> = hasBtnPermission<br></code></pre></td></tr></table></figure><h3 id="按钮权限控制">11、按钮权限控制</h3><p>$hasBP('bnt.sysRole.add')控制按钮是否显示</p><p>如：角色管理添加按钮，我们没让按钮隐藏，而是让按钮不可操作</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;success&quot;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&quot;el-icon-plus&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;mini&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;add&quot;</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;$hasBP(&#x27;bnt.sysRole.add&#x27;)  === false&quot;</span>&gt;</span>添 加<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br></code></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://Unicorn-acc.github.io">Miraclo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://unicorn-acc.github.io/posts/16785.html">http://unicorn-acc.github.io/posts/16785.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Unicorn-acc.github.io" target="_blank">Miraclo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A1%85%E8%B0%B7%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F/">硅谷权限系统</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/6678.html"><img class="prev-cover" src="https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">黑马学成在线--01--项目介绍、项目开发环境搭建</div></div></a></div><div class="next-post pull-right"><a href="/posts/63123.html"><img class="next-cover" src="https://w.wallhaven.cc/full/1p/wallhaven-1p1qjg.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">硅谷权限系统-05-菜单管理</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/13474.html" title="硅谷权限系统-02-前端基础知识、Nodejs、NPM、前端模块化开发ES6"><img class="cover" src="https://w.wallhaven.cc/full/kx/wallhaven-kx3p1q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-21</div><div class="title">硅谷权限系统-02-前端基础知识、Nodejs、NPM、前端模块化开发ES6</div></div></a></div><div><a href="/posts/52919.html" title="硅谷权限系统-03-角色管理前端"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-23</div><div class="title">硅谷权限系统-03-角色管理前端</div></div></a></div><div><a href="/posts/63641.html" title="硅谷权限系统-04-用户管理CRUD、给用户分配角色"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-23</div><div class="title">硅谷权限系统-04-用户管理CRUD、给用户分配角色</div></div></a></div><div><a href="/posts/63123.html" title="硅谷权限系统-05-菜单管理"><img class="cover" src="https://w.wallhaven.cc/full/1p/wallhaven-1p1qjg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-27</div><div class="title">硅谷权限系统-05-菜单管理</div></div></a></div><div><a href="/posts/60802.html" title="硅谷权限系统-01-搭建环境、Mybatis-Plus入门、角色管理(整合Swagger2、统一返回结果、分页查询、统一异常处理)"><img class="cover" src="https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-21</div><div class="title">硅谷权限系统-01-搭建环境、Mybatis-Plus入门、角色管理(整合Swagger2、统一返回结果、分页查询、统一异常处理)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%85%E8%B0%B7%E9%80%9A%E7%94%A8%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">硅谷通用权限系统：权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">一、权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-text">1、权限管理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90"><span class="toc-text">1.1、菜单权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90"><span class="toc-text">1.2、按钮权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-text">1.3、权限管理设计思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jwt"><span class="toc-text">2、JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jwt%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.1、JWT介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jwt%E4%BB%A4%E7%89%8C%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-text">2.2、JWT令牌的组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90jwt"><span class="toc-text">2.3、项目集成JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%E5%89%8D%E9%9D%A2%E5%B7%B2%E7%BB%8F%E5%BC%95%E5%85%A5"><span class="toc-text">2.3.1、 引入依赖（前面已经引入）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0jwt%E5%B8%AE%E5%8A%A9%E7%B1%BB"><span class="toc-text">2.3.2、 添加JWT帮助类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-text">3、用户登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E6%96%B9%E6%B3%95"><span class="toc-text">3.1、修改登录方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0service%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.2、添加service接口及实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">4、获取用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90"><span class="toc-text">4.1、获取用户菜单权限</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-text">4.1.1、定义接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.1.2、接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0router%E5%B8%AE%E5%8A%A9%E7%B1%BB"><span class="toc-text">4.1.3、添加Router帮助类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0mapper%E6%8E%A5%E5%8F%A3"><span class="toc-text">4.1.4、添加mapper接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0xml%E6%96%B9%E6%B3%95"><span class="toc-text">4.1.5、添加xml方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90"><span class="toc-text">4.2、获取用户按钮权限</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3-1"><span class="toc-text">4.1.1、定义接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0-1"><span class="toc-text">4.1.2、接口实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9controller%E6%96%B9%E6%B3%95"><span class="toc-text">4.3、修改Controller方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89service%E6%8E%A5%E5%8F%A3"><span class="toc-text">4.4、定义service接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.5、service接口实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AF%B9%E6%8E%A5"><span class="toc-text">5、前端对接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">6、总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8Cspring-security%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、Spring Security介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-security%E7%AE%80%E4%BB%8B"><span class="toc-text">1、Spring Security简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2"><span class="toc-text">2、历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AC%BE%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94"><span class="toc-text">3、同款产品对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-security"><span class="toc-text">3.1、Spring Security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro"><span class="toc-text">3.2、 Shiro</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89spring-security%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90"><span class="toc-text">三、Spring Security实现权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-security%E5%85%A5%E9%97%A8"><span class="toc-text">1、Spring Security入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAspring-security%E6%A8%A1%E5%9D%97"><span class="toc-text">1.1、创建spring-security模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-text">1.2、添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">1.3、添加配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service-system%E6%A8%A1%E5%9D%97%E5%BC%95%E5%85%A5"><span class="toc-text">1.4、service-system模块引入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">1.5、启动项目测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-text">2、用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-text">2.1、用户认证核心组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81-1"><span class="toc-text">2.2、用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-text">2.2.1、认证接口分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%99%A8passwordencoder"><span class="toc-text">2.2.3、加密器PasswordEncoder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%AF%B9%E8%B1%A1userdetails"><span class="toc-text">2.2.4、用户对象UserDetails</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%AF%B9%E8%B1%A1userdetailsservice"><span class="toc-text">2.2.5 业务对象UserDetailsService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.6、自定义用户认证接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E8%A7%A3%E6%9E%90token"><span class="toc-text">2.2.7、认证解析token</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-text">2.2.8、配置用户认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87swagger%E6%B5%8B%E8%AF%95%E7%99%BB%E5%BD%95"><span class="toc-text">2.2.9、通过swagger测试登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-text">3、用户授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9loaduserbyusername%E6%8E%A5%E5%8F%A3%E6%96%B9%E6%B3%95"><span class="toc-text">3.1、修改loadUserByUsername接口方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-security%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AEredis"><span class="toc-text">3.2、spring-security模块配置redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9tokenloginfilter%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E6%96%B9%E6%B3%95"><span class="toc-text">3.3、修改TokenLoginFilter登录成功方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9tokenauthenticationfilter"><span class="toc-text">3.4、修改TokenAuthenticationFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">3.5、修改配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service-system%E6%A8%A1%E5%9D%97%E6%B7%BB%E5%8A%A0redis%E9%85%8D%E7%BD%AE"><span class="toc-text">3.6、service-system模块添加redis配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6controller%E5%B1%82%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90"><span class="toc-text">3.7、控制controller层接口权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%9D%83%E9%99%90"><span class="toc-text">3.8、测试服务器端权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">3.9、异常处理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%85%E8%B0%B7%E9%80%9A%E7%94%A8%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F%E5%89%8D%E7%AB%AF%E6%9D%83%E9%99%90%E5%AF%B9%E6%8E%A5"><span class="toc-text">硅谷通用权限系统：前端权限对接</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%8F%9C%E5%8D%95%E6%9D%83%E9%99%90%E5%8F%8A%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90"><span class="toc-text">一、菜单权限及按钮权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9request.js%E6%96%87%E4%BB%B6"><span class="toc-text">1、修改request.js文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#storemodulesuser.js"><span class="toc-text">2、store&#x2F;modules&#x2F;user.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#storegetters.js"><span class="toc-text">3、store&#x2F;getters.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#srcrouter"><span class="toc-text">4、src&#x2F;router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#srcpermission.js"><span class="toc-text">5、src&#x2F;permission.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#srcrouter-1"><span class="toc-text">6、src&#x2F;router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#srccomponents"><span class="toc-text">7、src&#x2F;components</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#layoutcomponentssidebarindex.vue"><span class="toc-text">8、layout&#x2F;components&#x2F;SideBar&#x2F;index.vue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#utilsbtn-permission.js"><span class="toc-text">9、utils&#x2F;btn-permission.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main.js"><span class="toc-text">10、main.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E9%92%AE%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">11、按钮权限控制</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Miraclo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">人只有在走上坡路的时候才会累和迷茫。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.1},options:{renderActions:{findScript:[10,t=>{for(const n of document.querySelectorAll('script[type^="math/tex"]')){var e=!!n.type.match(/; *mode=display/),e=new t.options.MathItem(n.textContent,t.inputJax[0],e),a=document.createTextNode("");n.parentNode.replaceChild(a,n),e.start={node:a,delim:"",n:0},e.end={node:a,delim:"",n:0},t.math.push(e)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(t=>{t.hasAttribute("display")?btf.wrap(t,"div",{class:"mathjax-overflow"}):btf.wrap(t,"span",{class:"mathjax-overflow"})})},"",!1]}}};const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",a.id="MathJax-script",a.async=!0,document.head.appendChild(a)}</script></div><link rel="stylesheet" href="/css/Lete.css"><script src="/js/custom.js"></script><script src="/js/mouth.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","1ms"),arr[i].setAttribute("data-wow-offset","100"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script></body></html>
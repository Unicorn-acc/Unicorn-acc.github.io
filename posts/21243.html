<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>目标检测_01_Faster R-CNN源码解析(如何自定义VOC数据集) | Miraclo’s Blog</title><meta name="author" content="Miraclo"><meta name="copyright" content="Miraclo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考内容来自霹雳吧啦Wz up主的b站链接：https:&#x2F;&#x2F;space.bilibili.com&#x2F;18161609&#x2F;channel&#x2F;index up主的github：https:&#x2F;&#x2F;github.com&#x2F;WZMIAOMIAO&#x2F;deep-learning-for-image-processing up主的CSDN博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_37541097&#x2F;articl"><meta property="og:type" content="article"><meta property="og:title" content="目标检测_01_Faster R-CNN源码解析(如何自定义VOC数据集)"><meta property="og:url" content="http://unicorn-acc.github.io/posts/21243.html"><meta property="og:site_name" content="Miraclo’s Blog"><meta property="og:description" content="参考内容来自霹雳吧啦Wz up主的b站链接：https:&#x2F;&#x2F;space.bilibili.com&#x2F;18161609&#x2F;channel&#x2F;index up主的github：https:&#x2F;&#x2F;github.com&#x2F;WZMIAOMIAO&#x2F;deep-learning-for-image-processing up主的CSDN博客：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_37541097&#x2F;articl"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg"><meta property="article:published_time" content="2022-11-14T10:06:55.000Z"><meta property="article:modified_time" content="2022-11-17T09:30:16.891Z"><meta property="article:author" content="Miraclo"><meta property="article:tag" content="DeepLearning"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://unicorn-acc.github.io/posts/21243"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"prismjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:2e3},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:500,languages:{author:"作者: Miraclo",link:"链接: ",source:"来源: Miraclo’s Blog",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"目标检测_01_Faster R-CNN源码解析(如何自定义VOC数据集)",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-11-17 09:30:16"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/mouth.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">171</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">32</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span></span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Miraclo’s Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i><span></span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">目标检测_01_Faster R-CNN源码解析(如何自定义VOC数据集)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-14T10:06:55.000Z" title="发表于 2022-11-14 10:06:55">2022-11-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-17T09:30:16.891Z" title="更新于 2022-11-17 09:30:16">2022-11-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">深度学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/">网络模型</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/2%E3%80%81%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AF%87/">2、目标检测篇</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">26.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>128分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="目标检测_01_Faster R-CNN源码解析(如何自定义VOC数据集)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote><p>参考内容来自霹雳吧啦Wz</p><p>up主的b站链接：https://space.bilibili.com/18161609/channel/index</p><p>up主的github：https://github.com/WZMIAOMIAO/deep-learning-for-image-processing</p><p>up主的CSDN博客：https://blog.csdn.net/qq_37541097/article/details/103482003</p><p>博客参考：https://blog.csdn.net/weixin_44878336/category_11399973.html</p><p><font color="#FF0000">看不懂，过段时间再看</font></p></blockquote><h1 id="代码的使用">0 代码的使用</h1><h2 id="如何找到pytorch官方的模型源码">0.1 如何找到PyTorch官方的模型源码</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models<span class="token punctuation">.</span>detection <span class="token keyword">import</span> faster_rcnn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是只有模型代码，并没有和训练相关的代码。</p><h2 id="如何找到pytorch官方的训练相关代码">0.2 如何找到PyTorch官方的训练相关代码</h2><p>Pytorch官网链接：https://github.com/pytorch/vision/tree/main/references</p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211141019555.png" style="zoom:67%"></p><h2 id="环境配置">0.3 环境配置</h2><ul><li>Python3.6/3.7/3.8</li><li>Pytorch1.7.1(注意：必须是1.6.0或以上，因为使用官方提供的混合精度训练1.6.0后才支持)</li><li>pycocotools(Linux:<code>pip install pycocotools</code>; Windows:<code>pip install pycocotools-windows</code>(不需要额外安装vs))</li><li>Ubuntu或Centos(不建议Windows)</li><li>最好使用GPU训练</li><li>lxml</li><li>matplotlib</li><li>numpy</li><li>tqdm</li><li>Pillow</li></ul><h2 id="文件结构">0.4 文件结构</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">├── backbone<span class="token punctuation">:</span> 特征提取网络，可以根据自己的要求选择：①MobileNet v2；②ResNet<span class="token operator">-</span><span class="token number">50</span> <span class="token operator">+</span> FPN（Feature Pyramid Networks， 特征金字塔、池化金字塔）
├── network_files<span class="token punctuation">:</span> Faster R<span class="token operator">-</span>CNN网络（包括Fast R<span class="token operator">-</span>CNN以及RPN等模块）
├── train_utils<span class="token punctuation">:</span> 训练验证相关模块（包括cocotools）：https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>pytorch<span class="token operator">/</span>vision<span class="token operator">/</span>tree<span class="token operator">/</span>main<span class="token operator">/</span>references<span class="token operator">/</span>detection
├── my_dataset<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 自定义dataset用于读取VOC数据集
├── train_mobilenet<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 以MobileNetV2做为backbone进行训练（主讲，准确率没有下面的好）
├── train_resnet50_fpn<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 以resnet50<span class="token operator">+</span>FPN做为backbone进行训练（效果最好）
├── train_multi_GPU<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 针对使用多GPU的用户使用（并行训练）
├── predict<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 简易的预测脚本，使用训练好的权重进行预测
├── validation<span class="token punctuation">.</span>py<span class="token punctuation">:</span> 利用训练好的权重验证<span class="token operator">/</span>测试数据的COCO指标，并生成record_mAP<span class="token punctuation">.</span>txt文件
└── pascal_voc_classes<span class="token punctuation">.</span>json<span class="token punctuation">:</span> PASCAL VOC标签文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pascal_voc_classes.json">0.5 pascal_voc_classes.json</h2><p>内容如下：</p><pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;aeroplane&quot;: 1,
    &quot;bicycle&quot;: 2,
    &quot;bird&quot;: 3,
    &quot;boat&quot;: 4,
    &quot;bottle&quot;: 5,
    &quot;bus&quot;: 6,
    &quot;car&quot;: 7,
    &quot;cat&quot;: 8,
    &quot;chair&quot;: 9,
    &quot;cow&quot;: 10,
    &quot;diningtable&quot;: 11,
    &quot;dog&quot;: 12,
    &quot;horse&quot;: 13,
    &quot;motorbike&quot;: 14,
    &quot;person&quot;: 15,
    &quot;pottedplant&quot;: 16,
    &quot;sheep&quot;: 17,
    &quot;sofa&quot;: 18,
    &quot;train&quot;: 19,
    &quot;tvmonitor&quot;: 20
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Q：类别为什么不从<code>0</code>开始？</p><p>A：在目标检测中，一般<code>0</code>是留给背景（负样本）的</p><p>虽然PASCAL VOC 2012有20个类别，但实际训练时给了21个类别（为背景专门设置了一个类别）。</p><h2 id="预训练权重下载地址下载后放入backbone文件夹中">0.6 预训练权重下载地址（下载后放入backbone文件夹中）</h2><ul><li>MobileNetV2 weights(下载后重命名为<code>mobilenet_v2.pth</code>，然后放到<code>bakcbone</code>文件夹下): https://download.pytorch.org/models/mobilenet_v2-b0353104.pth</li><li>Resnet50 weights(下载后重命名为<code>resnet50.pth</code>，然后放到<code>bakcbone</code>文件夹下): https://download.pytorch.org/models/resnet50-0676ba61.pth</li><li>ResNet50+FPN weights: https://download.pytorch.org/models/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth</li></ul><blockquote><ul><li>注意，下载的预训练权重记得要重命名，比如在train_resnet50_fpn.py中读取的是<code>fasterrcnn_resnet50_fpn_coco.pth</code>文件，不是<code>fasterrcnn_resnet50_fpn_coco-258fb6c6.pth</code></li><li>对于MobileNet v2来说，因为预训练权重只有backbone，而Faster R-CNN除了backbone还有RPN网络以及FC层，所以这个训练权重是不完整的。而ResNet50+FPN是包含backbone和RPN的，所以是一个完整的预训练权重。</li></ul></blockquote><h2 id="数据集">0.7 数据集</h2><ul><li>Pascal VOC2012 train/val数据集下载地址：http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar</li><li>如果不了解数据集或者想使用自己的数据集进行训练，请参考我的bilibili：https://b23.tv/F1kSCK</li><li>使用ResNet50+FPN以及迁移学习在VOC2012数据集上得到的权重: 链接:https://pan.baidu.com/s/1ifilndFRtAV5RDZINSHj5w 提取码:dsz8</li></ul><h2 id="训练方法">0.8 训练方法</h2><ul><li>确保提前准备好数据集</li><li>确保提前下载好对应预训练模型权重</li><li>若要训练mobilenetv2+fasterrcnn，直接使用train_mobilenet.py训练脚本</li><li>若要训练resnet50+fpn+fasterrcnn，直接使用train_resnet50_fpn.py训练脚本</li><li>若要使用多GPU训练，使用<code>python -m torch.distributed.launch --nproc_per_node=8 --use_env train_multi_GPU.py</code>指令,<code>nproc_per_node</code>参数为使用GPU数量</li><li>如果想指定使用哪些GPU设备可在指令前加上<code>CUDA_VISIBLE_DEVICES=0,3</code>(例如我只要使用设备中的第1块和第4块GPU设备)</li><li><code>CUDA_VISIBLE_DEVICES=0,3 python -m torch.distributed.launch --nproc_per_node=2 --use_env train_multi_GPU.py</code></li></ul><blockquote><ul><li>学术研究使用mobilenetv2+fasterrcnn</li><li>实际应用使用resnet50+fpn+fasterrcnn</li></ul></blockquote><h2 id="注意事项">0.9 注意事项</h2><ul><li>在使用训练脚本时，注意要将<code>--data-path</code>(VOC_root)设置为自己存放<code>VOCdevkit</code>文件夹所在的<strong>根目录</strong></li><li>由于带有FPN结构的Faster RCNN很吃显存，如果GPU的显存不够(如果batch_size小于8的话)建议在create_model函数中使用默认的norm_layer， 即不传递norm_layer变量，默认去使用FrozenBatchNorm2d(即不会去更新参数的bn层),使用中发现效果也很好。</li><li>训练过程中保存的<code>results.txt</code>是每个epoch在验证集上的COCO指标，前12个值是COCO指标，后面两个值是训练平均损失以及学习率</li><li>在使用预测脚本时，要将<code>train_weights</code>设置为你自己生成的权重路径。</li><li>使用validation文件时，注意确保你的验证集或者测试集中必须包含每个类别的目标，并且使用时只需要修改<code>--num-classes</code>、<code>--data-path</code>和<code>--weights-path</code>即可，其他代码尽量不要改动</li></ul><h2 id="训练train.py">0.10 训练train.py</h2><h3 id="使用mobilenetv2作为backbone">使用mobilenetv2作为backbone</h3><p><code>train_mobilenetv2.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> datetime

<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision

<span class="token keyword">import</span> transforms
<span class="token keyword">from</span> network_files <span class="token keyword">import</span> FasterRCNN<span class="token punctuation">,</span> AnchorsGenerator
<span class="token keyword">from</span> backbone <span class="token keyword">import</span> MobileNetV2<span class="token punctuation">,</span> vgg
<span class="token keyword">from</span> my_dataset <span class="token keyword">import</span> VOCDataSet
<span class="token keyword">from</span> train_utils <span class="token keyword">import</span> GroupedBatchSampler<span class="token punctuation">,</span> create_aspect_ratio_groups
<span class="token keyword">from</span> train_utils <span class="token keyword">import</span> train_eval_utils <span class="token keyword">as</span> utils


<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># https://download.pytorch.org/models/vgg16-397923af.pth</span>
    <span class="token comment"># 如果使用vgg16的话就下载对应预训练权重并取消下面注释，接着把mobilenetv2模型对应的两行代码注释掉</span>
    <span class="token comment"># vgg_feature = vgg(model_name="vgg16", weights_path="./backbone/vgg16.pth").features</span>
    <span class="token comment"># backbone = torch.nn.Sequential(*list(vgg_feature._modules.values())[:-1])  # 删除features中最后一个Maxpool层</span>
    <span class="token comment"># backbone.out_channels = 512</span>

    <span class="token comment"># https://download.pytorch.org/models/mobilenet_v2-b0353104.pth</span>
    backbone <span class="token operator">=</span> MobileNetV2<span class="token punctuation">(</span>weights_path<span class="token operator">=</span><span class="token string">"./backbone/mobilenet_v2.pth"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>features
    backbone<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> <span class="token number">1280</span>  <span class="token comment"># 设置对应backbone输出特征矩阵的channels</span>

    anchor_generator <span class="token operator">=</span> AnchorsGenerator<span class="token punctuation">(</span>sizes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        aspect_ratios<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    roi_pooler <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>MultiScaleRoIAlign<span class="token punctuation">(</span>featmap_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 在哪些特征层上进行roi pooling</span>
                                                    output_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment"># roi_pooling输出特征矩阵尺寸</span>
                                                    sampling_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 采样率</span>

    model <span class="token operator">=</span> FasterRCNN<span class="token punctuation">(</span>backbone<span class="token operator">=</span>backbone<span class="token punctuation">,</span>
                       num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                       rpn_anchor_generator<span class="token operator">=</span>anchor_generator<span class="token punctuation">,</span>
                       box_roi_pool<span class="token operator">=</span>roi_pooler<span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using &#123;&#125; device training."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 用来保存coco_info的文件</span>
    results_file <span class="token operator">=</span> <span class="token string">"results&#123;&#125;.txt"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d-%H%M%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 检查保存权重文件夹是否存在，不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"save_weights"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"save_weights"</span><span class="token punctuation">)</span>

    data_transform <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    VOC_root <span class="token operator">=</span> <span class="token string">"./"</span>  <span class="token comment"># VOCdevkit</span>
    aspect_ratio_group_factor <span class="token operator">=</span> <span class="token number">3</span>
    batch_size <span class="token operator">=</span> <span class="token number">8</span>
    amp <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 是否使用混合精度训练，需要GPU支持</span>

    <span class="token comment"># check voc root</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"VOCdevkit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> FileNotFoundError<span class="token punctuation">(</span><span class="token string">"VOCdevkit dose not in path:'&#123;&#125;'."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>VOC_root<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># load train data set</span>
    <span class="token comment"># VOCdevkit -> VOC2012 -> ImageSets -> Main -> train.txt</span>
    train_dataset <span class="token operator">=</span> VOCDataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"train.txt"</span><span class="token punctuation">)</span>
    train_sampler <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 是否按图片相似高宽比采样图片组成batch</span>
    <span class="token comment"># 使用的话能够减小训练时所需GPU显存，默认使用</span>
    <span class="token keyword">if</span> aspect_ratio_group_factor <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        train_sampler <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>RandomSampler<span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span>
        <span class="token comment"># 统计所有图像高宽比例在bins区间中的位置索引</span>
        group_ids <span class="token operator">=</span> create_aspect_ratio_groups<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> k<span class="token operator">=</span>aspect_ratio_group_factor<span class="token punctuation">)</span>
        <span class="token comment"># 每个batch图片从同一高宽比例区间中取</span>
        train_batch_sampler <span class="token operator">=</span> GroupedBatchSampler<span class="token punctuation">(</span>train_sampler<span class="token punctuation">,</span> group_ids<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>

    nw <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size <span class="token keyword">if</span> batch_size <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># number of workers</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using %g dataloader workers'</span> <span class="token operator">%</span> nw<span class="token punctuation">)</span>

    <span class="token comment"># 注意这里的collate_fn是自定义的，因为读取的数据包括image和targets，不能直接使用默认的方法合成batch</span>
    <span class="token keyword">if</span> train_sampler<span class="token punctuation">:</span>
        <span class="token comment"># 如果按照图片高宽比采样图片，dataloader中需要使用batch_sampler</span>
        train_data_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span>
                                                        batch_sampler<span class="token operator">=</span>train_batch_sampler<span class="token punctuation">,</span>
                                                        pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                        collate_fn<span class="token operator">=</span>train_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        train_data_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span>
                                                        batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                                        shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                        collate_fn<span class="token operator">=</span>train_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># load validation data set</span>
    <span class="token comment"># VOCdevkit -> VOC2012 -> ImageSets -> Main -> val.txt</span>
    val_dataset <span class="token operator">=</span> VOCDataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"val"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"val.txt"</span><span class="token punctuation">)</span>
    val_data_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span>
                                                  batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                                  shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                                  pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                  num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                  collate_fn<span class="token operator">=</span>val_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># create model num_classes equal background + 20 classes</span>
    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span>
    <span class="token comment"># print(model)</span>

    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    scaler <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> amp <span class="token keyword">else</span> <span class="token boolean">None</span>

    train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    learning_rate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="token comment">#  first frozen backbone and train 5 epochs                   #</span>
    <span class="token comment">#  首先冻结前置特征提取网络权重（backbone），训练rpn以及最终预测网络部分 #</span>
    <span class="token comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="token keyword">for</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># define optimizer</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">]</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>
                                momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>

    init_epochs <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>init_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># train for one epoch, printing every 10 iterations</span>
        mean_loss<span class="token punctuation">,</span> lr <span class="token operator">=</span> utils<span class="token punctuation">.</span>train_one_epoch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> train_data_loader<span class="token punctuation">,</span>
                                              device<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> print_freq<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
                                              warmup<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scaler<span class="token operator">=</span>scaler<span class="token punctuation">)</span>
        train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        learning_rate<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lr<span class="token punctuation">)</span>

        <span class="token comment"># evaluate on the test dataset</span>
        coco_info <span class="token operator">=</span> utils<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> val_data_loader<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        <span class="token comment"># write into txt</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>results_file<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token comment"># 写入的数据包括coco指标还有loss和learning rate</span>
            result_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> coco_info <span class="token operator">+</span> <span class="token punctuation">[</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>lr<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">]</span>
            txt <span class="token operator">=</span> <span class="token string">"epoch:&#123;&#125; &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>result_info<span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>txt <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

        val_map<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coco_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># pascal mAP</span>

    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"./save_weights/pretrain.pth"</span><span class="token punctuation">)</span>

    <span class="token comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
    <span class="token comment">#  second unfrozen backbone and train all network     #</span>
    <span class="token comment">#  解冻前置特征提取网络权重（backbone），接着训练整个网络权重  #</span>
    <span class="token comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="token comment"># 冻结backbone部分底层权重</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span> parameter <span class="token keyword">in</span> model<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        split_name <span class="token operator">=</span> name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> split_name <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            parameter<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            parameter<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token comment"># define optimizer</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">]</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>
                                momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>
    <span class="token comment"># learning rate scheduler(每隔step_size步降低学习率，通过lr_scheduler.step()记录epoch次数)</span>
    lr_scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span>
                                                   step_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                                                   gamma<span class="token operator">=</span><span class="token number">0.33</span><span class="token punctuation">)</span>
    num_epochs <span class="token operator">=</span> <span class="token number">20</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>init_epochs<span class="token punctuation">,</span> num_epochs<span class="token operator">+</span>init_epochs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># train for one epoch, printing every 50 iterations</span>
        mean_loss<span class="token punctuation">,</span> lr <span class="token operator">=</span> utils<span class="token punctuation">.</span>train_one_epoch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> train_data_loader<span class="token punctuation">,</span>
                                              device<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> print_freq<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
                                              warmup<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> scaler<span class="token operator">=</span>scaler<span class="token punctuation">)</span>
        train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        learning_rate<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lr<span class="token punctuation">)</span>

        <span class="token comment"># update the learning rate</span>
        lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># evaluate on the test dataset</span>
        coco_info <span class="token operator">=</span> utils<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> val_data_loader<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        <span class="token comment"># write into txt</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>results_file<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token comment"># 写入的数据包括coco指标还有loss和learning rate</span>
            result_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> coco_info <span class="token operator">+</span> <span class="token punctuation">[</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>lr<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">]</span>
            txt <span class="token operator">=</span> <span class="token string">"epoch:&#123;&#125; &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>result_info<span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>txt <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

        val_map<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coco_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># pascal mAP</span>

        <span class="token comment"># save weights</span>
        <span class="token comment"># 仅保存最后5个epoch的权重</span>
        <span class="token keyword">if</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token operator">+</span>init_epochs<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            save_files <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">'model'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'lr_scheduler'</span><span class="token punctuation">:</span> lr_scheduler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">&#125;</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_files<span class="token punctuation">,</span> <span class="token string">"./save_weights/mobile-model-&#123;&#125;.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># plot loss and lr curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>learning_rate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_loss_and_lr
        plot_loss_and_lr<span class="token punctuation">(</span>train_loss<span class="token punctuation">,</span> learning_rate<span class="token punctuation">)</span>

    <span class="token comment"># plot mAP curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_map<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_map
        plot_map<span class="token punctuation">(</span>val_map<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用resnet50fpn作为backbone">使用resnet50+fpn作为BackBone</h3><p><code>train_res50_fpn</code>大致与mobilenetv2训练方法相同，不同在于使用参数args，方便命令行输入参数，显得更专业</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> argparse

    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>
        description<span class="token operator">=</span>__doc__<span class="token punctuation">)</span>

    <span class="token comment"># 训练设备类型</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'device'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练数据集的根目录(VOCdevkit)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data-path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'dataset'</span><span class="token punctuation">)</span>
    <span class="token comment"># 检测目标类别数(不包含背景)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--num-classes'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'num_classes'</span><span class="token punctuation">)</span>
    <span class="token comment"># 文件保存地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--output-dir'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./save_weights'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path where to save'</span><span class="token punctuation">)</span>
    <span class="token comment"># 若需要接着上次训练，则指定上次训练保存权重文件地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume from checkpoint'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定接着从哪个epoch数开始训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--start_epoch'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'start epoch'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的总epoch数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of total epochs to run'</span><span class="token punctuation">)</span>
    <span class="token comment"># 学习率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--lr'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'initial learning rate, 0.02 is the default value for training '</span>
                             <span class="token string">'on 8 gpus and 2 images_per_gpu'</span><span class="token punctuation">)</span>
    <span class="token comment"># SGD的momentum参数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--momentum'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'M'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'momentum'</span><span class="token punctuation">)</span>
    <span class="token comment"># SGD的weight_decay参数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--wd'</span><span class="token punctuation">,</span> <span class="token string">'--weight-decay'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        metavar<span class="token operator">=</span><span class="token string">'W'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'weight decay (default: 1e-4)'</span><span class="token punctuation">,</span>
                        dest<span class="token operator">=</span><span class="token string">'weight_decay'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的batch size</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'batch size when training.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--aspect-ratio-group-factor'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否使用混合精度训练(需要GPU支持混合精度)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--amp"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Use torch.cuda.amp for mixed precision training"</span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>完整代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> datetime

<span class="token keyword">import</span> torch

<span class="token keyword">import</span> transforms
<span class="token keyword">from</span> network_files <span class="token keyword">import</span> FasterRCNN<span class="token punctuation">,</span> FastRCNNPredictor
<span class="token keyword">from</span> backbone <span class="token keyword">import</span> resnet50_fpn_backbone
<span class="token keyword">from</span> my_dataset <span class="token keyword">import</span> VOCDataSet
<span class="token keyword">from</span> train_utils <span class="token keyword">import</span> GroupedBatchSampler<span class="token punctuation">,</span> create_aspect_ratio_groups
<span class="token keyword">from</span> train_utils <span class="token keyword">import</span> train_eval_utils <span class="token keyword">as</span> utils


<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">,</span> load_pretrain_weights<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 注意，这里的backbone默认使用的是FrozenBatchNorm2d，即不会去更新bn参数</span>
    <span class="token comment"># 目的是为了防止batch_size太小导致效果更差(如果显存很小，建议使用默认的FrozenBatchNorm2d)</span>
    <span class="token comment"># 如果GPU显存很大可以设置比较大的batch_size就可以将norm_layer设置为普通的BatchNorm2d</span>
    <span class="token comment"># trainable_layers包括['layer4', 'layer3', 'layer2', 'layer1', 'conv1']， 5代表全部训练</span>
    <span class="token comment"># resnet50 imagenet weights url: https://download.pytorch.org/models/resnet50-0676ba61.pth</span>
    backbone <span class="token operator">=</span> resnet50_fpn_backbone<span class="token punctuation">(</span>pretrain_path<span class="token operator">=</span><span class="token string">"./backbone/resnet50.pth"</span><span class="token punctuation">,</span>
                                     norm_layer<span class="token operator">=</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">,</span>
                                     trainable_layers<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练自己数据集时不要修改这里的91，修改的是传入的num_classes参数</span>
    model <span class="token operator">=</span> FasterRCNN<span class="token punctuation">(</span>backbone<span class="token operator">=</span>backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">91</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> load_pretrain_weights<span class="token punctuation">:</span>
        <span class="token comment"># 载入预训练模型权重</span>
        <span class="token comment"># https://download.pytorch.org/models/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth</span>
        weights_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./backbone/fasterrcnn_resnet50_fpn_coco.pth"</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
        missing_keys<span class="token punctuation">,</span> unexpected_keys <span class="token operator">=</span> model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>weights_dict<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>missing_keys<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>unexpected_keys<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"missing_keys: "</span><span class="token punctuation">,</span> missing_keys<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"unexpected_keys: "</span><span class="token punctuation">,</span> unexpected_keys<span class="token punctuation">)</span>

    <span class="token comment"># get number of input features for the classifier</span>
    in_features <span class="token operator">=</span> model<span class="token punctuation">.</span>roi_heads<span class="token punctuation">.</span>box_predictor<span class="token punctuation">.</span>cls_score<span class="token punctuation">.</span>in_features
    <span class="token comment"># replace the pre-trained head with a new one</span>
    model<span class="token punctuation">.</span>roi_heads<span class="token punctuation">.</span>box_predictor <span class="token operator">=</span> FastRCNNPredictor<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>args<span class="token punctuation">.</span>device <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using &#123;&#125; device training."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 用来保存coco_info的文件</span>
    results_file <span class="token operator">=</span> <span class="token string">"results&#123;&#125;.txt"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d-%H%M%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    data_transform <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    VOC_root <span class="token operator">=</span> args<span class="token punctuation">.</span>data_path
    <span class="token comment"># check voc root</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"VOCdevkit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> FileNotFoundError<span class="token punctuation">(</span><span class="token string">"VOCdevkit dose not in path:'&#123;&#125;'."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>VOC_root<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># load train data set</span>
    <span class="token comment"># VOCdevkit -> VOC2012 -> ImageSets -> Main -> train.txt</span>
    train_dataset <span class="token operator">=</span> VOCDataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"train.txt"</span><span class="token punctuation">)</span>
    train_sampler <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 是否按图片相似高宽比采样图片组成batch</span>
    <span class="token comment"># 使用的话能够减小训练时所需GPU显存，默认使用</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>aspect_ratio_group_factor <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        train_sampler <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>RandomSampler<span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span>
        <span class="token comment"># 统计所有图像高宽比例在bins区间中的位置索引</span>
        group_ids <span class="token operator">=</span> create_aspect_ratio_groups<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> k<span class="token operator">=</span>args<span class="token punctuation">.</span>aspect_ratio_group_factor<span class="token punctuation">)</span>
        <span class="token comment"># 每个batch图片从同一高宽比例区间中取</span>
        train_batch_sampler <span class="token operator">=</span> GroupedBatchSampler<span class="token punctuation">(</span>train_sampler<span class="token punctuation">,</span> group_ids<span class="token punctuation">,</span> args<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>

    <span class="token comment"># 注意这里的collate_fn是自定义的，因为读取的数据包括image和targets，不能直接使用默认的方法合成batch</span>
    batch_size <span class="token operator">=</span> args<span class="token punctuation">.</span>batch_size
    nw <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size <span class="token keyword">if</span> batch_size <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># number of workers</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using %g dataloader workers'</span> <span class="token operator">%</span> nw<span class="token punctuation">)</span>
    <span class="token keyword">if</span> train_sampler<span class="token punctuation">:</span>
        <span class="token comment"># 如果按照图片高宽比采样图片，dataloader中需要使用batch_sampler</span>
        train_data_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span>
                                                        batch_sampler<span class="token operator">=</span>train_batch_sampler<span class="token punctuation">,</span>
                                                        pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                        collate_fn<span class="token operator">=</span>train_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        train_data_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span>
                                                        batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                                        shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                        num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                        collate_fn<span class="token operator">=</span>train_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># load validation data set</span>
    <span class="token comment"># VOCdevkit -> VOC2012 -> ImageSets -> Main -> val.txt</span>
    val_dataset <span class="token operator">=</span> VOCDataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"val"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"val.txt"</span><span class="token punctuation">)</span>
    val_data_set_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span>
                                                      batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                                      shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                                      pin_memory<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                      num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                                      collate_fn<span class="token operator">=</span>val_dataset<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># create model num_classes equal background + 20 classes</span>
    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>args<span class="token punctuation">.</span>num_classes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># print(model)</span>

    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># define optimizer</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">]</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span>
                                lr<span class="token operator">=</span>args<span class="token punctuation">.</span>lr<span class="token punctuation">,</span>
                                momentum<span class="token operator">=</span>args<span class="token punctuation">.</span>momentum<span class="token punctuation">,</span>
                                weight_decay<span class="token operator">=</span>args<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>

    scaler <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>amp <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token comment"># learning rate scheduler</span>
    lr_scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span>
                                                   step_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                                                   gamma<span class="token operator">=</span><span class="token number">0.33</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果指定了上次训练保存的权重文件地址，则接着上次结果接着训练</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>resume <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span>
        checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>args<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        lr_scheduler<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'lr_scheduler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        args<span class="token punctuation">.</span>start_epoch <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>amp <span class="token keyword">and</span> <span class="token string">"scaler"</span> <span class="token keyword">in</span> checkpoint<span class="token punctuation">:</span>
            scaler<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">"scaler"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the training process from epoch&#123;&#125;..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>start_epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    learning_rate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>start_epoch<span class="token punctuation">,</span> args<span class="token punctuation">.</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># train for one epoch, printing every 10 iterations</span>
        mean_loss<span class="token punctuation">,</span> lr <span class="token operator">=</span> utils<span class="token punctuation">.</span>train_one_epoch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> train_data_loader<span class="token punctuation">,</span>
                                              device<span class="token operator">=</span>device<span class="token punctuation">,</span> epoch<span class="token operator">=</span>epoch<span class="token punctuation">,</span>
                                              print_freq<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> warmup<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                              scaler<span class="token operator">=</span>scaler<span class="token punctuation">)</span>
        train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        learning_rate<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lr<span class="token punctuation">)</span>

        <span class="token comment"># update the learning rate</span>
        lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># evaluate on the test dataset</span>
        coco_info <span class="token operator">=</span> utils<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> val_data_set_loader<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        <span class="token comment"># write into txt</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>results_file<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token comment"># 写入的数据包括coco指标还有loss和learning rate</span>
            result_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> coco_info <span class="token operator">+</span> <span class="token punctuation">[</span>mean_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>lr<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">]</span>
            txt <span class="token operator">=</span> <span class="token string">"epoch:&#123;&#125; &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>result_info<span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>txt <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

        val_map<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coco_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># pascal mAP</span>

        <span class="token comment"># save weights</span>
        save_files <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'model'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'lr_scheduler'</span><span class="token punctuation">:</span> lr_scheduler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>amp<span class="token punctuation">:</span>
            save_files<span class="token punctuation">[</span><span class="token string">"scaler"</span><span class="token punctuation">]</span> <span class="token operator">=</span> scaler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_files<span class="token punctuation">,</span> <span class="token string">"./save_weights/resNetFpn-model-&#123;&#125;.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># plot loss and lr curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>learning_rate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_loss_and_lr
        plot_loss_and_lr<span class="token punctuation">(</span>train_loss<span class="token punctuation">,</span> learning_rate<span class="token punctuation">)</span>

    <span class="token comment"># plot mAP curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_map<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_map
        plot_map<span class="token punctuation">(</span>val_map<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> argparse

    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>
        description<span class="token operator">=</span>__doc__<span class="token punctuation">)</span>

    <span class="token comment"># 训练设备类型</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'device'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练数据集的根目录(VOCdevkit)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data-path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'dataset'</span><span class="token punctuation">)</span>
    <span class="token comment"># 检测目标类别数(不包含背景)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--num-classes'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'num_classes'</span><span class="token punctuation">)</span>
    <span class="token comment"># 文件保存地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--output-dir'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./save_weights'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path where to save'</span><span class="token punctuation">)</span>
    <span class="token comment"># 若需要接着上次训练，则指定上次训练保存权重文件地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume from checkpoint'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定接着从哪个epoch数开始训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--start_epoch'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'start epoch'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的总epoch数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of total epochs to run'</span><span class="token punctuation">)</span>
    <span class="token comment"># 学习率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--lr'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'initial learning rate, 0.02 is the default value for training '</span>
                             <span class="token string">'on 8 gpus and 2 images_per_gpu'</span><span class="token punctuation">)</span>
    <span class="token comment"># SGD的momentum参数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--momentum'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'M'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'momentum'</span><span class="token punctuation">)</span>
    <span class="token comment"># SGD的weight_decay参数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--wd'</span><span class="token punctuation">,</span> <span class="token string">'--weight-decay'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        metavar<span class="token operator">=</span><span class="token string">'W'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'weight decay (default: 1e-4)'</span><span class="token punctuation">,</span>
                        dest<span class="token operator">=</span><span class="token string">'weight_decay'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的batch size</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'batch size when training.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--aspect-ratio-group-factor'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否使用混合精度训练(需要GPU支持混合精度)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--amp"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Use torch.cuda.amp for mixed precision training"</span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

    <span class="token comment"># 检查保存权重文件夹是否存在，不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span>

    main<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="dataloader中collate_fn的作用">0.10.1 DataLoader中collate_fn的作用</h3><p>1、使用Pytorch官方的<code>DataLoader</code>方法中传入参数<code>collate_fn=train_dataset.collate_fn</code>的作用</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 会将正</span>
<span class="token decorator annotation punctuation">@staticmethod</span>
<span class="token keyword">def</span> <span class="token function">collate_fn</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>batch<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>输入是一个list，包含有8个tuple（batch大小）的图像数据，每个tuple包含图像和图像标签信息（与dataset返回的image和target相同）</p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151441527.png" style="zoom:67%"></p><p>输出，将8个tuple拆开，将图像放在一起，将图像标签信息放在一起</p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151443720.png" style="zoom:67%"></p></blockquote><h2 id="预测predict.py">0.1 预测predict.py</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json

<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> network_files <span class="token keyword">import</span> FasterRCNN<span class="token punctuation">,</span> FastRCNNPredictor<span class="token punctuation">,</span> AnchorsGenerator
<span class="token keyword">from</span> backbone <span class="token keyword">import</span> resnet50_fpn_backbone<span class="token punctuation">,</span> MobileNetV2
<span class="token keyword">from</span> draw_box_utils <span class="token keyword">import</span> draw_objs


<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># mobileNetv2+faster_RCNN</span>
    <span class="token comment"># backbone = MobileNetV2().features</span>
    <span class="token comment"># backbone.out_channels = 1280</span>
    <span class="token comment">#</span>
    <span class="token comment"># anchor_generator = AnchorsGenerator(sizes=((32, 64, 128, 256, 512),),</span>
    <span class="token comment">#                                     aspect_ratios=((0.5, 1.0, 2.0),))</span>
    <span class="token comment">#</span>
    <span class="token comment"># roi_pooler = torchvision.ops.MultiScaleRoIAlign(featmap_names=['0'],</span>
    <span class="token comment">#                                                 output_size=[7, 7],</span>
    <span class="token comment">#                                                 sampling_ratio=2)</span>
    <span class="token comment">#</span>
    <span class="token comment"># model = FasterRCNN(backbone=backbone,</span>
    <span class="token comment">#                    num_classes=num_classes,</span>
    <span class="token comment">#                    rpn_anchor_generator=anchor_generator,</span>
    <span class="token comment">#                    box_roi_pool=roi_pooler)</span>

    <span class="token comment"># resNet50+fpn+faster_RCNN</span>
    <span class="token comment"># 注意，这里的norm_layer要和训练脚本中保持一致</span>
    backbone <span class="token operator">=</span> resnet50_fpn_backbone<span class="token punctuation">(</span>norm_layer<span class="token operator">=</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span>
    model <span class="token operator">=</span> FasterRCNN<span class="token punctuation">(</span>backbone<span class="token operator">=</span>backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span> rpn_score_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">time_synchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>synchronize<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get devices</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"using &#123;&#125; device."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create model</span>
    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">)</span>

    <span class="token comment"># load train weights</span>
    weights_path <span class="token operator">=</span> <span class="token string">"./save_weights/model.pth"</span>
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>weights_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&#123;&#125; file dose not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>weights_path<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>weights_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"model"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># read class_indict</span>
    label_json_path <span class="token operator">=</span> <span class="token string">'./pascal_voc_classes.json'</span>
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>label_json_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"json file &#123;&#125; dose not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label_json_path<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>label_json_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        class_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    category_index <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>

    <span class="token comment"># load image</span>
    original_img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./test.jpg"</span><span class="token punctuation">)</span>

    <span class="token comment"># from pil image to tensor, do not normalize image</span>
    data_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> data_transform<span class="token punctuation">(</span>original_img<span class="token punctuation">)</span>
    <span class="token comment"># expand batch dimension</span>
    img <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>img<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 进入验证模式</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># init</span>
        img_height<span class="token punctuation">,</span> img_width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        init_img <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        model<span class="token punctuation">(</span>init_img<span class="token punctuation">)</span>

        t_start <span class="token operator">=</span> time_synchronized<span class="token punctuation">(</span><span class="token punctuation">)</span>
        predictions <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        t_end <span class="token operator">=</span> time_synchronized<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"inference+NMS time: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t_end <span class="token operator">-</span> t_start<span class="token punctuation">)</span><span class="token punctuation">)</span>

        predict_boxes <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        predict_classes <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        predict_scores <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"scores"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>predict_boxes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"没有检测到任何目标!"</span><span class="token punctuation">)</span>

        plot_img <span class="token operator">=</span> draw_objs<span class="token punctuation">(</span>original_img<span class="token punctuation">,</span>
                             predict_boxes<span class="token punctuation">,</span>
                             predict_classes<span class="token punctuation">,</span>
                             predict_scores<span class="token punctuation">,</span>
                             category_index<span class="token operator">=</span>category_index<span class="token punctuation">,</span>
                             box_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                             line_thickness<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                             font<span class="token operator">=</span><span class="token string">'arial.ttf'</span><span class="token punctuation">,</span>
                             font_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>plot_img<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 保存预测的图片结果</span>
        plot_img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"test_result.jpg"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="自定义dataset">1. 自定义Dataset</h1><p>参考：PyTorch官方https://pytorch.org/tutorials/intermediate/torchvision_tutorial.html</p><p><strong>Defining the Dataset</strong></p><p>The reference scripts for training object detection, instance segmentation and person keypoint detection allows for easily supporting adding new custom datasets. The dataset should inherit from the standard <code>torch.utils.data.Dataset</code> class, and implement <code>__len__</code> and <code>__getitem__</code>.</p><blockquote><p>用于训练对象检测、实例分割和人物关键点检测的参考脚本允许轻松支持添加新的自定义数据集。 数据集应该从标准的<code>torch.utils.data.Dataset</code>类继承，并实现<code>__len__</code>和<code>__getitem__</code>。</p><ul><li><code>__len__</code>：获取数据集长度</li><li><code>__getitem__</code>：返回图片和信息</li></ul></blockquote><p>The only specificity that we require is that the dataset <code>__getitem__</code> should return:</p><ul><li>image: a PIL Image of size <code>(H, W)</code></li><li>target: a dict containing the following fields<ul><li><code>boxes (FloatTensor[N, 4])</code>: the coordinates of the <code>N</code> bounding boxes in <code>[x0, y0, x1, y1]</code> format, ranging from <code>0</code> to <code>W</code> and <code>0</code> to <code>H</code></li><li><code>labels (Int64Tensor[N])</code>: the label for each bounding box. <code>0</code> represents always the background class.</li><li><code>image_id (Int64Tensor[1])</code>: an image identifier. It should be unique between all the images in the dataset, and is used during evaluation</li><li><code>area (Tensor[N])</code>: The area of the bounding box. This is used during evaluation with the COCO metric, to separate the metric scores between small, medium and large boxes.</li><li><code>iscrowd (UInt8Tensor[N])</code>: instances with iscrowd=True will be ignored during evaluation.</li><li>(optionally) <code>masks (UInt8Tensor[N, H, W])</code>: The segmentation masks for each one of the objects</li><li>(optionally) <code>keypoints (FloatTensor[N, K, 3])</code>: For each one of the N objects, it contains the K keypoints in <code>[x, y, visibility]</code> format, defining the object. visibility=0 means that the keypoint is not visible. Note that for data augmentation, the notion of flipping a keypoint is dependent on the data representation, and you should probably adapt <code>references/detection/transforms.py</code> for your new keypoint representation</li></ul></li></ul><p>If your model returns the above methods, they will make it work for both training and evaluation, and will use the evaluation scripts from <code>pycocotools</code> which can be installed with <code>pip install pycocotools</code>.</p><blockquote><p>Additionally, if you want to use aspect ratio grouping during training (so that each batch only contains images with similar aspect ratios), then it is recommended to also implement a <code>get_height_and_width</code> method, which returns the height and the width of the image. If this method is not provided, we query all elements of the dataset via <code>__getitem__</code>, which loads the image in memory and is slower than if a custom method is provided. 另外，如果你想在训练时使用长宽比分组（这样每批只包含长宽比相似的图像），那么建议也实现一个 get_height_and_width 方法，它返回图像的高度和宽度。 如果没有提供这个方法，我们会通过<code>__getitem__</code>查询数据集的所有元素，这会将图像加载到内存中，并且比提供自定义方法要慢。</p></blockquote><h2 id="自定义dataset代码">1.1 自定义dataset代码</h2><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151346172.png"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree


<span class="token keyword">class</span> <span class="token class-name">VOCDataSet</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""读取解析PASCAL VOC2007/2012数据集"""</span>

    <span class="token comment"># init ==> 数据集根目录，数据增广方式，训练集还是验证集</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voc_root<span class="token punctuation">,</span> year<span class="token operator">=</span><span class="token string">"2012"</span><span class="token punctuation">,</span> transforms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> txt_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"train.txt"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> year <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"2007"</span><span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"year must be in ['2007', '2012']"</span>
        <span class="token comment"># 增加容错能力</span>
        <span class="token keyword">if</span> <span class="token string">"VOCdevkit"</span> <span class="token keyword">in</span> voc_root<span class="token punctuation">:</span> <span class="token comment"># 数据集根目录</span>
            self<span class="token punctuation">.</span>root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>voc_root<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"VOC</span><span class="token interpolation"><span class="token punctuation">&#123;</span>year<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>voc_root<span class="token punctuation">,</span> <span class="token string">"VOCdevkit"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"VOC</span><span class="token interpolation"><span class="token punctuation">&#123;</span>year<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>img_root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"JPEGImages"</span><span class="token punctuation">)</span> <span class="token comment"># 图像根目录目录</span>
        self<span class="token punctuation">.</span>annotations_root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"Annotations"</span><span class="token punctuation">)</span> <span class="token comment"># 标签根目录</span>

        <span class="token comment"># 读取训练集和验证集所有图片文件read train.txt or val.txt file</span>
        txt_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"ImageSets"</span><span class="token punctuation">,</span> <span class="token string">"Main"</span><span class="token punctuation">,</span> txt_name<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"not found &#123;&#125; file."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>txt_name<span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span> <span class="token keyword">as</span> read<span class="token punctuation">:</span>
            xml_list <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>annotations_root<span class="token punctuation">,</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".xml"</span><span class="token punctuation">)</span>
                        <span class="token keyword">for</span> line <span class="token keyword">in</span> read<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">]</span>
		
        <span class="token comment">#  ----------------------------------------------------------------------</span>
        self<span class="token punctuation">.</span>xml_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 对文件进行检查，然后放入self.xml_list中 check file</span>
        <span class="token keyword">for</span> xml_path <span class="token keyword">in</span> xml_list<span class="token punctuation">:</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Warning: not found '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>xml_path<span class="token punctuation">&#125;</span></span><span class="token string">', skip this annotation file."</span></span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token comment"># check for targets</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
                xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token string">"object"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"INFO: no objects in </span><span class="token interpolation"><span class="token punctuation">&#123;</span>xml_path<span class="token punctuation">&#125;</span></span><span class="token string">, skip this annotation file."</span></span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token comment"># xml_list第i位存放第i号图片信息的全路径名</span>
            self<span class="token punctuation">.</span>xml_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span>

        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>xml_list<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"in '&#123;&#125;' file does not find any information."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span>

        <span class="token comment">#  -----------------------------------------------------------------------</span>
        <span class="token comment"># 读取类别对应索引的那个文件 read class_indict</span>
        json_file <span class="token operator">=</span> <span class="token string">'./pascal_voc_classes.json'</span>
        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>json_file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&#123;&#125; file not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>json_file<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>class_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>transforms <span class="token operator">=</span> transforms

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>xml_list<span class="token punctuation">)</span>

    <span class="token comment"># getitem方法需要传入索引值，根据索引值返回图片以及图片信息</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 读取xml文件 read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        
       	<span class="token comment"># 将xml文件解析成字典形式（先序遍历方式），参考tensorflow的recursive_parse_xml_to_dict</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        
        
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_root<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> image<span class="token punctuation">.</span><span class="token builtin">format</span> <span class="token operator">!=</span> <span class="token string">"JPEG"</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Image '&#123;&#125;' format not JPEG"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        iscrowd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">assert</span> <span class="token string">"object"</span> <span class="token keyword">in</span> data<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; lack of object information."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"object"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            xmin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            xmax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ymin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ymax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment"># 进一步检查数据，有的标注信息中可能有w或h为0的情况，这样的数据会导致计算回归loss为nan</span>
            <span class="token keyword">if</span> xmax <span class="token operator">&lt;=</span> xmin <span class="token keyword">or</span> ymax <span class="token operator">&lt;=</span> ymin<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Warning: in '&#123;&#125;' xml, there are some bbox w/h &lt;=0"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_dict<span class="token punctuation">[</span>obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"difficult"</span> <span class="token keyword">in</span> obj<span class="token punctuation">:</span>
                iscrowd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"difficult"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                iscrowd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># convert everything into a torch.Tensor</span>
        boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        iscrowd <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>iscrowd<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        image_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
        target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
        target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transforms <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image<span class="token punctuation">,</span> target <span class="token operator">=</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">(</span>image<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target

    <span class="token keyword">def</span> <span class="token function">get_height_and_width</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        data_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        data_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data_height<span class="token punctuation">,</span> data_width

    <span class="token keyword">def</span> <span class="token function">parse_xml_to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> xml<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将xml文件解析成字典形式，参考tensorflow的recursive_parse_xml_to_dict
        Args:
            xml: xml tree obtained by parsing XML file contents using lxml.etree

        Returns:
            Python dictionary holding XML contents.
        """</span>
		<span class="token comment"># 先序遍历方式</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历到底层，直接返回tag对应的信息</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> xml<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span>

        result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> child <span class="token keyword">in</span> xml<span class="token punctuation">:</span>
            child_result <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>child<span class="token punctuation">)</span>  <span class="token comment"># 递归遍历标签信息</span>
            <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token operator">!=</span> <span class="token string">'object'</span><span class="token punctuation">:</span>
                result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>  <span class="token comment"># 因为object可能有多个，所以需要放入列表里</span>
                    result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> result<span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">coco_index</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        该方法是专门为pycocotools统计标签信息准备，不对图像和标签作任何处理
        由于不用去读取图片，可大幅缩减统计时间

        Args:
            idx: 输入需要获取图像的索引
        """</span>
        <span class="token comment"># read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        data_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        data_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># img_path = os.path.join(self.img_root, data["filename"])</span>
        <span class="token comment"># image = Image.open(img_path)</span>
        <span class="token comment"># if image.format != "JPEG":</span>
        <span class="token comment">#     raise ValueError("Image format not JPEG")</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        iscrowd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"object"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            xmin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            xmax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ymin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ymax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_dict<span class="token punctuation">[</span>obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            iscrowd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"difficult"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># convert everything into a torch.Tensor</span>
        boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        iscrowd <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>iscrowd<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        image_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
        target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
        target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd

        <span class="token keyword">return</span> <span class="token punctuation">(</span>data_height<span class="token punctuation">,</span> data_width<span class="token punctuation">)</span><span class="token punctuation">,</span> target

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">collate_fn</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>batch<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># import transforms</span>
<span class="token comment"># from draw_box_utils import draw_objs</span>
<span class="token comment"># from PIL import Image</span>
<span class="token comment"># import json</span>
<span class="token comment"># import matplotlib.pyplot as plt</span>
<span class="token comment"># import torchvision.transforms as ts</span>
<span class="token comment"># import random</span>
<span class="token comment">#</span>
<span class="token comment"># # read class_indict</span>
<span class="token comment"># category_index = &#123;&#125;</span>
<span class="token comment"># try:</span>
<span class="token comment">#     json_file = open('./pascal_voc_classes.json', 'r')</span>
<span class="token comment">#     class_dict = json.load(json_file)</span>
<span class="token comment">#     category_index = &#123;str(v): str(k) for k, v in class_dict.items()&#125;</span>
<span class="token comment"># except Exception as e:</span>
<span class="token comment">#     print(e)</span>
<span class="token comment">#     exit(-1)</span>
<span class="token comment">#</span>
<span class="token comment"># data_transform = &#123;</span>
<span class="token comment">#     "train": transforms.Compose([transforms.ToTensor(),</span>
<span class="token comment">#                                  transforms.RandomHorizontalFlip(0.5)]),</span>
<span class="token comment">#     "val": transforms.Compose([transforms.ToTensor()])</span>
<span class="token comment"># &#125;</span>
<span class="token comment">#</span>
<span class="token comment"># # load train data set</span>
<span class="token comment"># train_data_set = VOCDataSet(os.getcwd(), "2012", data_transform["train"], "train.txt")</span>
<span class="token comment"># print(len(train_data_set))</span>
<span class="token comment"># for index in random.sample(range(0, len(train_data_set)), k=5):</span>
<span class="token comment">#     img, target = train_data_set[index]</span>
<span class="token comment">#     img = ts.ToPILImage()(img)</span>
<span class="token comment">#     plot_img = draw_objs(img,</span>
<span class="token comment">#                          target["boxes"].numpy(),</span>
<span class="token comment">#                          target["labels"].numpy(),</span>
<span class="token comment">#                          np.ones(target["labels"].shape[0]),</span>
<span class="token comment">#                          category_index=category_index,</span>
<span class="token comment">#                          box_thresh=0.5,</span>
<span class="token comment">#                          line_thickness=3,</span>
<span class="token comment">#                          font='arial.ttf',</span>
<span class="token comment">#                          font_size=20)</span>
<span class="token comment">#     plt.imshow(plot_img)</span>
<span class="token comment">#     plt.show()</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>补充：</p><p><strong>1、制作完自己的VOC格式数据集后将数据集划分为训练集和验证集的代码</strong></p><ul><li>将文件放在VOCdevkit，然后编写程序按某种比例生成对应的train.txt和val.txt</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 设置随机种子，保证随机结果可复现</span>

    <span class="token comment"># 所标注的xml根目录</span>
    files_path <span class="token operator">=</span> <span class="token string">"./VOCdevkit/VOC2012/Annotations"</span> 
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>files_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"path: '&#123;&#125;' does not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>files_path<span class="token punctuation">)</span>

    val_rate <span class="token operator">=</span> <span class="token number">0.5</span>

    <span class="token comment"># 遍历获得所有xml注解的文件名</span>
    files_name <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>files_path<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    files_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files_name<span class="token punctuation">)</span> <span class="token comment"># 得到数量</span>
    <span class="token comment"># 随机采样一部分作为验证集</span>
    val_index <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> files_num<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>files_num<span class="token operator">*</span>val_rate<span class="token punctuation">)</span><span class="token punctuation">)</span>
    train_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 遍历所有文件名，区分出属于训练集、验证集的文件名list</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> file_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>files_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> index <span class="token keyword">in</span> val_index<span class="token punctuation">:</span>
            val_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            train_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>

    <span class="token comment"># 打开写入train.txt和val.txt</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        train_f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"train.txt"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span>
        eval_f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"val.txt"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span>
        train_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>train_files<span class="token punctuation">)</span><span class="token punctuation">)</span>
        eval_f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>val_files<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> FileExistsError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2、</strong><code>getitem</code><strong>方法中的读取图像注释文件的代码</strong></p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151400356.png" style="zoom:67%"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"># 将xml文件解析成字典形式</span>
    data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
	<span class="token comment"># 读标签获得图片文件名信息</span>
    img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_root<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
    
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    iscrowd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"object"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token comment"># 获得真实box信息</span>
        xmin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xmax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ymin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ymax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 真实物体位置box</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
        labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_dict<span class="token punctuation">[</span>obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># convert everything into a torch.Tensor</span>
    boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
    iscrowd <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>iscrowd<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
    image_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
    area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    target <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment"># 字典，存放图片的annotation信息</span>
    target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
    target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
    target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
    target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
    target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>transforms <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        image<span class="token punctuation">,</span> target <span class="token operator">=</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">(</span>image<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

    <span class="token keyword">return</span> image<span class="token punctuation">,</span> target

<span class="token keyword">def</span> <span class="token function">parse_xml_to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> xml<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 将xml文件解析成字典形式，参考tensorflow的recursive_parse_xml_to_dict</span>


    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历到底层，直接返回tag对应的信息</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> xml<span class="token punctuation">.</span>text<span class="token punctuation">&#125;</span>

    result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> child <span class="token keyword">in</span> xml<span class="token punctuation">:</span>
        child_result <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>child<span class="token punctuation">)</span>  <span class="token comment"># 递归遍历标签信息</span>
        <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token operator">!=</span> <span class="token string">'object'</span><span class="token punctuation">:</span>
            result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>  <span class="token comment"># 因为object可能有多个，所以需要放入列表里</span>
                result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> result<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3、如果图片数据增广应用了水平翻转</p><ul><li><strong>反转之后y轴不会变，只要调整调整<span class="math inline">\(x_{min}\)</span>和<span class="math inline">\(x_{max}\)</span></strong> ==&gt; 例如<span class="math inline">\(x_{min}\)</span>= 图像宽度- 原图到<span class="math inline">\(x_{min}\)</span>的位置</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RandomHorizontalFlip</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""随机水平翻转图像以及bboxes"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>prob <span class="token operator">=</span> prob

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>prob<span class="token punctuation">:</span>
            height<span class="token punctuation">,</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment"># 获取图像的高和宽</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 水平翻转图片</span>
            bbox <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
            <span class="token comment"># bbox: xmin, ymin, xmax, ymax</span>
            bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> width <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 翻转对应bbox坐标信息</span>
            target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> bbox
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151409516.png"></p><hr><h2 id="自定义transform">1.2 自定义transform</h2><p>在训练时只使用了随机旋转，但是要注意，图片旋转了，标注框的位置也需要旋转</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> functional <span class="token keyword">as</span> F


<span class="token keyword">class</span> <span class="token class-name">Compose</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""组合多个transform函数"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transforms<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>transforms <span class="token operator">=</span> transforms

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">:</span>
            image<span class="token punctuation">,</span> target <span class="token operator">=</span> t<span class="token punctuation">(</span>image<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target


<span class="token keyword">class</span> <span class="token class-name">ToTensor</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""将PIL图像转为Tensor"""</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> F<span class="token punctuation">.</span>to_tensor<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target


<span class="token keyword">class</span> <span class="token class-name">RandomHorizontalFlip</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""随机水平翻转图像以及bboxes"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>prob <span class="token operator">=</span> prob

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>prob<span class="token punctuation">:</span>
            height<span class="token punctuation">,</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 水平翻转图片</span>
            bbox <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
            <span class="token comment"># bbox: xmin, ymin, xmax, ymax</span>
            bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> width <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 翻转对应bbox坐标信息</span>
            target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> bbox
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自定义dataset的重点">1.3 自定义Dataset的重点</h2><ol type="1"><li><p>首先明白自定义Dataset需要：</p><ol type="1"><li>写一个类并继承自<code>torch.utils.data.Dataset</code></li><li>实现<code>__len__</code>方法（标注文件个数 = 训练文件个数）</li><li>实现<code>__getitem__</code>方法（返回值 ①image；②target）<ol type="1"><li><code>image</code>：就是根据路径使用PIL加载图片并返回</li><li><code>target</code>：对于VOC 2012数据集，包含下面内容：<ol type="1"><li>bbox（GT）的坐标 <strong>-&gt; 转换为tensor</strong></li><li>目标类别的索引值（1， 2， 3，…） <strong>-&gt; 转换为tensor</strong></li><li>图片的 id</li><li>bbox（GT）的面积</li><li>训练是否困难（0表示容易；1表示困难） <strong>-&gt; 转换为tensor</strong></li></ol></li></ol></li><li>[可选] 实现<code>__get_height_and_width__</code>方法（对于VOC 2012数据集可根据annotation中的信息可以直接获取）</li></ol></li><li><p>使用<code>line.strip()</code>方法将换行符去掉</p></li><li><p>列表表达式和字典表达式的使用</p></li><li><p>读取<code>.xml</code>文件的步骤</p><ol type="1"><li>先将<code>.xml</code>文件写进内存</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
    xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 读取标注文件的每一行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol type="1"><li>使用<code>etree.fromstring()</code>将内存中的<code>xml</code>对象转换为<code>Element</code>对象</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python">xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol type="1"><li>将<code>xml</code>解析为字典形式并褪去最外面的字典壳</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python">data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样就可以得到我们想要的字典了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"folder"</span><span class="token punctuation">:</span> <span class="token string">"VOC2012"</span><span class="token punctuation">,</span>
<span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token string">"2007_000063.jpg"</span><span class="token punctuation">,</span>
<span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"database"</span><span class="token punctuation">:</span> <span class="token string">"The VOC2007 Database"</span><span class="token punctuation">,</span> <span class="token string">"annotation"</span><span class="token punctuation">:</span> <span class="token string">"PASCAL VOC2007"</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"flickr"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">:</span> <span class="token string">'375'</span><span class="token punctuation">,</span> <span class="token string">"depth"</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token string">"segmented"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token string">"object"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"dog"</span><span class="token punctuation">,</span> <span class="token string">"pose"</span><span class="token punctuation">:</span> <span class="token string">"Unspecified"</span><span class="token punctuation">,</span> <span class="token string">"truncated"</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">"difficult"</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">"bndbox"</span><span class="token punctuation">:</span> 
                                                        <span class="token punctuation">&#123;</span><span class="token string">"xmin"</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">"ymin"</span><span class="token punctuation">:</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token string">"xmax"</span><span class="token punctuation">:</span> <span class="token string">'379'</span><span class="token punctuation">,</span> <span class="token string">"ymax"</span><span class="token punctuation">:</span> <span class="token string">'275'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token string">"object"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"chair"</span><span class="token punctuation">,</span> <span class="token string">"pose"</span><span class="token punctuation">:</span> <span class="token string">"Frontal"</span><span class="token punctuation">,</span> <span class="token string">"truncated"</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">"difficult"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"bndbox"</span><span class="token punctuation">:</span> 
                                                        <span class="token punctuation">&#123;</span><span class="token string">"xmin"</span><span class="token punctuation">:</span> <span class="token string">'75'</span><span class="token punctuation">,</span> <span class="token string">"ymin"</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">"xmax"</span><span class="token punctuation">:</span> <span class="token string">'428'</span><span class="token punctuation">,</span> <span class="token string">"ymax"</span><span class="token punctuation">:</span> <span class="token string">'375'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
Note<span class="token punctuation">:</span> 这样解析后，所有的值的数据类型均为<span class="token builtin">str</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对于VOC来说，根据标注信息中的坐标计算面积公式如下：</p><ul><li><span class="math inline">\({area} = (y_{\mathrm{max}} - y_{\mathrm{min}}) * (x_{\mathrm{max}} - x_{\mathrm{min}})\)</span></li></ul></li><li><p><code>random.sample(range(0, len(train_data_set)), k=5)</code></p></li><li><p><code>.xml</code>的子父节点</p></li><li><p><code>torchvision.transforms.ToPILImage()(img)</code> 将tensor格式的图片转化为PIL的图片格式</p></li></ol><hr><h2 id="测试自定义的dataset并查看图片">1.4 测试自定义的Dataset并查看图片</h2><ul><li><code>draw_objs</code>在draw_box_utils.py文件中，参考Pytorch官方的绘图</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> transforms
<span class="token keyword">from</span> draw_box_utils <span class="token keyword">import</span> draw_objs
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> json
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> ts
<span class="token keyword">import</span> random

<span class="token comment"># read class_indict</span>
category_index <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    json_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./pascal_voc_classes.json'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
    class_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>json_file<span class="token punctuation">)</span>
    category_index <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

data_transform <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># load train data set</span>
train_data_set <span class="token operator">=</span> VOCDataSet<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"2012"</span><span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"train.txt"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_data_set<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> index <span class="token keyword">in</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_data_set<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    img<span class="token punctuation">,</span> target <span class="token operator">=</span> train_data_set<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    img <span class="token operator">=</span> ts<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    plot_img <span class="token operator">=</span> draw_objs<span class="token punctuation">(</span>img<span class="token punctuation">,</span>
                         target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         category_index<span class="token operator">=</span>category_index<span class="token punctuation">,</span>
                         box_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                         line_thickness<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                         font<span class="token operator">=</span><span class="token string">'arial.ttf'</span><span class="token punctuation">,</span>
                         font_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>plot_img<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211151424323.png" style="zoom:67%"></p><h1 id="faster-r-cnn架构图">2. Faster R-CNN架构图</h1><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211141028188.png" style="zoom:50%"></p><blockquote><p>其中黄色的框表示在训练中才会有的，预测时没有。</p></blockquote><p>文件地址：<code>network_files - faster_rcnn_framework.py</code></p><p>1、FasterRCNN BackBone：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FasterRCNNBase</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main class for Generalized R-CNN.

    Arguments:
        backbone (nn.Module):
        rpn (nn.Module):
        roi_heads (nn.Module): takes the features + the proposals from the RPN and computes
            detections / masks from it.
        transform (nn.Module): performs the data transformation from the inputs to feed into
            the model
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> backbone
        self<span class="token punctuation">.</span>rpn <span class="token operator">=</span> rpn
        self<span class="token punctuation">.</span>roi_heads <span class="token operator">=</span> roi_heads
        <span class="token comment"># used only on torchscript mode</span>
        self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>unused</span>
    <span class="token keyword">def</span> <span class="token function">eager_outputs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Dict[str, Tensor], List[Dict[str, Tensor]]) -> Union[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> losses

        <span class="token keyword">return</span> detections

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], Optional[List[Dict[str, Tensor]]]) -> Tuple[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> targets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"In training mode, targets should be passed"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">:</span>         <span class="token comment"># 进一步判断传入的target的boxes参数是否符合规定</span>
                boxes <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token keyword">or</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be a tensor"</span>
                                         <span class="token string">"of shape [N, 4], got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                                          boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be of type "</span>
                                     <span class="token string">"Tensor, got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        original_image_sizes <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">:</span>
            val <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>  <span class="token comment"># 防止输入的是个一维向量</span>
            original_image_sizes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># original_image_sizes = [img.shape[-2:] for img in images]</span>

        images<span class="token punctuation">,</span> targets <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>images<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>  <span class="token comment"># 对图像进行预处理</span>

        <span class="token comment"># print(images.tensors.shape)</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>images<span class="token punctuation">.</span>tensors<span class="token punctuation">)</span>  <span class="token comment"># 将图像输入backbone得到特征图</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 若只在一层特征层上预测，将feature放入有序字典中，并编号为‘0’</span>
            features <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> features<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 若在多层特征层上预测，传入的就是一个有序字典</span>

        <span class="token comment"># 将特征层以及标注target信息传入rpn中</span>
        <span class="token comment"># proposals: List[Tensor], Tensor_shape: [num_proposals, 4],</span>
        <span class="token comment"># 每个proposals是绝对坐标，且为(x1, y1, x2, y2)格式</span>
        proposals<span class="token punctuation">,</span> proposal_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 将rpn生成的数据以及标注target信息传入fast rcnn后半部分</span>
        detections<span class="token punctuation">,</span> detector_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>roi_heads<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 对网络的预测结果进行后处理（主要将bboxes还原到原图像尺度上）</span>
        detections <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>postprocess<span class="token punctuation">(</span>detections<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> original_image_sizes<span class="token punctuation">)</span>

        losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detector_losses<span class="token punctuation">)</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>proposal_losses<span class="token punctuation">)</span>

        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>is_scripting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_has_warned<span class="token punctuation">:</span>
                warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">"RCNN always returns a (Losses, Detections) tuple in scripting"</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">return</span> losses<span class="token punctuation">,</span> detections
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>eager_outputs<span class="token punctuation">(</span>losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span>

        <span class="token comment"># if self.training:</span>
        <span class="token comment">#     return losses</span>
        <span class="token comment">#</span>
        <span class="token comment"># return detections</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、Faster R-CNN模型</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FasterRCNN</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token comment"># transform parameter</span>
                 min_size<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1333</span><span class="token punctuation">,</span>      <span class="token comment"># 预处理resize时限制的最小尺寸与最大尺寸</span>
                 image_mean<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> image_std<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 预处理normalize时使用的均值和方差</span>
                 <span class="token comment"># RPN parameters</span>
                 rpn_anchor_generator<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> rpn_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 rpn_pre_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_pre_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment"># rpn中在nms处理前保留的proposal数(根据score)</span>
                 rpn_post_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_post_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中在nms处理后保留的proposal数</span>
                 rpn_nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中进行nms处理时使用的iou阈值</span>
                 rpn_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时，采集正负样本设置的阈值</span>
                 rpn_batch_size_per_image<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> rpn_positive_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时采样的样本数，以及正样本占总样本的比例</span>
                 rpn_score_thresh<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
                 <span class="token comment"># Box parameters</span>
                 box_roi_pool<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_predictor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token comment"># 移除低目标概率      fast rcnn中进行nms处理的阈值   对预测结果根据score排序取前100个目标</span>
                 box_score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span> box_nms_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_detections_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                 box_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>   <span class="token comment"># fast rcnn计算误差时，采集正负样本设置的阈值</span>
                 box_batch_size_per_image<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> box_positive_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># fast rcnn计算误差时采样的样本数，以及正样本占所有样本的比例</span>
                 bbox_reg_weights<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> <span class="token string">"out_channels"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                <span class="token string">"backbone should contain an attribute out_channels"</span>
                <span class="token string">"specifying the number of output channels  (assumed to be the"</span>
                <span class="token string">"same for all the levels"</span>
            <span class="token punctuation">)</span>

       	<span class="token comment"># 判断box_roi_pool和.是否为给定类型或者NULL，不是就报错</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>rpn_anchor_generator<span class="token punctuation">,</span> <span class="token punctuation">(</span>AnchorsGenerator<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>box_roi_pool<span class="token punctuation">,</span> <span class="token punctuation">(</span>MultiScaleRoIAlign<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> num_classes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should be None when box_predictor "</span>
                                 <span class="token string">"is specified"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should not be None when box_predictor "</span>
                                 <span class="token string">"is not specified"</span><span class="token punctuation">)</span>

        <span class="token comment"># 预测特征层的channels</span>
        out_channels <span class="token operator">=</span> backbone<span class="token punctuation">.</span>out_channels

        <span class="token comment"># 若anchor生成器为空，则自动生成针对resnet50_fpn的anchor生成器</span>
        <span class="token comment"># （mobilenetv2定义了anchor生成器anchor_generator = AnchorsGenerator，resnet50_fpn没有）</span>
        <span class="token keyword">if</span> rpn_anchor_generator <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            anchor_sizes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            aspect_ratios <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_sizes<span class="token punctuation">)</span>
            rpn_anchor_generator <span class="token operator">=</span> AnchorsGenerator<span class="token punctuation">(</span>
                anchor_sizes<span class="token punctuation">,</span> aspect_ratios
            <span class="token punctuation">)</span>

        <span class="token comment"># 生成RPN通过滑动窗口预测网络部分</span>
        <span class="token keyword">if</span> rpn_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            rpn_head <span class="token operator">=</span> RPNHead<span class="token punctuation">(</span>
                out_channels<span class="token punctuation">,</span> rpn_anchor_generator<span class="token punctuation">.</span>num_anchors_per_location<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># 默认rpn_pre_nms_top_n_train = 2000, rpn_pre_nms_top_n_test = 1000,</span>
        <span class="token comment"># 默认rpn_post_nms_top_n_train = 2000, rpn_post_nms_top_n_test = 1000,</span>
        rpn_pre_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_pre_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_pre_nms_top_n_test<span class="token punctuation">)</span>
        rpn_post_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_post_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_post_nms_top_n_test<span class="token punctuation">)</span>

        <span class="token comment"># 定义整个RPN框架</span>
        rpn <span class="token operator">=</span> RegionProposalNetwork<span class="token punctuation">(</span>
            rpn_anchor_generator<span class="token punctuation">,</span> rpn_head<span class="token punctuation">,</span>
            rpn_fg_iou_thresh<span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token punctuation">,</span>
            rpn_batch_size_per_image<span class="token punctuation">,</span> rpn_positive_fraction<span class="token punctuation">,</span>
            rpn_pre_nms_top_n<span class="token punctuation">,</span> rpn_post_nms_top_n<span class="token punctuation">,</span> rpn_nms_thresh<span class="token punctuation">,</span>
            score_thresh<span class="token operator">=</span>rpn_score_thresh<span class="token punctuation">)</span>

        <span class="token comment">#  Multi-scale RoIAlign pooling</span>
        <span class="token keyword">if</span> box_roi_pool <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            box_roi_pool <span class="token operator">=</span> MultiScaleRoIAlign<span class="token punctuation">(</span>
                featmap_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 在哪些特征层进行roi pooling</span>
                output_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                sampling_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># fast RCNN中roi pooling后的展平处理两个全连接层部分</span>
        <span class="token keyword">if</span> box_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            resolution <span class="token operator">=</span> box_roi_pool<span class="token punctuation">.</span>output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 默认等于7</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>
            box_head <span class="token operator">=</span> TwoMLPHead<span class="token punctuation">(</span>
                out_channels <span class="token operator">*</span> resolution <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span>
                representation_size
            <span class="token punctuation">)</span>

        <span class="token comment"># 在box_head的输出上预测部分</span>
        <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>
            box_predictor <span class="token operator">=</span> FastRCNNPredictor<span class="token punctuation">(</span>
                representation_size<span class="token punctuation">,</span>
                num_classes<span class="token punctuation">)</span>

        <span class="token comment"># 将roi pooling, box_head以及box_predictor结合在一起</span>
        roi_heads <span class="token operator">=</span> RoIHeads<span class="token punctuation">(</span>
            <span class="token comment"># box</span>
            box_roi_pool<span class="token punctuation">,</span> box_head<span class="token punctuation">,</span> box_predictor<span class="token punctuation">,</span>
            box_fg_iou_thresh<span class="token punctuation">,</span> box_bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># 0.5  0.5</span>
            box_batch_size_per_image<span class="token punctuation">,</span> box_positive_fraction<span class="token punctuation">,</span>  <span class="token comment"># 512  0.25</span>
            bbox_reg_weights<span class="token punctuation">,</span>
            box_score_thresh<span class="token punctuation">,</span> box_nms_thresh<span class="token punctuation">,</span> box_detections_per_img<span class="token punctuation">)</span>  <span class="token comment"># 0.05  0.5  100</span>

        <span class="token keyword">if</span> image_mean <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_mean <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> image_std <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>

        <span class="token comment"># 对数据进行标准化，缩放，打包成batch等处理部分</span>
        transform <span class="token operator">=</span> GeneralizedRCNNTransform<span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> image_mean<span class="token punctuation">,</span> image_std<span class="token punctuation">)</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>完整代码：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> warnings
<span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Tuple<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Union

<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token punctuation">,</span> Tensor
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>ops <span class="token keyword">import</span> MultiScaleRoIAlign

<span class="token keyword">from</span> <span class="token punctuation">.</span>roi_head <span class="token keyword">import</span> RoIHeads
<span class="token keyword">from</span> <span class="token punctuation">.</span>transform <span class="token keyword">import</span> GeneralizedRCNNTransform
<span class="token keyword">from</span> <span class="token punctuation">.</span>rpn_function <span class="token keyword">import</span> AnchorsGenerator<span class="token punctuation">,</span> RPNHead<span class="token punctuation">,</span> RegionProposalNetwork


<span class="token keyword">class</span> <span class="token class-name">FasterRCNNBase</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main class for Generalized R-CNN.

    Arguments:
        backbone (nn.Module):
        rpn (nn.Module):
        roi_heads (nn.Module): takes the features + the proposals from the RPN and computes
            detections / masks from it.
        transform (nn.Module): performs the data transformation from the inputs to feed into
            the model
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> backbone
        self<span class="token punctuation">.</span>rpn <span class="token operator">=</span> rpn
        self<span class="token punctuation">.</span>roi_heads <span class="token operator">=</span> roi_heads
        <span class="token comment"># used only on torchscript mode</span>
        self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>unused</span>
    <span class="token keyword">def</span> <span class="token function">eager_outputs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Dict[str, Tensor], List[Dict[str, Tensor]]) -> Union[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> losses

        <span class="token keyword">return</span> detections

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], Optional[List[Dict[str, Tensor]]]) -> Tuple[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> targets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"In training mode, targets should be passed"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">:</span>         <span class="token comment"># 进一步判断传入的target的boxes参数是否符合规定</span>
                boxes <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token keyword">or</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be a tensor"</span>
                                         <span class="token string">"of shape [N, 4], got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                                          boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be of type "</span>
                                     <span class="token string">"Tensor, got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        original_image_sizes <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">:</span>
            val <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>  <span class="token comment"># 防止输入的是个一维向量</span>
            original_image_sizes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># original_image_sizes = [img.shape[-2:] for img in images]</span>

        images<span class="token punctuation">,</span> targets <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>images<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>  <span class="token comment"># 对图像进行预处理</span>

        <span class="token comment"># print(images.tensors.shape)</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>images<span class="token punctuation">.</span>tensors<span class="token punctuation">)</span>  <span class="token comment"># 将图像输入backbone得到特征图</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 若只在一层特征层上预测，将feature放入有序字典中，并编号为‘0’</span>
            features <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> features<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 若在多层特征层上预测，传入的就是一个有序字典</span>

        <span class="token comment"># 将特征层以及标注target信息传入rpn中</span>
        <span class="token comment"># proposals: List[Tensor], Tensor_shape: [num_proposals, 4],</span>
        <span class="token comment"># 每个proposals是绝对坐标，且为(x1, y1, x2, y2)格式</span>
        proposals<span class="token punctuation">,</span> proposal_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 将rpn生成的数据以及标注target信息传入fast rcnn后半部分</span>
        detections<span class="token punctuation">,</span> detector_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>roi_heads<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 对网络的预测结果进行后处理（主要将bboxes还原到原图像尺度上）</span>
        detections <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>postprocess<span class="token punctuation">(</span>detections<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> original_image_sizes<span class="token punctuation">)</span>

        losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detector_losses<span class="token punctuation">)</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>proposal_losses<span class="token punctuation">)</span>

        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>is_scripting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_has_warned<span class="token punctuation">:</span>
                warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">"RCNN always returns a (Losses, Detections) tuple in scripting"</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">return</span> losses<span class="token punctuation">,</span> detections
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>eager_outputs<span class="token punctuation">(</span>losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span>

        <span class="token comment"># if self.training:</span>
        <span class="token comment">#     return losses</span>
        <span class="token comment">#</span>
        <span class="token comment"># return detections</span>


<span class="token keyword">class</span> <span class="token class-name">TwoMLPHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Standard heads for FPN-based models

    Arguments:
        in_channels (int): number of input channels
        representation_size (int): size of the intermediate representation
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TwoMLPHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fc6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>representation_size<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>start_dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc6<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">FastRCNNPredictor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Standard classification + bounding box regression layers
    for Fast R-CNN.

    Arguments:
        in_channels (int): number of input channels
        num_classes (int): number of output classes (including background)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FastRCNNPredictor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cls_score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>start_dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_score<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        bbox_deltas <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">return</span> scores<span class="token punctuation">,</span> bbox_deltas


<span class="token keyword">class</span> <span class="token class-name">FasterRCNN</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token comment"># transform parameter</span>
                 min_size<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1333</span><span class="token punctuation">,</span>      <span class="token comment"># 预处理resize时限制的最小尺寸与最大尺寸</span>
                 image_mean<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> image_std<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 预处理normalize时使用的均值和方差</span>
                 <span class="token comment"># RPN parameters</span>
                 rpn_anchor_generator<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> rpn_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 rpn_pre_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_pre_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment"># rpn中在nms处理前保留的proposal数(根据score)</span>
                 rpn_post_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_post_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中在nms处理后保留的proposal数</span>
                 rpn_nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中进行nms处理时使用的iou阈值</span>
                 rpn_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时，采集正负样本设置的阈值</span>
                 rpn_batch_size_per_image<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> rpn_positive_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时采样的样本数，以及正样本占总样本的比例</span>
                 rpn_score_thresh<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
                 <span class="token comment"># Box parameters</span>
                 box_roi_pool<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_predictor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token comment"># 移除低目标概率      fast rcnn中进行nms处理的阈值   对预测结果根据score排序取前100个目标</span>
                 box_score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span> box_nms_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_detections_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                 box_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>   <span class="token comment"># fast rcnn计算误差时，采集正负样本设置的阈值</span>
                 box_batch_size_per_image<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> box_positive_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># fast rcnn计算误差时采样的样本数，以及正样本占所有样本的比例</span>
                 bbox_reg_weights<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> <span class="token string">"out_channels"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                <span class="token string">"backbone should contain an attribute out_channels"</span>
                <span class="token string">"specifying the number of output channels  (assumed to be the"</span>
                <span class="token string">"same for all the levels"</span>
            <span class="token punctuation">)</span>

        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>rpn_anchor_generator<span class="token punctuation">,</span> <span class="token punctuation">(</span>AnchorsGenerator<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>box_roi_pool<span class="token punctuation">,</span> <span class="token punctuation">(</span>MultiScaleRoIAlign<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> num_classes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should be None when box_predictor "</span>
                                 <span class="token string">"is specified"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should not be None when box_predictor "</span>
                                 <span class="token string">"is not specified"</span><span class="token punctuation">)</span>

        <span class="token comment"># 预测特征层的channels</span>
        out_channels <span class="token operator">=</span> backbone<span class="token punctuation">.</span>out_channels

        <span class="token comment"># 若anchor生成器为空，则自动生成针对resnet50_fpn的anchor生成器</span>
        <span class="token keyword">if</span> rpn_anchor_generator <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            anchor_sizes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            aspect_ratios <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_sizes<span class="token punctuation">)</span>
            rpn_anchor_generator <span class="token operator">=</span> AnchorsGenerator<span class="token punctuation">(</span>
                anchor_sizes<span class="token punctuation">,</span> aspect_ratios
            <span class="token punctuation">)</span>

        <span class="token comment"># 生成RPN通过滑动窗口预测网络部分</span>
        <span class="token keyword">if</span> rpn_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            rpn_head <span class="token operator">=</span> RPNHead<span class="token punctuation">(</span>
                out_channels<span class="token punctuation">,</span> rpn_anchor_generator<span class="token punctuation">.</span>num_anchors_per_location<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># 默认rpn_pre_nms_top_n_train = 2000, rpn_pre_nms_top_n_test = 1000,</span>
        <span class="token comment"># 默认rpn_post_nms_top_n_train = 2000, rpn_post_nms_top_n_test = 1000,</span>
        rpn_pre_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_pre_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_pre_nms_top_n_test<span class="token punctuation">)</span>
        rpn_post_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_post_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_post_nms_top_n_test<span class="token punctuation">)</span>

        <span class="token comment"># 定义整个RPN框架</span>
        rpn <span class="token operator">=</span> RegionProposalNetwork<span class="token punctuation">(</span>
            rpn_anchor_generator<span class="token punctuation">,</span> rpn_head<span class="token punctuation">,</span>
            rpn_fg_iou_thresh<span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token punctuation">,</span>
            rpn_batch_size_per_image<span class="token punctuation">,</span> rpn_positive_fraction<span class="token punctuation">,</span>
            rpn_pre_nms_top_n<span class="token punctuation">,</span> rpn_post_nms_top_n<span class="token punctuation">,</span> rpn_nms_thresh<span class="token punctuation">,</span>
            score_thresh<span class="token operator">=</span>rpn_score_thresh<span class="token punctuation">)</span>

        <span class="token comment">#  Multi-scale RoIAlign pooling</span>
        <span class="token keyword">if</span> box_roi_pool <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            box_roi_pool <span class="token operator">=</span> MultiScaleRoIAlign<span class="token punctuation">(</span>
                featmap_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 在哪些特征层进行roi pooling</span>
                output_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                sampling_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># fast RCNN中roi pooling后的展平处理两个全连接层部分</span>
        <span class="token keyword">if</span> box_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            resolution <span class="token operator">=</span> box_roi_pool<span class="token punctuation">.</span>output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 默认等于7</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>
            box_head <span class="token operator">=</span> TwoMLPHead<span class="token punctuation">(</span>
                out_channels <span class="token operator">*</span> resolution <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span>
                representation_size
            <span class="token punctuation">)</span>

        <span class="token comment"># 在box_head的输出上预测部分</span>
        <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>
            box_predictor <span class="token operator">=</span> FastRCNNPredictor<span class="token punctuation">(</span>
                representation_size<span class="token punctuation">,</span>
                num_classes<span class="token punctuation">)</span>

        <span class="token comment"># 将roi pooling, box_head以及box_predictor结合在一起</span>
        roi_heads <span class="token operator">=</span> RoIHeads<span class="token punctuation">(</span>
            <span class="token comment"># box</span>
            box_roi_pool<span class="token punctuation">,</span> box_head<span class="token punctuation">,</span> box_predictor<span class="token punctuation">,</span>
            box_fg_iou_thresh<span class="token punctuation">,</span> box_bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># 0.5  0.5</span>
            box_batch_size_per_image<span class="token punctuation">,</span> box_positive_fraction<span class="token punctuation">,</span>  <span class="token comment"># 512  0.25</span>
            bbox_reg_weights<span class="token punctuation">,</span>
            box_score_thresh<span class="token punctuation">,</span> box_nms_thresh<span class="token punctuation">,</span> box_detections_per_img<span class="token punctuation">)</span>  <span class="token comment"># 0.05  0.5  100</span>

        <span class="token keyword">if</span> image_mean <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_mean <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> image_std <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>

        <span class="token comment"># 对数据进行标准化，缩放，打包成batch等处理部分</span>
        transform <span class="token operator">=</span> GeneralizedRCNNTransform<span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> image_mean<span class="token punctuation">,</span> image_std<span class="token punctuation">)</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="transform---transform.py">3、Transform - <code>transform.py</code></h1><p>在transform.py文件中，</p><p>训练预处理，主要看<code>normalize</code>、<code>resize</code>、<code>batch_images</code>三个函数和<code>GeneralizedRCNNTransform.forward</code></p><p>训练后处理，<code>postprocess</code></p><h2 id="训练预处理">3.1 训练预处理</h2><p>normalize：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""标准化处理"""</span>
    dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> image<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> image<span class="token punctuation">.</span>device

    <span class="token comment"># 将传入的均值和方差转换为与输入图片相同的类型和设备</span>
    mean <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_mean<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    std <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_std<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

    <span class="token comment"># [:, None, None]: shape [3] -> [3, 1, 1]</span>
    <span class="token triple-quoted-string string">"""
        因为将mean和std转换为torch.tensor后，它俩的shape为[3]，而mean[:, None, None]看似是在切片，但实际上给mean和std添加了
        两个维度，即shape从[3]变为了[3, 1, 1]

        >>> x = torch.randint(1, (3, 112, 112)).cuda()
        >>> x.shape
        torch.Size([3, 112, 112])
        >>> mean = [0.1, 0.2, 0.3]
        >>> mean = torch.as_tensor(mean, dtype=x.dtype, device=x.device)
        >>> mean.shape
        torch.Size([3])
        >>> mean[:, None, None].shape
        torch.Size([3, 1, 1])
    """</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>image <span class="token operator">-</span> mean<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resize：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">resize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (Tensor, Optional[Dict[str, Tensor]]) -> Tuple[Tensor, Optional[Dict[str, Tensor]]]</span>
    <span class="token triple-quoted-string string">"""
    将图片缩放到指定的大小范围内，并对应缩放bboxes信息
    Args:
        image: 输入的图片
        target: 输入图片的相关信息（包括bboxes信息）

    Returns:
        image: 缩放后的图片
        target: 缩放bboxes后的图片相关信息
    """</span>
    <span class="token comment"># image shape is [channel, height, width]</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>torch_choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>min_size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 指定输入图片的最小边长,注意是self.min_size不是min_size</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># FIXME assume for now that testing uses the largest scale</span>
        size <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>min_size<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 指定输入图片的最小边长,注意是self.min_size不是min_size</span>

    <span class="token keyword">if</span> torchvision<span class="token punctuation">.</span>_is_tracing<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> _resize_image_onnx<span class="token punctuation">(</span>image<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 根据缩放比例缩放图片</span>
        image <span class="token operator">=</span> _resize_image<span class="token punctuation">(</span>image<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 测试模式直接返回了</span>
    <span class="token keyword">if</span> target <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target

    <span class="token comment"># 训练模式的话要进一步缩放bbox</span>
    bbox <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
    <span class="token comment"># 根据图像的缩放比例来缩放bbox</span>
    bbox <span class="token operator">=</span> resize_boxes<span class="token punctuation">(</span>boxes<span class="token operator">=</span>bbox<span class="token punctuation">,</span> original_size<span class="token operator">=</span><span class="token punctuation">[</span>h<span class="token punctuation">,</span> w<span class="token punctuation">]</span><span class="token punctuation">,</span> new_size<span class="token operator">=</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> bbox

    <span class="token keyword">return</span> image<span class="token punctuation">,</span> target

    
<span class="token keyword">def</span> <span class="token function">_resize_image</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> self_min_size<span class="token punctuation">,</span> self_max_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (Tensor, float, float) -> Tensor</span>
    im_shape <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    min_size <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>im_shape<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 获取高宽中的最小值</span>
    max_size <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>im_shape<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 获取高宽中的最大值</span>
    scale_factor <span class="token operator">=</span> self_min_size <span class="token operator">/</span> min_size  <span class="token comment"># 根据指定最小边长和图片最小边长计算缩放比例</span>

    <span class="token comment"># 如果使用该缩放比例计算的图片最大边长大于指定的最大边长</span>
    <span class="token keyword">if</span> max_size <span class="token operator">*</span> scale_factor <span class="token operator">></span> self_max_size<span class="token punctuation">:</span>
        scale_factor <span class="token operator">=</span> self_max_size <span class="token operator">/</span> max_size  <span class="token comment"># 将缩放比例设为指定最大边长和图片最大边长之比</span>

    <span class="token comment"># interpolate利用插值的方法缩放图片</span>
    <span class="token comment"># image[None]操作是在最前面添加batch维度[C, H, W] -> [1, C, H, W]</span>
    <span class="token comment"># bilinear只支持4D Tensor</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>
        image<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scale_factor<span class="token operator">=</span>scale_factor<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"bilinear"</span><span class="token punctuation">,</span> recompute_scale_factor<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> image

<span class="token keyword">def</span> <span class="token function">resize_boxes</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> original_size<span class="token punctuation">,</span> new_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (Tensor, List[int], List[int]) -> Tensor</span>
    <span class="token triple-quoted-string string">"""
    将boxes参数根据图像的缩放情况进行相应缩放

    Arguments:
        original_size: 图像缩放前的尺寸
        new_size: 图像缩放后的尺寸
    """</span>
    ratios <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token comment"># 缩放因子：新尺寸/旧尺寸</span>
        torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>s<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>boxes<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token operator">/</span>
        torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>s_orig<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>boxes<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        <span class="token keyword">for</span> s<span class="token punctuation">,</span> s_orig <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>new_size<span class="token punctuation">,</span> original_size<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    ratios_height<span class="token punctuation">,</span> ratios_width <span class="token operator">=</span> ratios
    <span class="token comment"># Removes a tensor dimension, boxes [minibatch, 4]</span>
    <span class="token comment"># Returns a tuple of all slices along a given dimension, already without it.</span>
    xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> boxes<span class="token punctuation">.</span>unbind<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 在索引为1的位置展开(2个坐标点)</span>
    xmin <span class="token operator">=</span> xmin <span class="token operator">*</span> ratios_width
    xmax <span class="token operator">=</span> xmax <span class="token operator">*</span> ratios_width
    ymin <span class="token operator">=</span> ymin <span class="token operator">*</span> ratios_height
    ymax <span class="token operator">=</span> ymax <span class="token operator">*</span> ratios_height
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>batch_images，将n张图片进行打包处理（为了保持图像的比例，将n张图片调整到统一格式，多余位置填充0）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">batch_images</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> size_divisible<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (List[Tensor], int) -> Tensor</span>
    <span class="token triple-quoted-string string">"""
    将一批图像打包成一个batch返回（注意batch中每个tensor的shape是相同的）
    Args:
        images: 输入的一批图片
        size_divisible: 将图像高和宽调整到该数的整数倍

    Returns:
        batched_imgs: 打包成一个batch后的tensor数据
    """</span>

    <span class="token keyword">if</span> torchvision<span class="token punctuation">.</span>_is_tracing<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># batch_images() does not export well to ONNX</span>
        <span class="token comment"># call _onnx_batch_images() instead</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_onnx_batch_images<span class="token punctuation">(</span>images<span class="token punctuation">,</span> size_divisible<span class="token punctuation">)</span>


    <span class="token comment"># 分别计算一个batch中所有图片中的最大channel, height, width</span>
    <span class="token triple-quoted-string string">"""
        >>> y.shape
        torch.Size([2, 3, 112, 112])
        >>> list(y.shape)
        [2, 3, 112, 112]
    """</span>
    max_size <span class="token operator">=</span> self<span class="token punctuation">.</span>max_by_axis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">]</span><span class="token punctuation">)</span>



    stride <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>size_divisible<span class="token punctuation">)</span>
    <span class="token comment"># max_size = list(max_size)</span>
    <span class="token triple-quoted-string string">"""
    	math.ceil：向上取整
    """</span>
    <span class="token comment"># 将height向上调整到stride的整数倍（最靠近stride整数倍的数值）</span>
    max_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>max_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> stride<span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span>
    <span class="token comment"># 将width向上调整到stride的整数倍</span>
    max_size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>max_size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> stride<span class="token punctuation">)</span> <span class="token operator">*</span> stride<span class="token punctuation">)</span>

    <span class="token comment"># [batch, channel, height, width]</span>
    batch_shape <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> max_size

    <span class="token comment"># 创建shape为batch_shape且值全部为0的tensor</span>
    batched_imgs <span class="token operator">=</span> images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>new_full<span class="token punctuation">(</span>batch_shape<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> img<span class="token punctuation">,</span> pad_img <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> batched_imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 将输入images中的每张图片复制到新的batched_imgs的每张图片中，对齐左上角，保证bboxes的坐标不变</span>
        <span class="token comment"># 这样保证输入到网络中一个batch的每张图片的shape相同</span>
        <span class="token comment"># copy_: Copies the elements from src into self tensor and returns self</span>
        pad_img<span class="token punctuation">[</span><span class="token punctuation">:</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># pad_img[C, H, W]</span>

    <span class="token keyword">return</span> batched_imgs

<span class="token keyword">def</span> <span class="token function">max_by_axis</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> the_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[List[int]]) -> List[int]</span>
        <span class="token comment"># the_list: [BS, C, H, W]</span>
        maxes <span class="token operator">=</span> the_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># [C, H, W]</span>
        <span class="token keyword">for</span> sublist <span class="token keyword">in</span> the_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 得到每一个图片的shape</span>
            <span class="token keyword">for</span> index<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>sublist<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 迭代每一张图片的shape</span>
                maxes<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>maxes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span>
        <span class="token keyword">return</span> maxes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>GeneralizedRCNNTransform类.forward：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">GeneralizedRCNNTransform</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Performs input / target transformation before feeding the data to a GeneralizedRCNN
    model.

    The transformations it perform are:
        - input normalization (mean subtraction and std division)
        - input / target resizing to match min_size / max_size

    It returns a ImageList for the inputs, and a List[Dict[Tensor]] for the targets
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> image_mean<span class="token punctuation">,</span> image_std<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>GeneralizedRCNNTransform<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            min_size <span class="token operator">=</span> <span class="token punctuation">(</span>min_size<span class="token punctuation">,</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size      <span class="token comment"># 指定图像的最小边长范围</span>
        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size      <span class="token comment"># 指定图像的最大边长范围</span>
        self<span class="token punctuation">.</span>image_mean <span class="token operator">=</span> image_mean  <span class="token comment"># 指定图像在标准化处理中的均值</span>
        self<span class="token punctuation">.</span>image_std <span class="token operator">=</span> image_std    <span class="token comment"># 指定图像在标准化处理中的方差</span>
      
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                images<span class="token punctuation">,</span>       <span class="token comment"># type: List[Tensor]</span>
                targets<span class="token operator">=</span><span class="token boolean">None</span>  <span class="token comment"># type: Optional[List[Dict[str, Tensor]]]</span>
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> Tuple[ImageList, Optional[List[Dict[str, Tensor]]]]</span>
        images <span class="token operator">=</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            target_index <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">if</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>

            <span class="token keyword">if</span> image<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"images is expected to be a list of 3d tensors "</span>
                                 <span class="token string">"of shape [C, H, W], got &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>normalize<span class="token punctuation">(</span>image<span class="token punctuation">)</span>                <span class="token comment"># 对图像进行标准化处理</span>
            image<span class="token punctuation">,</span> target_index <span class="token operator">=</span> self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image<span class="token punctuation">,</span> target_index<span class="token punctuation">)</span>   <span class="token comment"># 对图像和对应的bboxes缩放到指定范围</span>
            images<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image
            <span class="token keyword">if</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> target_index <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target_index

        <span class="token comment"># 记录resize后bs张图片的图像尺寸</span>
        image_sizes <span class="token operator">=</span> <span class="token punctuation">[</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">]</span>
        images <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_images<span class="token punctuation">(</span>images<span class="token punctuation">)</span>  <span class="token comment"># 将images打包成一个batch（拓展成相同维度，相同缩放比）</span>
        image_sizes_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> image_size <span class="token keyword">in</span> image_sizes<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image_size<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>
            image_sizes_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>image_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        image_list <span class="token operator">=</span> ImageList<span class="token punctuation">(</span>images<span class="token punctuation">,</span> image_sizes_list<span class="token punctuation">)</span> <span class="token comment"># 记录一下resize后的尺寸</span>
        <span class="token keyword">return</span> image_list<span class="token punctuation">,</span> targets
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="训练后处理">3.2 训练后处理</h2><p>postprocess：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                    result<span class="token punctuation">,</span>                <span class="token comment"># type: List[Dict[str, Tensor]]</span>
                    image_shapes<span class="token punctuation">,</span>          <span class="token comment"># type: List[Tuple[int, int]]</span>
                    original_image_sizes   <span class="token comment"># type: List[Tuple[int, int]]</span>
                    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> List[Dict[str, Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        对网络的预测结果进行后处理（主要将bboxes还原到原图像尺度上）
        Args:
            result: list(dict), 网络的预测结果, len(result) == batch_size
            image_shapes: list(torch.Size), 图像预处理缩放后的尺寸, len(image_shapes) == batch_size
            original_image_sizes: list(torch.Size), 图像的原始尺寸, len(original_image_sizes) == batch_size

        Returns:

        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> result

        <span class="token comment"># 遍历每张图片的预测信息，将boxes信息还原回原尺度</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> im_s<span class="token punctuation">,</span> o_im_s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> image_shapes<span class="token punctuation">,</span> original_image_sizes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            boxes <span class="token operator">=</span> pred<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
            boxes <span class="token operator">=</span> resize_boxes<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> im_s<span class="token punctuation">,</span> o_im_s<span class="token punctuation">)</span>  <span class="token comment"># 将bboxes缩放回原图像尺度上</span>
            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="rpn源码讲解---rpn_function.py">4、RPN源码讲解 - <code>rpn_function.py</code></h1><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211171117966.png" style="zoom:50%"></p><h2 id="rpn-head生成目标得分概率和坐标回归参数">4.1 RPN Head生成目标得分概率和坐标回归参数</h2><p>论文中的实现与Pytorch官方实现略有不同</p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211132104079.png" style="zoom:67%"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RPNHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    add a RPN head with classification and regression
    通过滑动窗口计算预测目标概率与bbox regression参数

    Arguments:
        in_channels: number of channels of the input feature
        num_anchors: number of anchors to be predicted
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 3x3 滑动窗口  [BS, C, H, W] -> [BS, C, H, W]</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算预测的目标分数（这里的目标只是指前景或者背景） [BS, C, H, W] -> [BS, num_anchor, H, W]</span>
        self<span class="token punctuation">.</span>cls_logits <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 只生成k个scores，output=num_anchors</span>
        <span class="token comment"># 计算预测的目标bbox regression参数  [BS, C, H, W] -> [BS, num_anchor*4, H, W]</span>
        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_anchors <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 参数初始化</span>
        <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>layer<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
                torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>layer<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor]) -> Tuple[List[Tensor], List[Tensor]]</span>
        <span class="token comment"># x为图像经过backbone生成的预测特征层</span>
        logits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        bbox_reg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> feature <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 迭代预测特征层</span>
            t <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logits<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_logits<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 预测分类结果</span>
            bbox_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 预测bbox结果</span>
        <span class="token keyword">return</span> logits<span class="token punctuation">,</span> bbox_reg
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="anchors-generator生锚框">4.2 Anchors Generator生锚框</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">AnchorsGenerator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __annotations__ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"cell_anchors"</span><span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"_cache"</span><span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>

    <span class="token triple-quoted-string string">"""
    anchors生成器

    Arguments:
        sizes (Tuple[Tuple[int]]): anchor的scale
        aspect_ratios (Tuple[Tuple[float]]): 每一个anchor所采用的比例
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sizes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aspect_ratios<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>AnchorsGenerator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 检查sizes和aspect_ratios里面第一个元素是不是list或tuple数据类型，不是就对其进行修改</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>sizes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># TODO change this</span>
            sizes <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> sizes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>aspect_ratios<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            aspect_ratios <span class="token operator">=</span> <span class="token punctuation">(</span>aspect_ratios<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span>

        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sizes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>aspect_ratios<span class="token punctuation">)</span>  <span class="token comment"># 二者的元素个数是否相同</span>

        self<span class="token punctuation">.</span>sizes <span class="token operator">=</span> sizes
        self<span class="token punctuation">.</span>aspect_ratios <span class="token operator">=</span> aspect_ratios
        self<span class="token punctuation">.</span>cell_anchors <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment"># 保存生成的anchor信息</span>

    <span class="token keyword">def</span> <span class="token function">generate_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scales<span class="token punctuation">,</span> aspect_ratios<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[int], List[float], torch.dtype, torch.device) -> Tensor</span>
        <span class="token triple-quoted-string string">"""
        compute anchor sizes
        Arguments:
            scales: sqrt(anchor_area)
            aspect_ratios: h/w ratios
            dtype: float32
            device: cpu/gpu
        """</span>
        scales <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>scales<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        aspect_ratios <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>aspect_ratios<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        h_ratios <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>aspect_ratios<span class="token punctuation">)</span>
        w_ratios <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> h_ratios

        <span class="token comment"># [r1, r2, r3]' * [s1, s2, s3]</span>
        <span class="token comment"># number of elements is len(ratios)*len(scales)</span>
        ws <span class="token operator">=</span> <span class="token punctuation">(</span>w_ratios<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> scales<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        hs <span class="token operator">=</span> <span class="token punctuation">(</span>h_ratios<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> scales<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># left-top, right-bottom coordinate relative to anchor center(0, 0)</span>
        <span class="token comment"># 生成的anchors模板都是以（0, 0）为中心的, shape [len(ratios)*len(scales), 4]</span>
        base_anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span>ws<span class="token punctuation">,</span> <span class="token operator">-</span>hs<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> hs<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>

        <span class="token keyword">return</span> base_anchors<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># round 四舍五入</span>

    <span class="token keyword">def</span> <span class="token function">set_cell_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (torch.dtype, torch.device) -> None</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cell_anchors <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            cell_anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>cell_anchors
            <span class="token keyword">assert</span> cell_anchors <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token comment"># suppose that all anchors have the same device</span>
            <span class="token comment"># which is a valid assumption in the current state of the codebase</span>
            <span class="token keyword">if</span> cell_anchors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>device <span class="token operator">==</span> device<span class="token punctuation">:</span>
                <span class="token keyword">return</span>

        <span class="token comment"># 根据提供的sizes和aspect_ratios生成anchors模板</span>
        <span class="token comment"># anchors模板都是以(0, 0)为中心的anchor</span>
        cell_anchors <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>generate_anchors<span class="token punctuation">(</span>sizes<span class="token punctuation">,</span> aspect_ratios<span class="token punctuation">,</span> dtype<span class="token punctuation">,</span> device<span class="token punctuation">)</span>
            <span class="token keyword">for</span> sizes<span class="token punctuation">,</span> aspect_ratios <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>sizes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>aspect_ratios<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>cell_anchors <span class="token operator">=</span> cell_anchors

    <span class="token keyword">def</span> <span class="token function">num_anchors_per_location</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 计算每个预测特征层上每个滑动窗口的预测目标数</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> s<span class="token punctuation">,</span> a <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>sizes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>aspect_ratios<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># For every combination of (a, (g, s), i) in (self.cell_anchors, zip(grid_sizes, strides), 0:2),</span>
    <span class="token comment"># output g[i] anchors that are s[i] distance apart in direction i, with the same dimensions as a.</span>
    <span class="token keyword">def</span> <span class="token function">grid_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> grid_sizes<span class="token punctuation">,</span> strides<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[List[int]], List[List[Tensor]]) -> List[Tensor]</span>
        <span class="token triple-quoted-string string">"""
        anchors position in grid coordinate axis map into origin image
        计算预测特征图对应原始图像上的所有anchors的坐标
        Args:
            grid_sizes: 预测特征矩阵的height和width
            strides: 预测特征矩阵上一步对应原始图像上的步距
        """</span>
        anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        cell_anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>cell_anchors  <span class="token comment"># 预测特征图上anchors的模板</span>
        <span class="token keyword">assert</span> cell_anchors <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>

        <span class="token comment"># 遍历每个预测特征层的grid_size，strides和cell_anchors</span>
        <span class="token keyword">for</span> size<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> base_anchors <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>grid_sizes<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> cell_anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>
            grid_height<span class="token punctuation">,</span> grid_width <span class="token operator">=</span> size  <span class="token comment"># 每一个预测特征图的高度和宽度</span>
            stride_height<span class="token punctuation">,</span> stride_width <span class="token operator">=</span> stride  <span class="token comment"># 每一个预测特征图一个cell对应原图的高度和宽度的尺度信息</span>
            device <span class="token operator">=</span> base_anchors<span class="token punctuation">.</span>device  <span class="token comment"># 设备信息</span>

            <span class="token triple-quoted-string string">"""
                >>> torch.arange(0, 3, dtype=torch.float32, device="cuda")
                tensor([0., 1., 2.], device='cuda:0')

            """</span>
            <span class="token comment"># For output anchor, compute [x_center, y_center, x_center, y_center]</span>
            <span class="token comment"># shifts_x: shape->[grid_width] 对应原图上的x坐标(列)</span>
            shifts_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> grid_width<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> stride_width
            <span class="token comment"># shifts_y: shape->[grid_height] 对应原图上的y坐标(行)</span>
            shifts_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> grid_height<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> stride_height

            <span class="token comment"># 计算预测特征矩阵上每个点对应原图上的坐标(anchors模板的坐标偏移量)</span>
            <span class="token comment"># torch.meshgrid函数分别传入行坐标和列坐标，生成网格行坐标矩阵和网格列坐标矩阵</span>
            <span class="token triple-quoted-string string">"""
                >>> x = torch.arange(0, 5, dtype=torch.float32, device="cuda")
                >>> y = torch.arange(5, 10, dtype=torch.float32, device="cuda")
                >>> grid = torch.meshgrid(x, y)
                >>> grid
                (tensor([[0., 0., 0., 0., 0.],
                        [1., 1., 1., 1., 1.],
                        [2., 2., 2., 2., 2.],
                        [3., 3., 3., 3., 3.],
                        [4., 4., 4., 4., 4.]], device='cuda:0'), tensor([[5., 6., 7., 8., 9.],
                        [5., 6., 7., 8., 9.],
                        [5., 6., 7., 8., 9.],
                        [5., 6., 7., 8., 9.],
                        [5., 6., 7., 8., 9.]], device='cuda:0'))

            """</span>
            <span class="token comment"># shape: [grid_height, grid_width]</span>
            shift_y<span class="token punctuation">,</span> shift_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>shifts_y<span class="token punctuation">,</span> shifts_x<span class="token punctuation">)</span>
            shift_x <span class="token operator">=</span> shift_x<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [850]</span>
            shift_y <span class="token operator">=</span> shift_y<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            <span class="token comment"># 计算anchors坐标(xmin, ymin, xmax, ymax)在原图上的坐标偏移量</span>
            <span class="token comment"># shape: [grid_width*grid_height, 4]</span>
            shifts <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>shift_x<span class="token punctuation">,</span> shift_y<span class="token punctuation">,</span> shift_x<span class="token punctuation">,</span> shift_y<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [850, 4]</span>

            <span class="token comment"># For every (base anchor, output anchor) pair,</span>
            <span class="token comment"># offset each zero-centered base anchor by the center of the output anchor.</span>
            <span class="token comment"># 将anchors模板与原图上的坐标偏移量相加得到原图上所有anchors的坐标信息(shape不同 时会使用广播机制)</span>
            shifts_anchor <span class="token operator">=</span> shifts<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> base_anchors<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># [850, 15, 4]</span>
            <span class="token comment"># 其中850为feature map的cell个数；15为每个cell生成的anchor个数；4为每个anchor的坐标</span>
            anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>shifts_anchor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># [12750， 4]：每个anchors的坐标信息</span>

        <span class="token keyword">return</span> anchors  <span class="token comment"># List[Tensor(all_num_anchors, 4)]</span>

    <span class="token keyword">def</span> <span class="token function">cached_grid_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> grid_sizes<span class="token punctuation">,</span> strides<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[List[int]], List[List[Tensor]]) -> List[Tensor]</span>
        <span class="token triple-quoted-string string">"""将计算得到的所有anchors信息进行缓存"""</span>
        key <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>grid_sizes<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>strides<span class="token punctuation">)</span>
        <span class="token comment"># self._cache是字典类型</span>
        <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_cache<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>grid_anchors<span class="token punctuation">(</span>grid_sizes<span class="token punctuation">,</span> strides<span class="token punctuation">)</span>  <span class="token comment"># [12750, 4]得到每一个anchor的坐标信息</span>
        self<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> anchors
        <span class="token keyword">return</span> anchors

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_list<span class="token punctuation">,</span> feature_maps<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (ImageList, List[Tensor]) -> List[Tensor]</span>
        <span class="token comment"># image_list: ① batch；② 图像尺寸信息</span>
        <span class="token comment"># feature_maps：预测特征层的信息，数据类型为List[Tensor]</span>

        <span class="token comment"># 获取每个预测特征层的尺寸(height, width)</span>
        grid_sizes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span>feature_map<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> feature_map <span class="token keyword">in</span> feature_maps<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取输入图像的height和width</span>
        image_size <span class="token operator">=</span> image_list<span class="token punctuation">.</span>tensors<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment"># 获取变量类型和设备类型</span>
        dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> feature_maps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> feature_maps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>device

        <span class="token comment"># one step in feature map equate n pixel stride in origin image</span>
        <span class="token comment"># 计算特征层上的一步等于原始图像上的步长</span>
        strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>image_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>image_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> g <span class="token keyword">in</span> grid_sizes<span class="token punctuation">]</span>

        <span class="token comment"># 根据提供的sizes和aspect_ratios生成anchors模板</span>
        self<span class="token punctuation">.</span>set_cell_anchors<span class="token punctuation">(</span>dtype<span class="token punctuation">,</span> device<span class="token punctuation">)</span>

        <span class="token comment"># 计算/读取所有anchors的坐标信息（这里的anchors信息是映射到原图上的所有anchors信息，不是anchors模板）</span>
        <span class="token comment"># 得到的是一个list列表，对应每张预测特征图映射回原图的anchors坐标信息</span>
        anchors_over_all_feature_maps <span class="token operator">=</span> self<span class="token punctuation">.</span>cached_grid_anchors<span class="token punctuation">(</span>grid_sizes<span class="token punctuation">,</span> strides<span class="token punctuation">)</span>

        anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>List<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 遍历一个batch中的每张图像</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>image_height<span class="token punctuation">,</span> image_width<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>image_list<span class="token punctuation">.</span>image_sizes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors_in_image <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment"># 遍历每张预测特征图映射回原图的anchors坐标信息</span>
            <span class="token keyword">for</span> anchors_per_feature_map <span class="token keyword">in</span> anchors_over_all_feature_maps<span class="token punctuation">:</span>
                anchors_in_image<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors_per_feature_map<span class="token punctuation">)</span>
            anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors_in_image<span class="token punctuation">)</span>
        <span class="token comment"># 将每一张图像的所有预测特征层的anchors坐标信息拼接在一起</span>
        <span class="token comment"># anchors是个list，每个元素为一张图像的所有anchors信息</span>
        anchors <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>anchors_per_image<span class="token punctuation">)</span> <span class="token keyword">for</span> anchors_per_image <span class="token keyword">in</span> anchors<span class="token punctuation">]</span>
        <span class="token comment"># Clear the cache in case that memory leaks.</span>
        self<span class="token punctuation">.</span>_cache<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> anchors
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="region-proposal-network">4.3 Region Proposal Network</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RegionProposalNetwork</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Implements Region Proposal Network (RPN).

    Arguments:
        anchor_generator (AnchorGenerator): module that generates the anchors for a set of feature
            maps.
        head (nn.Module): module that computes the objectness and regression deltas
        fg_iou_thresh (float): minimum IoU between the anchor and the GT box so that they can be
            considered as positive during training of the RPN.
        bg_iou_thresh (float): maximum IoU between the anchor and the GT box so that they can be
            considered as negative during training of the RPN.
        batch_size_per_image (int): number of anchors that are sampled during training of the RPN
            for computing the loss
        positive_fraction (float): proportion of positive anchors in a mini-batch during training
            of the RPN
        pre_nms_top_n (Dict[str]): number of proposals to keep before applying NMS. It should
            contain two fields: training and testing, to allow for different values depending
            on training or evaluation
        post_nms_top_n (Dict[str]): number of proposals to keep after applying NMS. It should
            contain two fields: training and testing, to allow for different values depending
            on training or evaluation
        nms_thresh (float): NMS threshold used for postprocessing the RPN proposals

    """</span>
    __annotations__ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment"># 对__init__函数中使用的变量进行注释，该部分不是必须的，只是为了方便理解每个变量的含义</span>
        <span class="token string">'box_coder'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>BoxCoder<span class="token punctuation">,</span>
        <span class="token string">'proposal_matcher'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>Matcher<span class="token punctuation">,</span>
        <span class="token string">'fg_bg_sampler'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>BalancedPositiveNegativeSampler<span class="token punctuation">,</span>
        <span class="token string">'pre_nms_top_n'</span><span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'post_nms_top_n'</span><span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchor_generator<span class="token punctuation">,</span> head<span class="token punctuation">,</span>
                 fg_iou_thresh<span class="token punctuation">,</span> bg_iou_thresh<span class="token punctuation">,</span>
                 batch_size_per_image<span class="token punctuation">,</span> positive_fraction<span class="token punctuation">,</span>
                 pre_nms_top_n<span class="token punctuation">,</span> post_nms_top_n<span class="token punctuation">,</span> nms_thresh<span class="token punctuation">,</span> score_thresh<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RegionProposalNetwork<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>anchor_generator <span class="token operator">=</span> anchor_generator
        self<span class="token punctuation">.</span>head <span class="token operator">=</span> head
        self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># use during training</span>
        <span class="token comment"># 计算anchors与真实bbox的iou</span>
        self<span class="token punctuation">.</span>box_similarity <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>box_iou

        self<span class="token punctuation">.</span>proposal_matcher <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>Matcher<span class="token punctuation">(</span>  <span class="token comment"># 实例化Matcher类</span>
            fg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># 当iou大于fg_iou_thresh(0.7)时视为正样本</span>
            bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># 当iou小于bg_iou_thresh(0.3)时视为负样本</span>
            allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fg_bg_sampler <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>BalancedPositiveNegativeSampler<span class="token punctuation">(</span>
            batch_size_per_image<span class="token punctuation">,</span> positive_fraction  <span class="token comment"># 256, 0.5</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># use during testing</span>
        self<span class="token punctuation">.</span>_pre_nms_top_n <span class="token operator">=</span> pre_nms_top_n
        self<span class="token punctuation">.</span>_post_nms_top_n <span class="token operator">=</span> post_nms_top_n
        self<span class="token punctuation">.</span>nms_thresh <span class="token operator">=</span> nms_thresh
        self<span class="token punctuation">.</span>score_thresh <span class="token operator">=</span> score_thresh
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> <span class="token number">1.</span>

    <span class="token keyword">def</span> <span class="token function">pre_nms_top_n</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pre_nms_top_n<span class="token punctuation">[</span><span class="token string">'training'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pre_nms_top_n<span class="token punctuation">[</span><span class="token string">'testing'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">post_nms_top_n</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_post_nms_top_n<span class="token punctuation">[</span><span class="token string">'training'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_post_nms_top_n<span class="token punctuation">[</span><span class="token string">'testing'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">assign_targets_to_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], List[Dict[str, Tensor]]) -> Tuple[List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        计算每个anchors最匹配的gt，并划分为正样本，背景以及废弃的样本
        Args：
            anchors: (List[Tensor])： 每张图像上预测的anchors
            targets: (List[Dict[Tensor])  # 包含了GT等信息
        Returns:
            labels: 标记anchors归属类别（1, 0, -1分别对应正样本，背景，废弃的样本）
                    注意，在RPN中只有前景和背景，所有正样本的类别都是1，0代表背景
            matched_gt_boxes：与anchors匹配的gt
        """</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储anchors匹配的标签</span>
        matched_gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储anchors匹配的GT</span>
        <span class="token comment"># 遍历每张图像的anchors和targets</span>
        <span class="token keyword">for</span> anchors_per_image<span class="token punctuation">,</span> targets_per_image <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
            gt_boxes <span class="token operator">=</span> targets_per_image<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>  <span class="token comment"># 只提取GT信息（里面原本包含boxes, labels, image_id, area, iscrowd）</span>
            <span class="token triple-quoted-string string">"""
                torch.numel(input) → int
                    返回tensor所有元素的个数（包括0元素）
                
                例子：   
                    >>> a = torch.randint(100, (3, 112, 112))
                    >>> a.numel()
                    37632
                    >>> a = torch.zeros(3, 112, 112)
                    >>> a.numel()
                    37632
            """</span>
            <span class="token keyword">if</span> gt_boxes<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 当前图片中没有GT</span>
                device <span class="token operator">=</span> anchors_per_image<span class="token punctuation">.</span>device
                matched_gt_boxes_per_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>anchors_per_image<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
                labels_per_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>anchors_per_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 当前图片中有GT</span>
                <span class="token comment"># 计算anchors与真实bbox的iou信息</span>
                <span class="token comment"># set to self.box_similarity when https://github.com/pytorch/pytorch/issues/27495 lands</span>
                match_quality_matrix <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> anchors_per_image<span class="token punctuation">)</span>  <span class="token comment"># [当前图片GT的个数，该图像生成anchors的总个数]</span>
                <span class="token comment"># 计算每个anchors与gt匹配iou最大的索引（如果iou&lt;0.3索引置为-1，0.3&lt;iou&lt;0.7索引为-2）</span>
                matched_idxs <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">(</span>match_quality_matrix<span class="token punctuation">)</span>
                <span class="token comment"># get the targets corresponding GT for each proposal</span>
                <span class="token comment"># NB: need to clamp the indices because we can have a single</span>
                <span class="token comment"># GT in the image, and matched_idxs can be -2, which goes</span>
                <span class="token comment"># out of bounds</span>
                <span class="token comment"># 这里使用clamp设置下限0是为了方便取每个anchors对应的gt_boxes信息</span>
                <span class="token comment"># 负样本和舍弃的样本都是负值，所以为了防止越界直接置为0</span>
                <span class="token comment"># 因为后面是通过labels_per_image变量来记录正样本位置的，</span>
                <span class="token comment"># 所以负样本和舍弃的样本对应的gt_boxes信息并没有什么意义，</span>
                <span class="token comment"># 反正计算目标边界框回归损失时只会用到正样本。</span>
                <span class="token triple-quoted-string string">"""
                    torch.clamp(input, min=None, max=None) → Tensor
                        参数：
                            input: 输入tensor
                            min：元素大小的下限
                            max：元素大小的上限
                        返回值：
                            经过裁剪后的tensor
                    
                    例子：
                        >>> a = torch.linspace(-1, 1, 4)
                        >>> a
                        tensor([-1.0000, -0.3333,  0.3333,  1.0000])
                        >>> torch.clamp(a, min=-0.5, max=0.5)
                        tensor([-0.5000, -0.3333,  0.3333,  0.5000])
                """</span>
                matched_gt_boxes_per_image <span class="token operator">=</span> gt_boxes<span class="token punctuation">[</span>matched_idxs<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 将元素&lt;0的全部设置为0</span>

                <span class="token comment"># 记录所有anchors匹配后的标签(正样本处标记为1，负样本处标记为0，丢弃样本处标记为-2)</span>
                labels_per_image <span class="token operator">=</span> matched_idxs <span class="token operator">>=</span> <span class="token number">0</span>
                labels_per_image <span class="token operator">=</span> labels_per_image<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>  <span class="token comment"># True -> 1; False -> 0 -> 正样本的位置值为1.0</span>

                <span class="token comment"># background (negative examples)</span>
                bg_indices <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD  <span class="token comment"># -1</span>
                labels_per_image<span class="token punctuation">[</span>bg_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span>  <span class="token comment"># 负样本的位置值为0.0</span>

                <span class="token comment"># discard indices that are between thresholds</span>
                inds_to_discard <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">.</span>BETWEEN_THRESHOLDS  <span class="token comment"># -2</span>
                labels_per_image<span class="token punctuation">[</span>inds_to_discard<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span>  <span class="token comment"># 丢弃样本的位置值为-1.0</span>

            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_per_image<span class="token punctuation">)</span>
            matched_gt_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>matched_gt_boxes_per_image<span class="token punctuation">)</span>
        <span class="token keyword">return</span> labels<span class="token punctuation">,</span> matched_gt_boxes

    <span class="token keyword">def</span> <span class="token function">_get_top_n_idx</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> num_anchors_per_level<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Tensor, List[int]) -> Tensor</span>
        <span class="token triple-quoted-string string">"""
        获取每张预测特征图上预测概率排前pre_nms_top_n的anchors索引值
        Args:
            objectness: Tensor(每张图像的预测目标概率信息)
            num_anchors_per_level: List（每个预测特征层上的预测的anchors个数）
        Returns:

        """</span>
        r <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 记录每个预测特征层上预测目标概率前pre_nms_top_n的索引信息</span>
        offset <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 遍历每个预测特征层上的预测目标概率信息</span>
        <span class="token triple-quoted-string string">"""
            tensor.split(长度, dim)
            
                >>> objectness = torch.randint(1, (2, 217413))
                >>> num_anchors_per_level = [163200, 40800, 10200, 2550, 663]
                >>> for ob in objectness.split(num_anchors_per_level, 1):
                ...     print(ob.shape)
                ... 
                torch.Size([2, 163200])
                torch.Size([2, 40800])
                torch.Size([2, 10200])
                torch.Size([2, 2550])
                torch.Size([2, 663])
                
                >>> print(f"&#123;a.shape&#125;\n&#123;b.shape&#125;\n&#123;c.shape&#125;\n&#123;d.shape&#125;\n&#123;e.shape&#125;")
                torch.Size([2, 163200])
                torch.Size([2, 40800])
                torch.Size([2, 10200])
                torch.Size([2, 2550])
                torch.Size([2, 663])
        """</span>
        <span class="token keyword">for</span> ob <span class="token keyword">in</span> objectness<span class="token punctuation">.</span>split<span class="token punctuation">(</span>num_anchors_per_level<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> torchvision<span class="token punctuation">.</span>_is_tracing<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                num_anchors<span class="token punctuation">,</span> pre_nms_top_n <span class="token operator">=</span> _onnx_get_num_anchors_and_pre_nms_top_n<span class="token punctuation">(</span>ob<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pre_nms_top_n<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                num_anchors <span class="token operator">=</span> ob<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 预测特征层上的预测的anchors个数</span>
                <span class="token comment"># self.pre_nms_top_n()训练时为2000，测试时为1000</span>
                pre_nms_top_n <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_nms_top_n<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_anchors<span class="token punctuation">)</span>

            <span class="token comment"># Returns the k largest elements of the given input tensor along a given dimension</span>
            <span class="token triple-quoted-string string">"""
                tensor.topk(k, 维度, 是否从大到小排序（默认Ture）, 是否排序)
                    torch.topk(input, k, dim=None, largest=True, sorted=True, *, out=None)
                    参数：
                        ① k -> top-k
                        ② dim
                        ③ largest=True： 是否按照从大到小的顺序排序
                        ④ sorted：控制是否按排序顺序返回元素
                        
                    返回值有两个：
                            ① 返回top-k排序后的数值
                            ② 返回top-k排序后的索引
                    
                    Example:
                        >>> x = torch.arange(1, 10)
                        >>> x
                        tensor([1, 2, 3, 4, 5, 6, 7, 8, 9])
                        >>> a, b = x.topk(k=5, dim=0)
                        >>> a
                        tensor([9, 8, 7, 6, 5])
                        >>> b
                        tensor([8, 7, 6, 5, 4])
                        >>> x.topk(k=5, dim=0)
                        torch.return_types.topk(
                        values=tensor([9, 8, 7, 6, 5]),
                        indices=tensor([8, 7, 6, 5, 4]))
            """</span>
            _<span class="token punctuation">,</span> top_n_idx <span class="token operator">=</span> ob<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pre_nms_top_n<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 只要排序后的索引，不要值</span>
            <span class="token comment"># 这里是将每一个预测特征层的anchors进行遍历，这里对于每一层r.append(top_n_idx)，对于第一层是对的，但对于后面层来说，里面存储</span>
            <span class="token comment"># 的数就不对了，因为里面存储的idx是根据topk得到的，而topk返回的是这一层的idx。</span>
            <span class="token comment"># 简单说，后面层的索引起点位置不应该是0。第二层idx的起点位置应该是第一层最后一个anchors的idx+1。</span>
            <span class="token comment"># 为了达到这个目的，这里使用了offset（偏移量），让这一层结束后让下一层的idx的起点处于正确的位置（而不是从0开始的）</span>
            r<span class="token punctuation">.</span>append<span class="token punctuation">(</span>top_n_idx <span class="token operator">+</span> offset<span class="token punctuation">)</span>
            offset <span class="token operator">+=</span> num_anchors
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>r<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">filter_proposals</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> image_shapes<span class="token punctuation">,</span> num_anchors_per_level<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Tensor, Tensor, List[Tuple[int, int]], List[int]) -> Tuple[List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        筛除小boxes框，nms处理，根据预测概率获取前post_nms_top_n个目标
        Args:
            proposals: 预测的bbox坐标
            objectness: 预测的目标概率
            image_shapes: batch中每张图片的size信息
            num_anchors_per_level: 每个预测特征层上预测anchors的数目

        Returns:

        """</span>
        num_images <span class="token operator">=</span> proposals<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># BS</span>
        device <span class="token operator">=</span> proposals<span class="token punctuation">.</span>device

        <span class="token comment"># do not backprop throught objectness</span>
        objectness <span class="token operator">=</span> objectness<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 丢弃objectness原有的梯度信息（只获取它的数值信息）</span>
        objectness <span class="token operator">=</span> objectness<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>num_images<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [BS, anchor个数, 4个坐标] -> [BS，anchor个数*4个坐标]</span>

        <span class="token comment"># Returns a tensor of size size filled with fill_value</span>
        <span class="token comment"># levels负责记录分隔不同预测特征层上的anchors索引信息</span>
        <span class="token comment"># idx：预测特征层的索引</span>
        <span class="token comment"># n：该预测特征层anchors的个数</span>
        <span class="token triple-quoted-string string">"""
            torch.full(生成tensor的shape, 填充值, 数据类型, 设备)
                >>> a = torch.full((19380, ), 0, dtype=torch.int64, device="cuda")
                >>> a.shape
                torch.Size([19380])
                >>> a
                tensor([0, 0, 0,  ..., 0, 0, 0], device='cuda:0')
        """</span>
        levels <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
                  <span class="token keyword">for</span> idx<span class="token punctuation">,</span> n <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>num_anchors_per_level<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token triple-quoted-string string">"""
            >>> levels = [torch.full((n, ), idx, dtype=torch.int64, device="cuda") for idx, n in enumerate([1000, 600, 300])]
            >>> levels = torch.cat(levels, dim=0)
            >>> levels.shape
            torch.Size([1900])
            >>> levels
            tensor([0, 0, 0,  ..., 2, 2, 2], device='cuda:0')
            
            这样我们就可以用不同的数值（0，1，2，3...）来区分不同的proposals是属于哪一个特征提取层了！
        """</span>
        levels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>levels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># Expand this tensor to the same size as objectness</span>
        <span class="token comment"># [所有特征提取层所有anchor的个数] -> [1, 所有特征提取层所有anchor的个数] -> [BS，anchor个数*4个坐标]</span>
        levels <span class="token operator">=</span> levels<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>objectness<span class="token punctuation">)</span>

        <span class="token comment"># select top_n boxes independently per level before applying nms</span>
        <span class="token comment"># 获取每张预测特征图上预测概率排前pre_nms_top_n的anchors索引值</span>
        top_n_idx <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_top_n_idx<span class="token punctuation">(</span>objectness<span class="token punctuation">,</span> num_anchors_per_level<span class="token punctuation">)</span>

        image_range <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>num_images<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        batch_idx <span class="token operator">=</span> image_range<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># [batch_size, 1]</span>

        <span class="token comment"># 根据每个预测特征层预测概率排前pre_nms_top_n的anchors索引值获取相应概率信息</span>
        objectness <span class="token operator">=</span> objectness<span class="token punctuation">[</span>batch_idx<span class="token punctuation">,</span> top_n_idx<span class="token punctuation">]</span>
        levels <span class="token operator">=</span> levels<span class="token punctuation">[</span>batch_idx<span class="token punctuation">,</span> top_n_idx<span class="token punctuation">]</span>
        <span class="token comment"># 预测概率排前pre_nms_top_n的anchors索引值获取相应bbox坐标信息</span>
        proposals <span class="token operator">=</span> proposals<span class="token punctuation">[</span>batch_idx<span class="token punctuation">,</span> top_n_idx<span class="token punctuation">]</span>

        objectness_prob <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>objectness<span class="token punctuation">)</span>

        final_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        final_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 遍历每张图像的相关预测信息</span>
        <span class="token keyword">for</span> boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> lvl<span class="token punctuation">,</span> img_shape <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> objectness_prob<span class="token punctuation">,</span> levels<span class="token punctuation">,</span> image_shapes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 调整预测的boxes信息，将越界的坐标调整到图片边界上</span>
            boxes <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>clip_boxes_to_image<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> img_shape<span class="token punctuation">)</span>

            <span class="token comment"># 返回boxes满足宽，高都大于min_size的索引</span>
            keep <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>remove_small_boxes<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>min_size<span class="token punctuation">)</span>
            <span class="token comment"># 获取滤除小目标后的proposal</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> lvl <span class="token operator">=</span> boxes<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> lvl<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

            <span class="token comment"># 移除小概率boxes，参考下面这个链接</span>
            <span class="token comment"># https://github.com/pytorch/vision/pull/3205</span>
            keep <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ge<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score_thresh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ge: >=</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> lvl <span class="token operator">=</span> boxes<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> lvl<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

            <span class="token comment"># non-maximum suppression, independently done per level</span>
            <span class="token comment"># keep是执行nms处理后且按照目标类别分数进行排序后输出的idx</span>
            keep <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>batched_nms<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> lvl<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">)</span>

            <span class="token comment"># keep only topk scoring predictions</span>
            <span class="token comment"># 获取前post_nms_top_n个索引</span>
            keep <span class="token operator">=</span> keep<span class="token punctuation">[</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>post_nms_top_n<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment"># 得到最终的proposal和scores</span>
            boxes<span class="token punctuation">,</span> scores <span class="token operator">=</span> boxes<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

            <span class="token comment"># 添加到列表中</span>
            final_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
            final_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>scores<span class="token punctuation">)</span>
        <span class="token keyword">return</span> final_boxes<span class="token punctuation">,</span> final_scores

    <span class="token keyword">def</span> <span class="token function">compute_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> pred_bbox_deltas<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Tensor, Tensor, List[Tensor], List[Tensor]) -> Tuple[Tensor, Tensor]</span>
        <span class="token triple-quoted-string string">"""
        计算RPN损失，包括类别损失（前景与背景），bbox regression损失
        Arguments:
            objectness (Tensor)：预测的前景概率
            pred_bbox_deltas (Tensor)：预测的bbox regression
            labels (List[Tensor])：真实的标签 1, 0, -1（batch中每一张图片的labels对应List的一个元素中）
            regression_targets (List[Tensor])：真实的bbox regression

        Returns:
            objectness_loss (Tensor) : 类别损失
            box_loss (Tensor)：边界框回归损失
        """</span>
        <span class="token comment"># 按照给定的batch_size_per_image, positive_fraction选择正负样本</span>
        sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>fg_bg_sampler<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        <span class="token comment"># 将一个batch中的所有正负样本List(Tensor)分别拼接在一起，并获取非零位置的索引</span>
        <span class="token comment"># sampled_pos_inds = torch.nonzero(torch.cat(sampled_pos_inds, dim=0)).squeeze(1)</span>
        sampled_pos_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>sampled_pos_inds<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># sampled_neg_inds = torch.nonzero(torch.cat(sampled_neg_inds, dim=0)).squeeze(1)</span>
        sampled_neg_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>sampled_neg_inds<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token comment"># 将所有正负样本索引拼接在一起</span>
        sampled_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        objectness <span class="token operator">=</span> objectness<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>

        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        regression_targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>regression_targets<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算边界框回归损失 -> 只需计算正样本的损失</span>
        box_loss <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>smooth_l1_loss<span class="token punctuation">(</span>
            pred_bbox_deltas<span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">]</span><span class="token punctuation">,</span>
            regression_targets<span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">]</span><span class="token punctuation">,</span>
            beta<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">,</span>
            size_average<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>sampled_inds<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算目标预测概率损失，损失函数为BCE；logits表明传入的分数不需要进行任何预处理</span>
        objectness_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>
            objectness<span class="token punctuation">[</span>sampled_inds<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>sampled_inds<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">return</span> objectness_loss<span class="token punctuation">,</span> box_loss

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                images<span class="token punctuation">,</span>        <span class="token comment"># type: ImageList</span>
                features<span class="token punctuation">,</span>      <span class="token comment"># type: Dict[str, Tensor]</span>
                targets<span class="token operator">=</span><span class="token boolean">None</span>   <span class="token comment"># type: Optional[List[Dict[str, Tensor]]]</span>
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> Tuple[List[Tensor], Dict[str, Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            images (ImageList): images for which we want to compute the predictions
            features (Dict[Tensor]): features computed from the images that are
                used for computing the predictions. Each tensor in the list
                correspond to different feature levels
            targets (List[Dict[Tensor]): ground-truth boxes present in the image (optional).
                If provided, each element in the dict should contain a field `boxes`,
                with the locations of the ground-truth boxes.

        Returns:
            boxes (List[Tensor]): the predicted boxes from the RPN, one Tensor per
                image.
            losses (Dict[Tensor]): the losses for the model during training. During
                testing, it is an empty dict.
        """</span>
        <span class="token comment"># RPN uses all feature maps that are available</span>
        <span class="token comment"># features是所有预测特征层组成的OrderedDict</span>
        features <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 其中每一个预测特征图层中元素的大小为：[BS, C, H, W]</span>

        <span class="token comment"># 计算每个预测特征层上的预测目标概率objectness和bboxes regression参数pred_bbox_deltas</span>
        <span class="token comment"># objectness和pred_bbox_deltas都是list</span>
        <span class="token comment"># objectness: [BS, 15, H, W]</span>
        <span class="token comment"># pred_bbox_deltas: [BS, 15*4, H, W] = [BS, 60, H, W]</span>
        objectness<span class="token punctuation">,</span> pred_bbox_deltas <span class="token operator">=</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>features<span class="token punctuation">)</span>

        <span class="token comment"># 生成一个batch图像的所有anchors信息,list(tensor)元素个数等于batch_size</span>
        <span class="token comment"># images: 两部分 -> ① image_sizes：这1个batch中每张图片的H和W； ② tensors：[BS, C, H, W]</span>
        anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchor_generator<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">)</span>

        <span class="token comment"># batch_size</span>
        <span class="token comment"># anchors：是一个list，list中每一个元素代表了每一个图片对应的anchors信息，因为batch=8，所以有8个元素（每个元素的shape为：[14625, 4]）</span>
        num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors<span class="token punctuation">)</span>  <span class="token comment"># 计算一个batch中有多少张图片（这里为8）</span>

        <span class="token comment"># numel() Returns the total number of elements in the input tensor.</span>
        <span class="token comment"># 计算每个预测特征层上的对应的anchors数量</span>
        num_anchors_per_level_shape_tensors <span class="token operator">=</span> <span class="token punctuation">[</span>o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape <span class="token keyword">for</span> o <span class="token keyword">in</span> objectness<span class="token punctuation">]</span>  <span class="token comment"># [15, H, W]</span>
        <span class="token comment"># 每个特征矩阵的每个cell会生成15个anchors，而特征矩阵的长度和宽度分别为H和W，所以一共会生成15*H*W个anchors</span>
        num_anchors_per_level <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> num_anchors_per_level_shape_tensors<span class="token punctuation">]</span>  <span class="token comment"># [14625]</span>

        <span class="token comment"># 调整内部tensor格式以及shape</span>
        objectness<span class="token punctuation">,</span> pred_bbox_deltas <span class="token operator">=</span> concat_box_prediction_layers<span class="token punctuation">(</span>objectness<span class="token punctuation">,</span>
                                                                    pred_bbox_deltas<span class="token punctuation">)</span>

        <span class="token comment"># apply pred_bbox_deltas to anchors to obtain the decoded proposals</span>
        <span class="token comment"># note that we detach the deltas because Faster R-CNN do not backprop through</span>
        <span class="token comment"># the proposals</span>
        <span class="token comment"># 将预测的bbox regression参数应用到anchors上得到最终预测bbox坐标</span>
        proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>pred_bbox_deltas<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> anchors<span class="token punctuation">)</span>
        proposals <span class="token operator">=</span> proposals<span class="token punctuation">.</span>view<span class="token punctuation">(</span>num_images<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># [BS, anchor数量，4]</span>

        <span class="token comment"># 筛除小boxes框，nms处理，根据预测概率获取前post_nms_top_n个目标</span>
        boxes<span class="token punctuation">,</span> scores <span class="token operator">=</span> self<span class="token punctuation">.</span>filter_proposals<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> num_anchors_per_level<span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">"""
            如果是训练模式，则计算损失
        """</span>
        losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token comment"># 计算每个anchors最匹配的gt，并将anchors进行分类，前景，背景以及废弃的anchors</span>
            labels<span class="token punctuation">,</span> matched_gt_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>assign_targets_to_anchors<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
            <span class="token comment"># 结合anchors以及对应的gt，计算regression参数</span>
            <span class="token comment"># matched_gt_boxes：每个anchor所匹配的GT</span>
            <span class="token comment"># anchors：每个anchors的坐标</span>
            <span class="token comment"># 根据这两个参数计算回归损失</span>
            regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>matched_gt_boxes<span class="token punctuation">,</span> anchors<span class="token punctuation">)</span>
            loss_objectness<span class="token punctuation">,</span> loss_rpn_box_reg <span class="token operator">=</span> self<span class="token punctuation">.</span>compute_loss<span class="token punctuation">(</span>
                objectness<span class="token punctuation">,</span> pred_bbox_deltas<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets
            <span class="token punctuation">)</span>
            losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"loss_objectness"</span><span class="token punctuation">:</span> loss_objectness<span class="token punctuation">,</span>
                <span class="token string">"loss_rpn_box_reg"</span><span class="token punctuation">:</span> loss_rpn_box_reg
            <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> boxes<span class="token punctuation">,</span> losses
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="detection-utils">4.4 Detection utils</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> math
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Tuple
<span class="token keyword">from</span> torch <span class="token keyword">import</span> Tensor


<span class="token keyword">class</span> <span class="token class-name">BalancedPositiveNegativeSampler</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    This class samples batches, ensuring that they contain a fixed proportion of positives
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size_per_image<span class="token punctuation">,</span> positive_fraction<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (int, float) -> None</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            batch_size_per_image (int): number of elements to be selected per image
            positive_fraction (float): percentage of positive elements per batch
        """</span>
        self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">=</span> batch_size_per_image
        self<span class="token punctuation">.</span>positive_fraction <span class="token operator">=</span> positive_fraction

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> matched_idxs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor]) -> Tuple[List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            matched idxs: list of tensors containing -1, 0 or positive values.
                Each tensor corresponds to a specific image.
                -1 values are ignored, 0 are considered as negatives and > 0 as
                positives.

        Returns:
            pos_idx (list[tensor])
            neg_idx (list[tensor])

        Returns two lists of binary masks for each image.
        The first list contains the positive elements that were selected,
        and the second list the negative example.
        """</span>
        pos_idx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        neg_idx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 遍历每张图像的matched_idxs</span>
        <span class="token keyword">for</span> matched_idxs_per_image <span class="token keyword">in</span> matched_idxs<span class="token punctuation">:</span>
            <span class="token comment"># >= 1的为正样本, nonzero返回非零元素索引</span>
            <span class="token comment"># positive = torch.nonzero(matched_idxs_per_image >= 1).squeeze(1)</span>
            positive <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ge<span class="token punctuation">(</span>matched_idxs_per_image<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment"># = 0的为负样本</span>
            <span class="token comment"># negative = torch.nonzero(matched_idxs_per_image == 0).squeeze(1)</span>
            negative <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>matched_idxs_per_image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            <span class="token comment"># 指定正样本的数量</span>
            num_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">*</span> self<span class="token punctuation">.</span>positive_fraction<span class="token punctuation">)</span>
            <span class="token comment"># protect against not enough positive examples</span>
            <span class="token comment"># 如果正样本数量不够就直接采用所有正样本</span>
            num_pos <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>positive<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_pos<span class="token punctuation">)</span>
            <span class="token comment"># 指定负样本数量</span>
            num_neg <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">-</span> num_pos
            <span class="token comment"># protect against not enough negative examples</span>
            <span class="token comment"># 如果负样本数量不够就直接采用所有负样本</span>
            num_neg <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>negative<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_neg<span class="token punctuation">)</span>

            <span class="token comment"># randomly select positive and negative examples</span>
            <span class="token comment"># Returns a random permutation of integers from 0 to n - 1.</span>
            <span class="token comment"># 随机选择指定数量的正负样本</span>
            <span class="token triple-quoted-string string">"""
                >>> perm1 = torch.randperm(200)[:7]
                >>> perm2 = torch.randperm(500)[:249]
                >>> perm1
                tensor([185, 148, 155,   2,  37, 160,  56])
                >>> perm2.numel()
                249
            """</span>
            perm1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>positive<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>positive<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>num_pos<span class="token punctuation">]</span>
            perm2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>negative<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>negative<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>num_neg<span class="token punctuation">]</span>

            pos_idx_per_image <span class="token operator">=</span> positive<span class="token punctuation">[</span>perm1<span class="token punctuation">]</span>
            neg_idx_per_image <span class="token operator">=</span> negative<span class="token punctuation">[</span>perm2<span class="token punctuation">]</span>

            <span class="token comment"># create binary mask from indices</span>
            pos_idx_per_image_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>
                matched_idxs_per_image<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>uint8
            <span class="token punctuation">)</span>
            neg_idx_per_image_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>
                matched_idxs_per_image<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>uint8
            <span class="token punctuation">)</span>

            pos_idx_per_image_mask<span class="token punctuation">[</span>pos_idx_per_image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
            neg_idx_per_image_mask<span class="token punctuation">[</span>neg_idx_per_image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

            pos_idx<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pos_idx_per_image_mask<span class="token punctuation">)</span>
            neg_idx<span class="token punctuation">.</span>append<span class="token punctuation">(</span>neg_idx_per_image_mask<span class="token punctuation">)</span>

        <span class="token keyword">return</span> pos_idx<span class="token punctuation">,</span> neg_idx


<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>_script_if_tracing</span>
<span class="token keyword">def</span> <span class="token function">encode_boxes</span><span class="token punctuation">(</span>reference_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> weights<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (torch.Tensor, torch.Tensor, torch.Tensor) -> torch.Tensor</span>
    <span class="token triple-quoted-string string">"""
    Encode a set of proposals with respect to some
    reference boxes

    Arguments:
        reference_boxes (Tensor): reference boxes(gt)
        proposals (Tensor): boxes to be encoded(anchors)
        weights:
    """</span>

    <span class="token comment"># perform some unpacking to make it JIT-fusion friendly</span>
    wx <span class="token operator">=</span> weights<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    wy <span class="token operator">=</span> weights<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    ww <span class="token operator">=</span> weights<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    wh <span class="token operator">=</span> weights<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

    <span class="token comment"># unsqueeze()</span>
    <span class="token comment"># Returns a new tensor with a dimension of size one inserted at the specified position.</span>
    proposals_x1 <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    proposals_y1 <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    proposals_x2 <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    proposals_y2 <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    reference_boxes_x1 <span class="token operator">=</span> reference_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    reference_boxes_y1 <span class="token operator">=</span> reference_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    reference_boxes_x2 <span class="token operator">=</span> reference_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    reference_boxes_y2 <span class="token operator">=</span> reference_boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># implementation starts here</span>
    <span class="token comment"># parse widths and heights</span>
    ex_widths <span class="token operator">=</span> proposals_x2 <span class="token operator">-</span> proposals_x1
    ex_heights <span class="token operator">=</span> proposals_y2 <span class="token operator">-</span> proposals_y1
    <span class="token comment"># parse coordinate of center point</span>
    ex_ctr_x <span class="token operator">=</span> proposals_x1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> ex_widths
    ex_ctr_y <span class="token operator">=</span> proposals_y1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> ex_heights

    gt_widths <span class="token operator">=</span> reference_boxes_x2 <span class="token operator">-</span> reference_boxes_x1
    gt_heights <span class="token operator">=</span> reference_boxes_y2 <span class="token operator">-</span> reference_boxes_y1
    gt_ctr_x <span class="token operator">=</span> reference_boxes_x1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> gt_widths
    gt_ctr_y <span class="token operator">=</span> reference_boxes_y1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> gt_heights

    targets_dx <span class="token operator">=</span> wx <span class="token operator">*</span> <span class="token punctuation">(</span>gt_ctr_x <span class="token operator">-</span> ex_ctr_x<span class="token punctuation">)</span> <span class="token operator">/</span> ex_widths
    targets_dy <span class="token operator">=</span> wy <span class="token operator">*</span> <span class="token punctuation">(</span>gt_ctr_y <span class="token operator">-</span> ex_ctr_y<span class="token punctuation">)</span> <span class="token operator">/</span> ex_heights
    targets_dw <span class="token operator">=</span> ww <span class="token operator">*</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>gt_widths <span class="token operator">/</span> ex_widths<span class="token punctuation">)</span>
    targets_dh <span class="token operator">=</span> wh <span class="token operator">*</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>gt_heights <span class="token operator">/</span> ex_heights<span class="token punctuation">)</span>

    targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets_dx<span class="token punctuation">,</span> targets_dy<span class="token punctuation">,</span> targets_dw<span class="token punctuation">,</span> targets_dh<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> targets


<span class="token keyword">class</span> <span class="token class-name">BoxCoder</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    This class encodes and decodes a set of bounding boxes into
    the representation used for training the regressors.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> bbox_xform_clip<span class="token operator">=</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1000.</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Tuple[float, float, float, float], float) -> None</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            weights (4-element tuple)
            bbox_xform_clip (float)
        """</span>
        self<span class="token punctuation">.</span>weights <span class="token operator">=</span> weights
        self<span class="token punctuation">.</span>bbox_xform_clip <span class="token operator">=</span> bbox_xform_clip

    <span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reference_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], List[Tensor]) -> List[Tensor]</span>
        <span class="token triple-quoted-string string">"""
        结合anchors和与之对应的gt计算regression参数
        Args:
            reference_boxes: List[Tensor] 每个proposal/anchor对应的gt_boxes
            proposals: List[Tensor] anchors/proposals

        Returns: regression parameters

        """</span>
        <span class="token comment"># 统计每张图像的anchors个数，方便后面拼接在一起处理后在分开</span>
        <span class="token comment"># reference_boxes和proposal数据结构相同</span>
        boxes_per_image <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> reference_boxes<span class="token punctuation">]</span>
        reference_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>reference_boxes<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        proposals <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># targets_dx, targets_dy, targets_dw, targets_dh</span>
        targets <span class="token operator">=</span> self<span class="token punctuation">.</span>encode_single<span class="token punctuation">(</span>reference_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>
        <span class="token keyword">return</span> targets<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encode_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reference_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Encode a set of proposals with respect to some
        reference boxes

        Arguments:
            reference_boxes (Tensor): reference boxes
            proposals (Tensor): boxes to be encoded
        """</span>
        dtype <span class="token operator">=</span> reference_boxes<span class="token punctuation">.</span>dtype
        device <span class="token operator">=</span> reference_boxes<span class="token punctuation">.</span>device
        weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        targets <span class="token operator">=</span> encode_boxes<span class="token punctuation">(</span>reference_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> weights<span class="token punctuation">)</span>

        <span class="token keyword">return</span> targets

    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rel_codes<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Tensor, List[Tensor]) -> Tensor</span>
        <span class="token triple-quoted-string string">"""

        Args:
            rel_codes: bbox regression parameters
            boxes: anchors/proposals

        Returns:

        """</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>rel_codes<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
        boxes_per_image <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> boxes<span class="token punctuation">]</span>
        concat_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        box_sum <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> val <span class="token keyword">in</span> boxes_per_image<span class="token punctuation">:</span>
            box_sum <span class="token operator">+=</span> val

        <span class="token comment"># 将预测的bbox回归参数应用到对应anchors上得到预测bbox的坐标</span>
        pred_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>decode_single<span class="token punctuation">(</span>
            rel_codes<span class="token punctuation">,</span> concat_boxes
        <span class="token punctuation">)</span>

        <span class="token comment"># 防止pred_boxes为空时导致reshape报错</span>
        <span class="token keyword">if</span> box_sum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            pred_boxes <span class="token operator">=</span> pred_boxes<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>box_sum<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> pred_boxes

    <span class="token keyword">def</span> <span class="token function">decode_single</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rel_codes<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        From a set of original boxes and encoded relative box offsets,
        get the decoded boxes.

        Arguments:
            rel_codes (Tensor): encoded boxes (bbox regression parameters)
            boxes (Tensor): reference boxes (anchors/proposals)
        """</span>
        boxes <span class="token operator">=</span> boxes<span class="token punctuation">.</span>to<span class="token punctuation">(</span>rel_codes<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>

        <span class="token comment"># xmin, ymin, xmax, ymax</span>
        widths <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>   <span class="token comment"># anchor/proposal宽度</span>
        heights <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># anchor/proposal高度</span>
        ctr_x <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> widths   <span class="token comment"># anchor/proposal中心x坐标</span>
        ctr_y <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> heights  <span class="token comment"># anchor/proposal中心y坐标</span>

        wx<span class="token punctuation">,</span> wy<span class="token punctuation">,</span> ww<span class="token punctuation">,</span> wh <span class="token operator">=</span> self<span class="token punctuation">.</span>weights  <span class="token comment"># RPN中为[1,1,1,1], fastrcnn中为[10,10,5,5]</span>
        dx <span class="token operator">=</span> rel_codes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">/</span> wx   <span class="token comment"># 预测anchors/proposals的中心坐标x回归参数</span>
        dy <span class="token operator">=</span> rel_codes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">/</span> wy   <span class="token comment"># 预测anchors/proposals的中心坐标y回归参数</span>
        dw <span class="token operator">=</span> rel_codes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">/</span> ww   <span class="token comment"># 预测anchors/proposals的宽度回归参数</span>
        dh <span class="token operator">=</span> rel_codes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">/</span> wh   <span class="token comment"># 预测anchors/proposals的高度回归参数</span>

        <span class="token comment"># limit max value, prevent sending too large values into torch.exp()</span>
        <span class="token comment"># self.bbox_xform_clip=math.log(1000. / 16)   4.135</span>
        dw <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>dw<span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>self<span class="token punctuation">.</span>bbox_xform_clip<span class="token punctuation">)</span>
        dh <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>dh<span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>self<span class="token punctuation">.</span>bbox_xform_clip<span class="token punctuation">)</span>

        pred_ctr_x <span class="token operator">=</span> dx <span class="token operator">*</span> widths<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> ctr_x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
        pred_ctr_y <span class="token operator">=</span> dy <span class="token operator">*</span> heights<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> ctr_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
        pred_w <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>dw<span class="token punctuation">)</span> <span class="token operator">*</span> widths<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
        pred_h <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>dh<span class="token punctuation">)</span> <span class="token operator">*</span> heights<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

        <span class="token comment"># xmin</span>
        pred_boxes1 <span class="token operator">=</span> pred_ctr_x <span class="token operator">-</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pred_ctr_x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pred_w<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> pred_w
        <span class="token comment"># ymin</span>
        pred_boxes2 <span class="token operator">=</span> pred_ctr_y <span class="token operator">-</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pred_ctr_y<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pred_h<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> pred_h
        <span class="token comment"># xmax</span>
        pred_boxes3 <span class="token operator">=</span> pred_ctr_x <span class="token operator">+</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pred_ctr_x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pred_w<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> pred_w
        <span class="token comment"># ymax</span>
        pred_boxes4 <span class="token operator">=</span> pred_ctr_y <span class="token operator">+</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pred_ctr_y<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pred_h<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> pred_h

        pred_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>pred_boxes1<span class="token punctuation">,</span> pred_boxes2<span class="token punctuation">,</span> pred_boxes3<span class="token punctuation">,</span> pred_boxes4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pred_boxes


<span class="token keyword">class</span> <span class="token class-name">Matcher</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    BELOW_LOW_THRESHOLD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    BETWEEN_THRESHOLDS <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>

    __annotations__ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'BELOW_LOW_THRESHOLD'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        <span class="token string">'BETWEEN_THRESHOLDS'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> high_threshold<span class="token punctuation">,</span> low_threshold<span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (float, float, bool) -> None</span>
        <span class="token triple-quoted-string string">"""
        Args:
            high_threshold (float): quality values greater than or equal to
                this value are candidate matches.
            low_threshold (float): a lower quality threshold used to stratify
                matches into three levels:
                1) matches >= high_threshold
                2) BETWEEN_THRESHOLDS matches in [low_threshold, high_threshold)
                3) BELOW_LOW_THRESHOLD matches in [0, low_threshold)
            allow_low_quality_matches (bool): if True, produce additional matches
                for predictions that have only low-quality match candidates. See
                set_low_quality_matches_ for more details.
        """</span>
        self<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        self<span class="token punctuation">.</span>BETWEEN_THRESHOLDS <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>
        <span class="token keyword">assert</span> low_threshold <span class="token operator">&lt;=</span> high_threshold
        self<span class="token punctuation">.</span>high_threshold <span class="token operator">=</span> high_threshold  <span class="token comment"># 0.7</span>
        self<span class="token punctuation">.</span>low_threshold <span class="token operator">=</span> low_threshold    <span class="token comment"># 0.3</span>
        self<span class="token punctuation">.</span>allow_low_quality_matches <span class="token operator">=</span> allow_low_quality_matches

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> match_quality_matrix<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算anchors与每个gtboxes匹配的iou最大值，并记录索引，
        iou&lt;low_threshold索引值为-1， low_threshold&lt;=iou&lt;high_threshold索引值为-2
        Args:
            match_quality_matrix (Tensor[float]): an MxN tensor, containing the
            pairwise quality between M ground-truth elements and N predicted elements.

        Returns:
            matches (Tensor[int64]): an N tensor where N[i] is a matched gt in
            [0, M - 1] or a negative value indicating that prediction i could not
            be matched.
        """</span>
        <span class="token keyword">if</span> match_quality_matrix<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># empty targets or proposals not supported during training</span>
            <span class="token keyword">if</span> match_quality_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                    <span class="token string">"No ground-truth boxes available for one of the images "</span>
                    <span class="token string">"during training"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                    <span class="token string">"No proposal boxes available for one of the images "</span>
                    <span class="token string">"during training"</span><span class="token punctuation">)</span>

        <span class="token comment"># match_quality_matrix is M (gt) x N (predicted)</span>
        <span class="token comment"># Max over gt elements (dim 0) to find best gt candidate for each prediction</span>
        <span class="token comment"># M x N 的每一列代表一个anchors与所有gt的匹配iou值</span>
        <span class="token comment"># matched_vals代表每列的最大值，即每个anchors与所有gt匹配的最大iou值</span>
        <span class="token comment"># matches对应最大值所在的索引</span>
        matched_vals<span class="token punctuation">,</span> matches <span class="token operator">=</span> match_quality_matrix<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># the dimension to reduce.</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>allow_low_quality_matches<span class="token punctuation">:</span>
            all_matches <span class="token operator">=</span> matches<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 这里没有用=而是clone，如果用=则是引用，list引用修改的话，list本身也会修改，所以用的是clone</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            all_matches <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># Assign candidate matches with low quality to negative (unassigned) values</span>
        <span class="token comment"># 计算iou小于low_threshold的索引</span>
        below_low_threshold <span class="token operator">=</span> matched_vals <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>low_threshold  <span class="token comment"># 得到一个boolean蒙版</span>
        <span class="token comment"># 计算iou在low_threshold与high_threshold之间的索引值</span>
        between_thresholds <span class="token operator">=</span> <span class="token punctuation">(</span>matched_vals <span class="token operator">>=</span> self<span class="token punctuation">.</span>low_threshold<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>
            matched_vals <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>high_threshold
        <span class="token punctuation">)</span>
        <span class="token comment"># iou小于low_threshold的matches索引置为-1</span>
        matches<span class="token punctuation">[</span>below_low_threshold<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD  <span class="token comment"># -1</span>

        <span class="token comment"># iou在[low_threshold, high_threshold]之间的matches索引置为-2</span>
        matches<span class="token punctuation">[</span>between_thresholds<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>BETWEEN_THRESHOLDS    <span class="token comment"># -2</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>allow_low_quality_matches<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> all_matches <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>set_low_quality_matches_<span class="token punctuation">(</span>matches<span class="token punctuation">,</span> all_matches<span class="token punctuation">,</span> match_quality_matrix<span class="token punctuation">)</span>

        <span class="token keyword">return</span> matches

    <span class="token keyword">def</span> <span class="token function">set_low_quality_matches_</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> all_matches<span class="token punctuation">,</span> match_quality_matrix<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Produce additional matches for predictions that have only low-quality matches.
        Specifically, for each ground-truth find the set of predictions that have
        maximum overlap with it (including ties); for each prediction in that set, if
        it is unmatched, then match it to the ground-truth with which it has the highest
        quality value.
        为只有低质量匹配的预测生成额外的匹配。
        具体来说，对于每个ground-truth，找到与其有最大重叠（包括关系）的一组预测；
        对于该集合中的每个预测，如果不匹配，则将其与具有最高质量值的gt实况进行匹配。
        """</span>
        <span class="token comment"># For each gt, find the prediction with which it has highest quality</span>
        <span class="token comment"># 对于每个gt boxes寻找与其iou最大的anchor，</span>
        <span class="token comment"># highest_quality_foreach_gt为匹配到的最大iou值 -> [0.8, 0.85, 0.9, 0.65]</span>
        highest_quality_foreach_gt<span class="token punctuation">,</span> _ <span class="token operator">=</span> match_quality_matrix<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># the dimension to reduce.</span>

        <span class="token comment"># Find highest quality match available, even if it is low, including ties</span>
        <span class="token comment"># 寻找每个gt boxes与其iou最大的anchor索引，一个gt匹配到的最大iou可能有多个anchor</span>
        <span class="token comment"># gt_pred_pairs_of_highest_quality = torch.nonzero(</span>
        <span class="token comment">#     match_quality_matrix == highest_quality_foreach_gt[:, None]</span>
        <span class="token comment"># )</span>
        <span class="token triple-quoted-string string">"""
            torch.where(condition，a，b)
            其中：
                输入参数condition：条件限制，如果满足条件，则选择a，否则选择b作为输出。
            注意：
                a和b是tensor
                torch.where(condition) is identical to torch.nonzero(condition, as_tuple=True).
                
            这里的torch.where等价于torch.nonzero
            
            torch.nonzero(input_tensor)：返回输入tensor非零元素的坐标
            
            例子：
                >>> torch.nonzero(torch.Tensor([[0.6, 0.0, 0.0, 0.0],
                ...                             [0.0, 0.4, 0.0, 0.0],
                ...                             [0.0, 0.0, 1.2, 0.0],
                ...                             [0.0, 0.0, 0.0,-0.4]]))
                ==输出==
                 0  0
                 1  1
                 2  2
                 3  3
                对于输出需要一行一行的解读：
                    第一行：0 0     输入tensor的[0, 0]是一个非零元素
                    第二行：1 1     输入tensor的[1, 1]是一个非零元素
                    ...

        """</span>
        gt_pred_pairs_of_highest_quality <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>match_quality_matrix<span class="token punctuation">,</span> highest_quality_foreach_gt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  <span class="token comment"># [[0, 3], [1, 1], [2, 0], [3, 5]]</span>
        <span class="token comment"># Example gt_pred_pairs_of_highest_quality:</span>
        <span class="token comment">#   tensor([[    0, 39796],</span>
        <span class="token comment">#           [    1, 32055],</span>
        <span class="token comment">#           [    1, 32070],</span>
        <span class="token comment">#           [    2, 39190],</span>
        <span class="token comment">#           [    2, 40255],</span>
        <span class="token comment">#           [    3, 40390],</span>
        <span class="token comment">#           [    3, 41455],</span>
        <span class="token comment">#           [    4, 45470],</span>
        <span class="token comment">#           [    5, 45325],</span>
        <span class="token comment">#           [    5, 46390]])</span>
        <span class="token comment"># Each row is a (gt index, prediction index)</span>
        <span class="token comment"># Note how gt items 1, 2, 3, and 5 each have two ties</span>

        <span class="token comment"># gt_pred_pairs_of_highest_quality[:, 0]代表是对应的gt index(不需要)</span>
        <span class="token comment"># pre_inds_to_update = gt_pred_pairs_of_highest_quality[:, 1]</span>
        pre_inds_to_update <span class="token operator">=</span> gt_pred_pairs_of_highest_quality<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># 保留该anchor匹配gt最大iou的索引，即使iou低于设定的阈值</span>
        matches<span class="token punctuation">[</span>pre_inds_to_update<span class="token punctuation">]</span> <span class="token operator">=</span> all_matches<span class="token punctuation">[</span>pre_inds_to_update<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">smooth_l1_loss</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> beta<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">,</span> size_average<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    very similar to the smooth_l1_loss from pytorch, but with
    the extra beta parameter
    """</span>
    n <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator">-</span> target<span class="token punctuation">)</span>
    <span class="token comment"># cond = n &lt; beta</span>
    cond <span class="token operator">=</span> torch<span class="token punctuation">.</span>lt<span class="token punctuation">(</span>n<span class="token punctuation">,</span> beta<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> <span class="token number">0.5</span> <span class="token operator">*</span> n <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">/</span> beta<span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> beta<span class="token punctuation">)</span>
    <span class="token keyword">if</span> size_average<span class="token punctuation">:</span>
        <span class="token keyword">return</span> loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="roi-aligntwo-mlp-head-faster-r-cnn-predictor">4.5 ROI Align、Two MLP Head、 Faster R-CNN Predictor</h2><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211171618376.png"></p><h3 id="roi-align">4.5.1 ROI Align</h3><p>ROI Align对应的图中的ROI Pooling，代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>ops <span class="token keyword">import</span> MultiScaleRoIAlign
<span class="token comment">#  Multi-scale RoIAlign pooling</span>
<span class="token keyword">if</span> box_roi_pool <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    box_roi_pool <span class="token operator">=</span> MultiScaleRoIAlign<span class="token punctuation">(</span>  <span class="token comment"># 这里就是ROI Pooling</span>
        featmap_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 在哪些特征层进行roi pooling</span>
        output_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 这里给出了ROI Pooling后输出的shape</span>
        sampling_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该方法PyTorch官方已经实现，且已被封装，直接用就可以</p><h3 id="two-mlp-head">4.5.2 Two MLP Head</h3><p>这里是将经过ROI Pooling后的proposal feature map送入这两个全连接层，代码如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Tuple

<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> Tensor
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> det_utils
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> boxes <span class="token keyword">as</span> box_ops


<span class="token keyword">def</span> <span class="token function">fastrcnn_loss</span><span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> box_regression<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (Tensor, Tensor, List[Tensor], List[Tensor]) -> Tuple[Tensor, Tensor]</span>
    <span class="token triple-quoted-string string">"""
    Computes the loss for Faster R-CNN.

    Arguments:
        class_logits : 预测类别概率信息，shape=[num_anchors, num_classes]
        box_regression : 预测边目标界框回归信息
        labels : 真实类别信息
        regression_targets : 真实目标边界框信息

    Returns:
        classification_loss (Tensor)
        box_loss (Tensor)
    """</span>

    labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    regression_targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>regression_targets<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算类别损失信息</span>
    classification_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>

    <span class="token comment"># get indices that correspond to the regression targets for</span>
    <span class="token comment"># the corresponding ground truth labels, to be used with</span>
    <span class="token comment"># advanced indexing</span>
    <span class="token comment"># 返回标签类别大于0的索引</span>
    <span class="token comment"># sampled_pos_inds_subset = torch.nonzero(torch.gt(labels, 0)).squeeze(1)</span>
    sampled_pos_inds_subset <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># 返回标签类别大于0位置的类别信息</span>
    labels_pos <span class="token operator">=</span> labels<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">]</span>

    <span class="token comment"># shape=[num_proposal, num_classes]</span>
    N<span class="token punctuation">,</span> num_classes <span class="token operator">=</span> class_logits<span class="token punctuation">.</span>shape
    box_regression <span class="token operator">=</span> box_regression<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算边界框损失信息</span>
    box_loss <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>smooth_l1_loss<span class="token punctuation">(</span>
        <span class="token comment"># 获取指定索引proposal的指定类别box信息</span>
        box_regression<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">,</span> labels_pos<span class="token punctuation">]</span><span class="token punctuation">,</span>
        regression_targets<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">]</span><span class="token punctuation">,</span>
        beta<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">,</span>
        size_average<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">/</span> labels<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> classification_loss<span class="token punctuation">,</span> box_loss


<span class="token keyword">class</span> <span class="token class-name">RoIHeads</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __annotations__ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'box_coder'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>BoxCoder<span class="token punctuation">,</span>
        <span class="token string">'proposal_matcher'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>Matcher<span class="token punctuation">,</span>
        <span class="token string">'fg_bg_sampler'</span><span class="token punctuation">:</span> det_utils<span class="token punctuation">.</span>BalancedPositiveNegativeSampler<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 box_roi_pool<span class="token punctuation">,</span>   <span class="token comment"># Multi-scale RoIAlign pooling</span>
                 box_head<span class="token punctuation">,</span>       <span class="token comment"># TwoMLPHead</span>
                 box_predictor<span class="token punctuation">,</span>  <span class="token comment"># FastRCNNPredictor</span>
                 <span class="token comment"># Faster R-CNN training</span>
                 fg_iou_thresh<span class="token punctuation">,</span> bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># default: 0.5, 0.5</span>
                 batch_size_per_image<span class="token punctuation">,</span> positive_fraction<span class="token punctuation">,</span>  <span class="token comment"># default: 512, 0.25</span>
                 bbox_reg_weights<span class="token punctuation">,</span>  <span class="token comment"># None</span>
                 <span class="token comment"># Faster R-CNN inference</span>
                 score_thresh<span class="token punctuation">,</span>        <span class="token comment"># default: 0.05</span>
                 nms_thresh<span class="token punctuation">,</span>          <span class="token comment"># default: 0.5</span>
                 detection_per_img<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># default: 100</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RoIHeads<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">"""
            .box_iou是一个方法，用来计算IoU值
        """</span>
        self<span class="token punctuation">.</span>box_similarity <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>box_iou  <span class="token comment"># 将计算IoU的方法赋值给self.box_similarity</span>
        <span class="token comment"># assign ground-truth boxes for each proposal</span>

        <span class="token triple-quoted-string string">"""
            Matcher在RPN中也使用到了，作用是将proposal划分到正负样本当中
        """</span>
        self<span class="token punctuation">.</span>proposal_matcher <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>Matcher<span class="token punctuation">(</span>  <span class="token comment"># 将Matcher类赋值给self.proposal_matcher</span>
            fg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># default: 0.5</span>
            bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># default: 0.5</span>
            allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">"""
            BalancedPositiveNegativeSampler在RPN时也用到了，作用是将划分好的正负样本进行采样
                参数：
                    batch_size_per_image： 总共采样512个样本
                    positive_fraction：正样本占25%
        """</span>
        self<span class="token punctuation">.</span>fg_bg_sampler <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>BalancedPositiveNegativeSampler<span class="token punctuation">(</span>
            batch_size_per_image<span class="token punctuation">,</span>  <span class="token comment"># default: 512</span>
            positive_fraction<span class="token punctuation">)</span>     <span class="token comment"># default: 0.25</span>

        <span class="token keyword">if</span> bbox_reg_weights <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            bbox_reg_weights <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">)</span>  <span class="token comment"># 超参数</span>
        self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> det_utils<span class="token punctuation">.</span>BoxCoder<span class="token punctuation">(</span>bbox_reg_weights<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>box_roi_pool <span class="token operator">=</span> box_roi_pool    <span class="token comment"># Multi-scale RoIAlign pooling</span>
        self<span class="token punctuation">.</span>box_head <span class="token operator">=</span> box_head            <span class="token comment"># TwoMLPHead</span>
        self<span class="token punctuation">.</span>box_predictor <span class="token operator">=</span> box_predictor  <span class="token comment"># FastRCNNPredictor</span>

        self<span class="token punctuation">.</span>score_thresh <span class="token operator">=</span> score_thresh  <span class="token comment"># default: 0.05</span>
        self<span class="token punctuation">.</span>nms_thresh <span class="token operator">=</span> nms_thresh      <span class="token comment"># default: 0.5</span>
        self<span class="token punctuation">.</span>detection_per_img <span class="token operator">=</span> detection_per_img  <span class="token comment"># default: 100</span>

    <span class="token keyword">def</span> <span class="token function">assign_targets_to_proposals</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], List[Tensor], List[Tensor]) -> Tuple[List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        为每个proposal匹配对应的gt_box，并划分到正负样本中
        Args:
            proposals:
            gt_boxes:
            gt_labels:

        Returns:

        """</span>
        matched_idxs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 遍历每张图像的proposals, gt_boxes, gt_labels信息</span>
        <span class="token keyword">for</span> proposals_in_image<span class="token punctuation">,</span> gt_boxes_in_image<span class="token punctuation">,</span> gt_labels_in_image <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> gt_boxes_in_image<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 该张图像中没有gt框，为背景</span>
                <span class="token comment"># background image</span>
                device <span class="token operator">=</span> proposals_in_image<span class="token punctuation">.</span>device
                clamped_matched_idxs_in_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>proposals_in_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device
                <span class="token punctuation">)</span>
                labels_in_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>proposals_in_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device
                <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment">#  set to self.box_similarity when https://github.com/pytorch/pytorch/issues/27495 lands</span>
                <span class="token comment"># 计算proposal与每个gt_box的iou重合度</span>
                match_quality_matrix <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>gt_boxes_in_image<span class="token punctuation">,</span> proposals_in_image<span class="token punctuation">)</span>

                <span class="token comment"># 计算proposal与每个gt_box匹配的iou最大值，并记录索引，</span>
                <span class="token comment"># iou &lt; low_threshold索引值为 -1， low_threshold &lt;= iou &lt; high_threshold索引值为 -2</span>
                matched_idxs_in_image <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">(</span>match_quality_matrix<span class="token punctuation">)</span>

                <span class="token comment"># 限制最小值，防止匹配标签时出现越界的情况</span>
                <span class="token comment"># 注意-1, -2对应的gt索引会调整到0,获取的标签类别为第0个gt的类别（实际上并不是）,后续会进一步处理</span>
                clamped_matched_idxs_in_image <span class="token operator">=</span> matched_idxs_in_image<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment"># 获取proposal匹配到的gt对应标签</span>
                labels_in_image <span class="token operator">=</span> gt_labels_in_image<span class="token punctuation">[</span>clamped_matched_idxs_in_image<span class="token punctuation">]</span>
                labels_in_image <span class="token operator">=</span> labels_in_image<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>

                <span class="token comment"># label background (below the low threshold)</span>
                <span class="token comment"># 将gt索引为-1的类别设置为0，即背景，负样本</span>
                bg_inds <span class="token operator">=</span> matched_idxs_in_image <span class="token operator">==</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD  <span class="token comment"># -1</span>
                labels_in_image<span class="token punctuation">[</span>bg_inds<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

                <span class="token comment"># label ignore proposals (between low and high threshold)</span>
                <span class="token comment"># 将gt索引为-2的类别设置为-1, 即废弃样本</span>
                ignore_inds <span class="token operator">=</span> matched_idxs_in_image <span class="token operator">==</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">.</span>BETWEEN_THRESHOLDS  <span class="token comment"># -2</span>
                labels_in_image<span class="token punctuation">[</span>ignore_inds<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># -1 is ignored by sampler</span>

            matched_idxs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>clamped_matched_idxs_in_image<span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_in_image<span class="token punctuation">)</span>
        <span class="token keyword">return</span> matched_idxs<span class="token punctuation">,</span> labels

    <span class="token keyword">def</span> <span class="token function">subsample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor]) -> List[Tensor]</span>
        <span class="token comment"># BalancedPositiveNegativeSampler</span>
        sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>fg_bg_sampler<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        sampled_inds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 遍历每张图片的正负样本索引</span>
        <span class="token keyword">for</span> img_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>pos_inds_img<span class="token punctuation">,</span> neg_inds_img<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 记录所有采集样本索引（包括正样本和负样本）</span>
            <span class="token comment"># img_sampled_inds = torch.nonzero(pos_inds_img | neg_inds_img).squeeze(1)</span>
            img_sampled_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pos_inds_img <span class="token operator">|</span> neg_inds_img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            sampled_inds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img_sampled_inds<span class="token punctuation">)</span>
        <span class="token keyword">return</span> sampled_inds

    <span class="token keyword">def</span> <span class="token function">add_gt_proposals</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], List[Tensor]) -> List[Tensor]</span>
        <span class="token triple-quoted-string string">"""
        将gt_boxes拼接到proposal后面
        Args:
            proposals: 一个batch中每张图像rpn预测的boxes
            gt_boxes:  一个batch中每张图像对应的真实目标边界框

        Returns:

        """</span>
        proposals <span class="token operator">=</span> <span class="token punctuation">[</span>
            torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>proposal<span class="token punctuation">,</span> gt_box<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> proposal<span class="token punctuation">,</span> gt_box <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">return</span> proposals

    <span class="token keyword">def</span> <span class="token function">check_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Optional[List[Dict[str, Tensor]]]) -> None</span>
        <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
        <span class="token keyword">assert</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"boxes"</span> <span class="token keyword">in</span> t <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"labels"</span> <span class="token keyword">in</span> t <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">select_training_samples</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                                proposals<span class="token punctuation">,</span>  <span class="token comment"># type: List[Tensor]</span>
                                targets     <span class="token comment"># type: Optional[List[Dict[str, Tensor]]]</span>
                                <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> Tuple[List[Tensor], List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        划分正负样本，统计对应gt的标签以及边界框回归信息
        list元素个数为batch_size
        Args:
            proposals: rpn预测的boxes
            targets:

        Returns:

        """</span>

        <span class="token comment"># 检查target数据是否为空</span>
        self<span class="token punctuation">.</span>check_targets<span class="token punctuation">(</span>targets<span class="token punctuation">)</span>
        <span class="token comment"># 如果不加这句，jit.script会不通过(看不懂)</span>
        <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>

        dtype <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype
        device <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>device

        <span class="token comment"># 获取标注好的boxes以及labels信息</span>
        gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span>
        gt_labels <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span>

        <span class="token comment"># append ground-truth bboxes to proposal</span>
        <span class="token comment"># 将gt_boxes拼接到proposal后面</span>
        proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>add_gt_proposals<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span>

        <span class="token comment"># get matching gt indices for each proposal</span>
        <span class="token comment"># 为每个proposal匹配对应的gt_box，并划分到正负样本中</span>
        matched_idxs<span class="token punctuation">,</span> labels <span class="token operator">=</span> self<span class="token punctuation">.</span>assign_targets_to_proposals<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">)</span>
        <span class="token comment"># sample a fixed proportion of positive-negative proposals</span>
        <span class="token comment"># 按给定数量和比例采样正负样本</span>
        sampled_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>subsample<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        matched_gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>proposals<span class="token punctuation">)</span>

        <span class="token comment"># 遍历每张图像</span>
        <span class="token keyword">for</span> img_id <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 获取每张图像的正负样本索引</span>
            img_sampled_inds <span class="token operator">=</span> sampled_inds<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span>
            <span class="token comment"># 获取对应正负样本的proposals信息</span>
            proposals<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> proposals<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>
            <span class="token comment"># 获取对应正负样本的真实类别信息</span>
            labels<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> labels<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>
            <span class="token comment"># 获取对应正负样本的gt索引信息</span>
            matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>

            gt_boxes_in_image <span class="token operator">=</span> gt_boxes<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span>
            <span class="token keyword">if</span> gt_boxes_in_image<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                gt_boxes_in_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            <span class="token comment"># 获取对应正负样本的gt box信息</span>
            matched_gt_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gt_boxes_in_image<span class="token punctuation">[</span>matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 根据gt和proposal计算边框回归参数（针对gt的）</span>
        regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>matched_gt_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>
        <span class="token keyword">return</span> proposals<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets

    <span class="token keyword">def</span> <span class="token function">postprocess_detections</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                               class_logits<span class="token punctuation">,</span>    <span class="token comment"># type: Tensor</span>
                               box_regression<span class="token punctuation">,</span>  <span class="token comment"># type: Tensor</span>
                               proposals<span class="token punctuation">,</span>       <span class="token comment"># type: List[Tensor]</span>
                               image_shapes     <span class="token comment"># type: List[Tuple[int, int]]</span>
                               <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> Tuple[List[Tensor], List[Tensor], List[Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        对网络的预测数据进行后处理，包括
        （1）根据proposal以及预测的回归参数计算出最终bbox坐标
        （2）对预测类别结果进行softmax处理
        （3）裁剪预测的boxes信息，将越界的坐标调整到图片边界上
        （4）移除所有背景信息
        （5）移除低概率目标
        （6）移除小尺寸目标
        （7）执行nms处理，并按scores进行排序
        （8）根据scores排序返回前topk个目标
        Args:
            class_logits: 网络预测类别概率信息
            box_regression: 网络预测的边界框回归参数
            proposals: rpn输出的proposal
            image_shapes: 打包成batch前每张图像的宽高

        Returns:

        """</span>
        device <span class="token operator">=</span> class_logits<span class="token punctuation">.</span>device
        <span class="token comment"># 预测目标类别数</span>
        num_classes <span class="token operator">=</span> class_logits<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># 获取每张图像的预测bbox数量</span>
        boxes_per_image <span class="token operator">=</span> <span class="token punctuation">[</span>boxes_in_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> boxes_in_image <span class="token keyword">in</span> proposals<span class="token punctuation">]</span>
        <span class="token comment"># 根据proposal以及预测的回归参数计算出最终bbox坐标</span>
        pred_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>box_regression<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>

        <span class="token comment"># 对预测类别结果进行softmax处理</span>
        pred_scores <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># split boxes and scores per image</span>
        <span class="token comment"># 根据每张图像的预测bbox数量分割结果</span>
        pred_boxes_list <span class="token operator">=</span> pred_boxes<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        pred_scores_list <span class="token operator">=</span> pred_scores<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        all_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 遍历每张图像预测信息</span>
        <span class="token keyword">for</span> boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> image_shape <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>pred_boxes_list<span class="token punctuation">,</span> pred_scores_list<span class="token punctuation">,</span> image_shapes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 裁剪预测的boxes信息，将越界的坐标调整到图片边界上</span>
            boxes <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>clip_boxes_to_image<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span>

            <span class="token comment"># create labels for each prediction</span>
            labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>num_classes<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>scores<span class="token punctuation">)</span>

            <span class="token comment"># remove prediction with the background label</span>
            <span class="token comment"># 移除索引为0的所有信息（0代表背景）</span>
            boxes <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            scores <span class="token operator">=</span> scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

            <span class="token comment"># batch everything, by making every class prediction be a separate instance</span>
            boxes <span class="token operator">=</span> boxes<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
            scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            <span class="token comment"># remove low scoring boxes</span>
            <span class="token comment"># 移除低概率目标，self.scores_thresh=0.05</span>
            <span class="token comment"># gt: Computes input > other element-wise.</span>
            <span class="token comment"># inds = torch.nonzero(torch.gt(scores, self.score_thresh)).squeeze(1)</span>
            inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>gt<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score_thresh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> labels <span class="token operator">=</span> boxes<span class="token punctuation">[</span>inds<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>inds<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>inds<span class="token punctuation">]</span>

            <span class="token comment"># remove empty boxes</span>
            <span class="token comment"># 移除小目标</span>
            keep <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>remove_small_boxes<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">)</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> labels <span class="token operator">=</span> boxes<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

            <span class="token comment"># non-maximun suppression, independently done per class</span>
            <span class="token comment"># 执行nms处理，执行后的结果会按照scores从大到小进行排序返回</span>
            keep <span class="token operator">=</span> box_ops<span class="token punctuation">.</span>batched_nms<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">)</span>

            <span class="token comment"># keep only topk scoring predictions</span>
            <span class="token comment"># 获取scores排在前topk个预测目标</span>
            keep <span class="token operator">=</span> keep<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>detection_per_img<span class="token punctuation">]</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> labels <span class="token operator">=</span> boxes<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> scores<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

            all_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
            all_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>scores<span class="token punctuation">)</span>
            all_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>

        <span class="token keyword">return</span> all_boxes<span class="token punctuation">,</span> all_scores<span class="token punctuation">,</span> all_labels

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                features<span class="token punctuation">,</span>       <span class="token comment"># type: Dict[str, Tensor]</span>
                proposals<span class="token punctuation">,</span>      <span class="token comment"># type: List[Tensor]</span>
                image_shapes<span class="token punctuation">,</span>   <span class="token comment"># type: List[Tuple[int, int]]</span>
                targets<span class="token operator">=</span><span class="token boolean">None</span>    <span class="token comment"># type: Optional[List[Dict[str, Tensor]]]</span>
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (...) -> Tuple[List[Dict[str, Tensor]], Dict[str, Tensor]]</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            features (List[Tensor])： 输入图片经过backbone生成的特征图
            proposals (List[Tensor[N, 4]])： RPN生成的proposals
            image_shapes (List[Tuple[H, W]])： 图像预处理之后的大小
            targets (List[Dict])： GT的annotation信息
        """</span>

        <span class="token comment"># 检查targets的数据类型是否正确</span>
        <span class="token keyword">if</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">:</span>
                floating_point_types <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>double<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>half<span class="token punctuation">)</span>
                <span class="token keyword">assert</span> t<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token keyword">in</span> floating_point_types<span class="token punctuation">,</span> <span class="token string">"target boxes must of float type"</span>
                <span class="token keyword">assert</span> t<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype <span class="token operator">==</span> torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> <span class="token string">"target labels must of int64 type"</span>

        <span class="token triple-quoted-string string">"""
            如果是训练模式，则需选取使用的样本。这是因为RPN在训练模式下会保留2000个proposal，但在训练时只需从中采样512个即可；
            如果是验证模式，则RPN仅会保留1000个proposal
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token comment"># 划分正负样本，统计对应gt的标签以及边界框回归信息</span>
            proposals<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>select_training_samples<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># eval模式下没有GT</span>
            labels <span class="token operator">=</span> <span class="token boolean">None</span>
            regression_targets <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 将采集样本通过Multi-scale RoIAlign pooling层</span>
        <span class="token comment"># box_features_shape: [num_proposals, channel, height, width]</span>
        <span class="token triple-quoted-string string">"""
            这里的box_roi_pool就是ROI Pooling，经过它的proposal.shape变为(7, 7)
            
            参数：
                1. features：输入预测层（如果是MobileNet v2那么仅有一个，如果是ResNet50+FPN则有4个） 
                2. proposals：每张图保留的512个proposal
                3. image_shapes：每张图缩放之后得到的尺寸
                    这里图片缩放的并不是简单的Resize，而是将图片与想要尺寸在左上角进行对齐，不足的地方用0填充
                    这里图片的缩放后的尺寸是我们在dataloader里定义的尺寸，程序里是（224, 224）
                (7,7)是输入预测特征层的proposal经过ROI Pooling后的尺寸
            返回值：
                box_features: 经过ROI Pooling返回的每个proposal对应的feature maps，shape为torch.Size([1024, 256, 7, 7])
                1024是表示这是每个batch的累加（512 + 512 = 1024）
            
        """</span>
        box_features <span class="token operator">=</span> self<span class="token punctuation">.</span>box_roi_pool<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> image_shapes<span class="token punctuation">)</span>

        <span class="token comment"># 通过roi_pooling后的两层全连接层</span>
        <span class="token comment"># box_features_shape: [num_proposals, representation_size]</span>
        <span class="token triple-quoted-string string">"""
            box_head: 对应着图片上的Two MLP Head
            返回值：
                经过两个FC返回的一维向量。前一个表示BS，后一个表示FC的输出维度
        """</span>
        box_features <span class="token operator">=</span> self<span class="token punctuation">.</span>box_head<span class="token punctuation">(</span>box_features<span class="token punctuation">)</span>

        <span class="token comment"># 接着分别预测目标类别和边界框回归参数（并行结构）</span>
        <span class="token triple-quoted-string string">"""
            再将Two MLP Head的值分别经过两个并行的FC得到：
                1. 类别分数     torch.Size([1024, 21])
                    21 = 20(NC) + 1(负样本)
                2. 预测回归参数      torch.Size([1024, 84])
                    84 = 21 * 4
        """</span>
        class_logits<span class="token punctuation">,</span> box_regression <span class="token operator">=</span> self<span class="token punctuation">.</span>box_predictor<span class="token punctuation">(</span>box_features<span class="token punctuation">)</span>

        result <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 定义一个空的list列表</span>
        losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 定义一个空的字典</span>
        <span class="token triple-quoted-string string">"""
            如果是训练模式，则会计算Fast R-CNN的损失，存入到losses这个dict中
            如果是eval模式，则不需要计算损失，直接对结果进行后处理即可
                将低概率的目标剔除、NMS处理等等
            Note:
                训练模式我们不需要看框预测的效果，因为没有必要，我们只需要知道loss就行，根据loss优化网络才是训练模式的目的
                看预测框效果那是eval模式下才应该做的
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> labels <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> regression_targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            loss_classifier<span class="token punctuation">,</span> loss_box_reg <span class="token operator">=</span> fastrcnn_loss<span class="token punctuation">(</span>
                class_logits<span class="token punctuation">,</span> box_regression<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets<span class="token punctuation">)</span>
            losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"loss_classifier"</span><span class="token punctuation">:</span> loss_classifier<span class="token punctuation">,</span>
                <span class="token string">"loss_box_reg"</span><span class="token punctuation">:</span> loss_box_reg
            <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">"""
                boxes: 最终预测的目标边界框
                scores：每个类别的分数
                labels: 对应标签
            """</span>
            boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> labels <span class="token operator">=</span> self<span class="token punctuation">.</span>postprocess_detections<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> box_regression<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> image_shapes<span class="token punctuation">)</span>
            num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
                result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token string">"boxes"</span><span class="token punctuation">:</span> boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">"labels"</span><span class="token punctuation">:</span> labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">"scores"</span><span class="token punctuation">:</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">)</span>

        <span class="token keyword">return</span> result<span class="token punctuation">,</span> losses
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="faster-r-cnn-predictor">4.5.3 Faster R-CNN Predictor</h3><p>这部分就是将Two MLP Head的输出结果送入这个预测头，得到：</p><ul><li>训练模式<ul><li>类别损失和预测框回归损失</li></ul></li><li>eval模式<ul><li>类别分数和预测框</li></ul></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FastRCNNPredictor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Standard classification + bounding box regression layers
    for Fast R-CNN.

    Arguments:
        in_channels (int): number of input channels
        num_classes (int): number of output classes (including background)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FastRCNNPredictor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cls_score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>  <span class="token comment"># 1024 -> 21(VOC)</span>
        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 1024 -> 21*4=84(VOC)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># x.shape: torch.Size([1024, 1024])</span>
        <span class="token triple-quoted-string string">"""
            >>> x = torch.randint(1, (3, 112, 112))
            >>> x.shape
            torch.Size([3, 112, 112])
            >>> x.dim()
            3
        """</span>
        <span class="token keyword">if</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>start_dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 这里的flatten其实没有什么必要</span>
        scores <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_score<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 预测目标概率分数  torch.Size([1024, 21])</span>
        bbox_deltas <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 预测目标回归参数 torch.Size([1024, 84])</span>

        <span class="token keyword">return</span> scores<span class="token punctuation">,</span> bbox_deltas
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fast-r-cnn正负样本划分及采样">4.6 Fast R-CNN正负样本划分及采样</h2><p>在训练模式中，并不是使用RPN网络生成的所有proposal，而是从中选取一部分proposal用于Fast R-CNN的损失计算。如图黄色的部分：</p><p><img src="https://cdn.jsdelivr.net/gh/Unicorn-acc/blogimgs/imgs/202211171619573.png"></p><h3 id="select_training_samples">4.6.1 select_training_samples</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
    <span class="token comment"># 划分正负样本，统计对应gt的标签以及边界框回归信息</span>
    <span class="token triple-quoted-string string">"""
        proposals：RPN生成的proposal进行了正负样本的划分
        labels：对应的标签
        regression_targets：对应GT box的回归参数
    """</span>
    proposals<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>select_training_samples<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># eval模式下没有GT</span>
    labels <span class="token operator">=</span> <span class="token boolean">None</span>
    regression_targets <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">select_training_samples</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                            proposals<span class="token punctuation">,</span>  <span class="token comment"># type: List[Tensor]</span>
                            targets     <span class="token comment"># type: Optional[List[Dict[str, Tensor]]]</span>
                            <span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># type: (...) -> Tuple[List[Tensor], List[Tensor], List[Tensor]]</span>
    <span class="token triple-quoted-string string">"""
    划分正负样本，统计对应gt的标签以及边界框回归信息
    list元素个数为batch_size
    Args:
        proposals: rpn预测的boxes
        targets: GT信息

    Returns:

    """</span>

    <span class="token comment"># 检查target数据是否为空</span>
    self<span class="token punctuation">.</span>check_targets<span class="token punctuation">(</span>targets<span class="token punctuation">)</span>
    <span class="token comment"># 如果不加这句，jit.script会不通过(看不懂)</span>
    <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>

    dtype <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype
    device <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>device

    <span class="token comment"># 获取标注好的boxes以及labels信息</span>
    <span class="token triple-quoted-string string">"""
        gt_boxes = [t["boxes"].to(dtype) for t in targets]
        gt_labels = [t["labels"] for t in targets]
            分别提取targets中的"boxes"和"labels"信息，并分别用[]包裹
    """</span>
    gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span>
    gt_labels <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> targets<span class="token punctuation">]</span>

    <span class="token comment"># append ground-truth bboxes to proposal</span>
    <span class="token comment"># 将gt_boxes拼接到proposal后面</span>
    proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>add_gt_proposals<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span>

    <span class="token comment"># get matching gt indices for each proposal</span>
    <span class="token comment"># 为每个proposal匹配对应的gt_box，并划分到正负样本中</span>
    <span class="token triple-quoted-string string">"""
        通过assign_targets_to_proposals这个方法为刚刚添加gt_boxes的proposals划分到正负样本中
            参数：
                1. proposals：self.add_gt_proposals(proposals, gt_boxes)后的proposals
                2. gt_boxes: GT的boxes
                3. gt_labels: GT的labels
            返回值：
                matched_idxs：每个proposal所匹配到的gt boxes的索引
                labels：每个proposal所匹配到的gt boxes的标签
    """</span>
    matched_idxs<span class="token punctuation">,</span> labels <span class="token operator">=</span> self<span class="token punctuation">.</span>assign_targets_to_proposals<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">)</span>
    <span class="token comment"># sample a fixed proportion of positive-negative proposals</span>
    <span class="token comment"># 按给定数量和比例采样正负样本</span>
    <span class="token triple-quoted-string string">"""
        在训练时并不是将RPN生成的proposal都用来计算损失，还需经过采样（一般为512）
    """</span>
    sampled_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>subsample<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
    matched_gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>proposals<span class="token punctuation">)</span>

    <span class="token comment"># 遍历每张图像</span>
    <span class="token keyword">for</span> img_id <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取每张图像的正负样本索引</span>
        img_sampled_inds <span class="token operator">=</span> sampled_inds<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span>
        <span class="token comment"># 获取对应正负样本的proposals信息</span>
        proposals<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> proposals<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>  <span class="token comment"># [2003, 4] -> [512, 4]</span>
        <span class="token comment"># 获取对应正负样本的真实类别信息</span>
        labels<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> labels<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>  <span class="token comment"># [2003,] -> [512,]</span>
        <span class="token comment"># 获取对应正负样本的gt索引信息</span>
        matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span> <span class="token operator">=</span> matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>

        <span class="token comment"># 提取gt boxes的信息； img_id为图片的id</span>
        gt_boxes_in_image <span class="token operator">=</span> gt_boxes<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span>  <span class="token comment"># torch.Size([3, 4])， 其中3表示该图片有3个gt boxes，4为对应的坐标</span>
        <span class="token keyword">if</span> gt_boxes_in_image<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            gt_boxes_in_image <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        <span class="token comment"># 获取对应正负样本的gt box信息</span>
        <span class="token triple-quoted-string string">"""
            matched_gt_boxes: torch.Size([512, 4])
                其中：
                    512为采样的proposal对应的gt box
                    4为对应gt box的坐标
                Note:
                    是proposal对应的gt box而不是proposal
        """</span>
        matched_gt_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gt_boxes_in_image<span class="token punctuation">[</span>matched_idxs<span class="token punctuation">[</span>img_id<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 根据gt和proposal计算边框回归参数</span>
    <span class="token comment"># Note: 这里的回归参数是 针对gt而言的</span>
    <span class="token triple-quoted-string string">"""
        1. matched_gt_boxes: proposal匹配到的gt box
        2. proposals: 采样后的proposal, shape: [512, 4]
        
        regression_targets: 根据gt box和proposal得到的关于x,y,h,w的回归参数
            用list保存的，每一张图片为一个元素
    """</span>
    regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>matched_gt_boxes<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>
    <span class="token triple-quoted-string string">"""
        Return
            proposals： 添加了gt的proposals
            labels： 对应的标签
            regression_targets: 根据gt box和proposal得到的关于x,y,h,w的回归参数
    """</span>
    <span class="token keyword">return</span> proposals<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> regression_targets
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fast-r-cnn的损失计算">4.7 Fast R-CNN的损失计算</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> warnings
<span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Tuple<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Union

<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token punctuation">,</span> Tensor
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>ops <span class="token keyword">import</span> MultiScaleRoIAlign

<span class="token keyword">from</span> <span class="token punctuation">.</span>roi_head <span class="token keyword">import</span> RoIHeads
<span class="token keyword">from</span> <span class="token punctuation">.</span>transform <span class="token keyword">import</span> GeneralizedRCNNTransform
<span class="token keyword">from</span> <span class="token punctuation">.</span>rpn_function <span class="token keyword">import</span> AnchorsGenerator<span class="token punctuation">,</span> RPNHead<span class="token punctuation">,</span> RegionProposalNetwork


<span class="token keyword">class</span> <span class="token class-name">FasterRCNNBase</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main class for Generalized R-CNN.

    Arguments:
        backbone (nn.Module): 特征提取网络部分
        rpn (nn.Module): 候选框生成部分
        roi_heads (nn.Module): takes the features + the proposals from the RPN and computes
            detections / masks from it.
        transform (nn.Module): performs the data transformation from the inputs to feed into
            the model
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> backbone
        self<span class="token punctuation">.</span>rpn <span class="token operator">=</span> rpn
        self<span class="token punctuation">.</span>roi_heads <span class="token operator">=</span> roi_heads
        <span class="token comment"># used only on torchscript mode</span>
        self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>unused</span>
    <span class="token keyword">def</span> <span class="token function">eager_outputs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (Dict[str, Tensor], List[Dict[str, Tensor]]) -> Union[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">return</span> losses

        <span class="token keyword">return</span> detections

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># type: (List[Tensor], Optional[List[Dict[str, Tensor]]]) -> Tuple[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        <span class="token triple-quoted-string string">"""
        Arguments:
            images (list[Tensor]): images to be processed
            targets (list[Dict[Tensor]]): ground-truth boxes present in the image (optional)

        Returns:
            result (list[BoxList] or dict[Tensor]): the output from the model.
                During training, it returns a dict[Tensor] which contains the losses.
                During testing, it returns list[BoxList] contains additional fields
                like `scores`, `labels` and `mask` (for Mask R-CNN models).

        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> targets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"In training mode, targets should be passed"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
            <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">:</span>         <span class="token comment"># 进一步判断传入的target的boxes参数是否符合规定</span>
                boxes <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token keyword">or</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be a tensor"</span>
                                         <span class="token string">"of shape [N, 4], got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                                          boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Expected target boxes to be of type "</span>
                                     <span class="token string">"Tensor, got &#123;:&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># original_image_sizes：存储每张图片原始的尺寸，为了之后可以映射到原图中</span>
        original_image_sizes <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> img <span class="token keyword">in</span> images<span class="token punctuation">:</span>
            val <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># [H, W]</span>
            <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span>  <span class="token comment"># 防止输入的是个一维向量</span>
            original_image_sizes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># original_image_sizes = [img.shape[-2:] for img in images]</span>

        images<span class="token punctuation">,</span> targets <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>images<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>  <span class="token comment"># 对图像进行预处理</span>
        <span class="token comment"># [(images, targets), (images, targets), ...]这才是需要送入网络的batch</span>

        <span class="token comment"># print(images.tensors.shape)</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>images<span class="token punctuation">.</span>tensors<span class="token punctuation">)</span>  <span class="token comment"># 将图像输入backbone得到特征图</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 若只在一层特征层上预测，将feature放入有序字典中，并编号为‘0’</span>
            features <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> features<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 若在多层特征层上预测，传入的就是一个有序字典</span>

        <span class="token comment"># 将特征层以及标注target信息传入rpn中</span>
        <span class="token triple-quoted-string string">"""
            Input:
                1. images：输入图片(shape -> torch.Size([2, 3, 800, 1088]))
                2. features: 预测特征层（对于MobileNet v2只有一个，对于Resnet50+FPN有4个 -> "0", "1", "2", "3", "pool"）
                    "0": torch.Size([2, 256, 200, 272])
                    "1": torch.Size([2, 256, 100, 136])
                    "2": torch.Size([2, 256, 50, 68])
                    "3": torch.Size([2, 256, 25, 34])
                    "pool": torch.Size([2, 256, 13, 17])
                3. targets：annotation的一些信息
                    这里batch size设置为2，故有该list由两部分组成，每一个均有下面的属性
                    "boxes": torch.Size([1, 4])： 坐标信息
                    "label": 4
                    "image_id": 4
                    "area": 4
                    "iscrowd": 4
            Output: 
                1. proposal：预测框，是一个list，最外层元素数量等于batch_size。
                    每一个元素的shape为：[2000, 4] -> RPN生成2000个预测框（proposal）和其4个坐标
                2. proposal_losses：预测框与GT的损失，也是分为两个部分
                    1. loss_objectness：类别损失（是一个标量）
                    2. loss_rpn_box_reg：回归损失（是一个标量）
        """</span>
        <span class="token comment"># proposals: List[Tensor], Tensor_shape: [num_proposals, 4],</span>
        <span class="token comment"># 每个proposals是绝对坐标，且为(x1, y1, x2, y2)格式</span>
        proposals<span class="token punctuation">,</span> proposal_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 将rpn生成的数据以及标注target信息传入fast rcnn后半部分</span>
        <span class="token triple-quoted-string string">"""
            detections: 最终的框
            detector_losses： 最终框的损失
        """</span>
        detections<span class="token punctuation">,</span> detector_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>roi_heads<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        <span class="token comment"># 对网络的预测结果进行后处理（主要将bboxes还原到原图像尺度上）</span>
        detections <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>postprocess<span class="token punctuation">(</span>detections<span class="token punctuation">,</span> images<span class="token punctuation">.</span>image_sizes<span class="token punctuation">,</span> original_image_sizes<span class="token punctuation">)</span>

        losses <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detector_losses<span class="token punctuation">)</span>
        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>proposal_losses<span class="token punctuation">)</span>

        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>is_scripting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_has_warned<span class="token punctuation">:</span>
                warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">"RCNN always returns a (Losses, Detections) tuple in scripting"</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>_has_warned <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">return</span> losses<span class="token punctuation">,</span> detections
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>eager_outputs<span class="token punctuation">(</span>losses<span class="token punctuation">,</span> detections<span class="token punctuation">)</span>

        <span class="token comment"># if self.training:</span>
        <span class="token comment">#     return losses</span>
        <span class="token comment">#</span>
        <span class="token comment"># return detections</span>


<span class="token keyword">class</span> <span class="token class-name">TwoMLPHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Standard heads for FPN-based models

    Arguments:
        in_channels (int): number of input channels
        representation_size (int): size of the intermediate representation
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TwoMLPHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fc6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>representation_size<span class="token punctuation">,</span> representation_size<span class="token punctuation">)</span>  <span class="token comment"># 输入等于输出，representation_size为固定值1024</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
            这里的x就是通过ROI Pooling的输出，即每个proposal对应的特征矩阵
            x.shape: torch.Size([1024, 256, 7, 7])
                1024: 整个batch（这里bs=2）代表的总的proposal的个数（512 + 512）
                256： channel
                7,7: height and width
        """</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>start_dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [BS, C, H, W] -> [BS, C*H*W]  torch.Size([1024, 12544])</span>

        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc6<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 图中FC_1</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 图中FC_2</span>

        <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">FastRCNNPredictor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Standard classification + bounding box regression layers
    for Fast R-CNN.

    Arguments:
        in_channels (int): number of input channels
        num_classes (int): number of output classes (including background)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FastRCNNPredictor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cls_score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>  <span class="token comment"># 1024 -> 21(VOC)</span>
        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 1024 -> 21*4=84(VOC)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># x.shape: torch.Size([1024, 1024])</span>
        <span class="token triple-quoted-string string">"""
            >>> x = torch.randint(1, (3, 112, 112))
            >>> x.shape
            torch.Size([3, 112, 112])
            >>> x.dim()
            3
        """</span>
        <span class="token keyword">if</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>start_dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 这里的flatten其实没有什么必要</span>
        scores <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_score<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 预测目标概率分数  torch.Size([1024, 21])</span>
        bbox_deltas <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 预测目标回归参数 torch.Size([1024, 84])</span>

        <span class="token keyword">return</span> scores<span class="token punctuation">,</span> bbox_deltas


<span class="token keyword">class</span> <span class="token class-name">FasterRCNN</span><span class="token punctuation">(</span>FasterRCNNBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Implements Faster R-CNN.

    The input to the model is expected to be a list of tensors, each of shape [C, H, W], one for each
    image, and should be in 0-1 range. Different images can have different sizes.

    The behavior of the model changes depending if it is in training or evaluation mode.

    During training, the model expects both the input tensors, as well as a targets (list of dictionary),
    containing:
        - boxes (FloatTensor[N, 4]): the ground-truth boxes in [x1, y1, x2, y2] format, with values
          between 0 and H and 0 and W
        - labels (Int64Tensor[N]): the class label for each ground-truth box

    The model returns a Dict[Tensor] during training, containing the classification and regression
    losses for both the RPN and the R-CNN.

    During inference, the model requires only the input tensors, and returns the post-processed
    predictions as a List[Dict[Tensor]], one for each input image. The fields of the Dict are as
    follows:
        - boxes (FloatTensor[N, 4]): the predicted boxes in [x1, y1, x2, y2] format, with values between
          0 and H and 0 and W
        - labels (Int64Tensor[N]): the predicted labels for each image
        - scores (Tensor[N]): the scores or each prediction

    Arguments:
        backbone (nn.Module): the network used to compute the features for the model.
            It should contain a out_channels attribute, which indicates the number of output
            channels that each feature map has (and it should be the same for all feature maps).
            The backbone should return a single Tensor or and OrderedDict[Tensor].
        num_classes (int): number of output classes of the model (including the background).
            If box_predictor is specified, num_classes should be None.
        min_size (int): minimum size of the image to be rescaled before feeding it to the backbone
        max_size (int): maximum size of the image to be rescaled before feeding it to the backbone
        image_mean (Tuple[float, float, float]): mean values used for input normalization.
            They are generally the mean values of the dataset on which the backbone has been trained
            on
        image_std (Tuple[float, float, float]): std values used for input normalization.
            They are generally the std values of the dataset on which the backbone has been trained on
        rpn_anchor_generator (AnchorGenerator): module that generates the anchors for a set of feature
            maps.
        rpn_head (nn.Module): module that computes the objectness and regression deltas from the RPN
        rpn_pre_nms_top_n_train (int): number of proposals to keep before applying NMS during training
        rpn_pre_nms_top_n_test (int): number of proposals to keep before applying NMS during testing
        rpn_post_nms_top_n_train (int): number of proposals to keep after applying NMS during training
        rpn_post_nms_top_n_test (int): number of proposals to keep after applying NMS during testing
        rpn_nms_thresh (float): NMS threshold used for postprocessing the RPN proposals
        rpn_fg_iou_thresh (float): minimum IoU between the anchor and the GT box so that they can be
            considered as positive during training of the RPN.
        rpn_bg_iou_thresh (float): maximum IoU between the anchor and the GT box so that they can be
            considered as negative during training of the RPN.
        rpn_batch_size_per_image (int): number of anchors that are sampled during training of the RPN
            for computing the loss
        rpn_positive_fraction (float): proportion of positive anchors in a mini-batch during training
            of the RPN
        rpn_score_thresh (float): during inference, only return proposals with a classification score
            greater than rpn_score_thresh
        box_roi_pool (MultiScaleRoIAlign): the module which crops and resizes the feature maps in
            the locations indicated by the bounding boxes
        box_head (nn.Module): module that takes the cropped feature maps as input
        box_predictor (nn.Module): module that takes the output of box_head and returns the
            classification logits and box regression deltas.
        box_score_thresh (float): during inference, only return proposals with a classification score
            greater than box_score_thresh
        box_nms_thresh (float): NMS threshold for the prediction head. Used during inference
        box_detections_per_img (int): maximum number of detections per image, for all classes.
        box_fg_iou_thresh (float): minimum IoU between the proposals and the GT box so that they can be
            considered as positive during training of the classification head
        box_bg_iou_thresh (float): maximum IoU between the proposals and the GT box so that they can be
            considered as negative during training of the classification head
        box_batch_size_per_image (int): number of proposals that are sampled during training of the
            classification head
        box_positive_fraction (float): proportion of positive proposals in a mini-batch during training
            of the classification head
        bbox_reg_weights (Tuple[float, float, float, float]): weights for the encoding/decoding of the
            bounding boxes

    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># num_classes是需要加上背景的</span>
                 <span class="token comment"># transform parameter</span>
                 min_size<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1333</span><span class="token punctuation">,</span>      <span class="token comment"># 预处理resize时限制的最小尺寸与最大尺寸</span>
                 image_mean<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> image_std<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 预处理normalize时使用的均值和方差</span>
                 <span class="token comment"># RPN parameters</span>
                 rpn_anchor_generator<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> rpn_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 rpn_pre_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_pre_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment"># rpn中在nms处理前保留的proposal数(根据score)</span>
                 rpn_post_nms_top_n_train<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> rpn_post_nms_top_n_test<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中在nms处理后保留的proposal数</span>
                 rpn_nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>  <span class="token comment"># rpn中进行nms处理时使用的iou阈值</span>
                 rpn_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时，采集正负样本设置的阈值</span>
                 rpn_batch_size_per_image<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> rpn_positive_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># rpn计算损失时采样的样本数，以及正样本占总样本的比例</span>
                 rpn_score_thresh<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
                 <span class="token comment"># Box parameters</span>
                 box_roi_pool<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> box_predictor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token comment"># 移除低目标概率      fast rcnn中进行nms处理的阈值   对预测结果根据score排序取前100个目标</span>
                 box_score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span> box_nms_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_detections_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                 box_fg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> box_bg_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>   <span class="token comment"># fast rcnn计算误差时，采集正负样本设置的阈值</span>
                 box_batch_size_per_image<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> box_positive_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># fast rcnn计算误差时采样的样本数，以及正样本占所有样本的比例</span>
                 bbox_reg_weights<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> <span class="token string">"out_channels"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>
                <span class="token string">"backbone should contain an attribute out_channels"</span>
                <span class="token string">"specifying the number of output channels  (assumed to be the"</span>
                <span class="token string">"same for all the levels"</span>
            <span class="token punctuation">)</span>

        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>rpn_anchor_generator<span class="token punctuation">,</span> <span class="token punctuation">(</span>AnchorsGenerator<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 传入None也可以，传入None后面会生成一个</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>box_roi_pool<span class="token punctuation">,</span> <span class="token punctuation">(</span>MultiScaleRoIAlign<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> num_classes <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># 如果box_predictor不为None，报错</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should be None when box_predictor "</span>
                                 <span class="token string">"is specified"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"num_classes should not be None when box_predictor "</span>
                                 <span class="token string">"is not specified"</span><span class="token punctuation">)</span>

        <span class="token comment"># 预测特征层的channels</span>
        out_channels <span class="token operator">=</span> backbone<span class="token punctuation">.</span>out_channels

        <span class="token comment"># 若anchor生成器为空，则自动生成针对resnet50_fpn的anchor生成器</span>
        <span class="token triple-quoted-string string">"""
            >>> ((0.5, 1.0, 2.0),) * 5
                ((0.5, 1.0, 2.0), (0.5, 1.0, 2.0), (0.5, 1.0, 2.0), (0.5, 1.0, 2.0), (0.5, 1.0, 2.0))
        """</span>
        <span class="token keyword">if</span> rpn_anchor_generator <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            anchor_sizes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            aspect_ratios <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_sizes<span class="token punctuation">)</span>
            rpn_anchor_generator <span class="token operator">=</span> AnchorsGenerator<span class="token punctuation">(</span>
                anchor_sizes<span class="token punctuation">,</span> aspect_ratios
            <span class="token punctuation">)</span>

        <span class="token comment"># 生成RPN通过滑动窗口预测网络部分</span>
        <span class="token keyword">if</span> rpn_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            rpn_head <span class="token operator">=</span> RPNHead<span class="token punctuation">(</span>
                out_channels<span class="token punctuation">,</span> rpn_anchor_generator<span class="token punctuation">.</span>num_anchors_per_location<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># 默认rpn_pre_nms_top_n_train = 2000, rpn_pre_nms_top_n_test = 1000,</span>
        <span class="token comment"># 默认rpn_post_nms_top_n_train = 2000, rpn_post_nms_top_n_test = 1000,</span>
        rpn_pre_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_pre_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_pre_nms_top_n_test<span class="token punctuation">)</span>
        rpn_post_nms_top_n <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>training<span class="token operator">=</span>rpn_post_nms_top_n_train<span class="token punctuation">,</span> testing<span class="token operator">=</span>rpn_post_nms_top_n_test<span class="token punctuation">)</span>

        <span class="token comment"># 定义整个RPN框架</span>
        <span class="token comment"># rpn_batch_size_per_image: RPN算计损失时采用正负样本的总个数</span>
        <span class="token comment"># rpn_positive_fraction：正样本占所有用于计算损失所有样本的比例</span>
        <span class="token comment"># rpn_pre_nms_top_n： 在进行NMS处理之前，针对每一个预测特征层所保留的目标个数</span>
        <span class="token comment"># rpn_post_nms_top_n： 在进行NMS处理之后，针对每一个预测特征层所剩余的目标个数（即RPN输出候选框的数目）</span>
        <span class="token comment"># rpn_nms_thresh：NMS处理时所指定的阈值</span>
        rpn <span class="token operator">=</span> RegionProposalNetwork<span class="token punctuation">(</span>
            rpn_anchor_generator<span class="token punctuation">,</span> rpn_head<span class="token punctuation">,</span>
            rpn_fg_iou_thresh<span class="token punctuation">,</span> rpn_bg_iou_thresh<span class="token punctuation">,</span>
            rpn_batch_size_per_image<span class="token punctuation">,</span> rpn_positive_fraction<span class="token punctuation">,</span>
            rpn_pre_nms_top_n<span class="token punctuation">,</span> rpn_post_nms_top_n<span class="token punctuation">,</span> rpn_nms_thresh<span class="token punctuation">,</span>
            score_thresh<span class="token operator">=</span>rpn_score_thresh<span class="token punctuation">)</span>

        <span class="token comment">#  Multi-scale RoIAlign pooling</span>
        <span class="token keyword">if</span> box_roi_pool <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            box_roi_pool <span class="token operator">=</span> MultiScaleRoIAlign<span class="token punctuation">(</span>  <span class="token comment"># 这里就是ROI Pooling</span>
                featmap_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 在哪些特征层进行roi pooling</span>
                output_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 这里给出了ROI Pooling后输出的shape</span>
                sampling_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># fast RCNN中roi pooling后的展平处理两个全连接层部分</span>
        <span class="token keyword">if</span> box_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            resolution <span class="token operator">=</span> box_roi_pool<span class="token punctuation">.</span>output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 默认等于7</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>
            box_head <span class="token operator">=</span> TwoMLPHead<span class="token punctuation">(</span>
                out_channels <span class="token operator">*</span> resolution <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># flatten层的输出，即tensor展平后的元素个数，也是FC_1的输入</span>
                representation_size  <span class="token comment"># FC_1的输出，也是FC_2的输入和输出</span>
            <span class="token punctuation">)</span>  <span class="token comment"># flatten -> in_channels -> representation_size -> representation_size</span>

        <span class="token comment"># 在box_head的输出上预测部分</span>
        <span class="token keyword">if</span> box_predictor <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            representation_size <span class="token operator">=</span> <span class="token number">1024</span>  <span class="token comment"># Two MLP Head的输出，为固定值1024</span>
            box_predictor <span class="token operator">=</span> FastRCNNPredictor<span class="token punctuation">(</span>
                representation_size<span class="token punctuation">,</span>  <span class="token comment"># Two MLP Head的输出，为固定值1024</span>
                num_classes<span class="token punctuation">)</span>  <span class="token comment"># num_classes为NC（加了背景的，VOC为20+1=21）</span>

        <span class="token comment"># 将roi pooling, box_head以及box_predictor结合在一起</span>
        <span class="token triple-quoted-string string">"""
            1. box_roi_pool: ROI Pooling
            2. box_head: Two MLP Head
            3. box_predictor: Fast R-CNN Predictor
                function:
                    将Two MLP Head的结果并行通过两个FC
                out: 
                    1. cls_logits：每一个proposal的类别分数  [1024, 21](bs=2)
                    2. box_pred：每一个proposal对应的目标框的回归参数  [1024, 21*4=84](bs=2)
            4. box_fg_iou_thresh（0.5）
            5. box_bg_iou_thresh（0.5）
                4和5：在前面匹配正负样本
                    如果proposal与GT的IoU>阈值 -> 正样本
                    如果proposal与GT的IoU&lt;阈值 -> 负样本
            6. box_batch_size_per_image（512）：每张图片会选取box_batch_size_per_image个proposal用于计算fast r-cnn的损失
            7. box_positive_fraction（0.25）：指定样本中（即512个样本），正样本所占的比例
                在训练过程中，并不是直接使用RPN生成的2000个proposal，而是从中采样、选取512个proposal
            8. bbox_reg_weights：超参数
            9. box_score_thresh, box_nms_thresh, box_detections_per_img：对最终预测的结果进行post-processing（后处理）的时候使用
               到的一些阈值
        """</span>
        roi_heads <span class="token operator">=</span> RoIHeads<span class="token punctuation">(</span>
            <span class="token comment"># box</span>
            box_roi_pool<span class="token punctuation">,</span> box_head<span class="token punctuation">,</span> box_predictor<span class="token punctuation">,</span>
            box_fg_iou_thresh<span class="token punctuation">,</span> box_bg_iou_thresh<span class="token punctuation">,</span>  <span class="token comment"># 0.5  0.5</span>
            box_batch_size_per_image<span class="token punctuation">,</span> box_positive_fraction<span class="token punctuation">,</span>  <span class="token comment"># 512  0.25</span>
            bbox_reg_weights<span class="token punctuation">,</span>
            box_score_thresh<span class="token punctuation">,</span> box_nms_thresh<span class="token punctuation">,</span> box_detections_per_img<span class="token punctuation">)</span>  <span class="token comment"># 0.05  0.5  100</span>

        <span class="token keyword">if</span> image_mean <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_mean <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> image_std <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image_std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>

        <span class="token comment"># 对数据进行标准化，缩放，打包成batch等处理部分</span>
        transform <span class="token operator">=</span> GeneralizedRCNNTransform<span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> image_mean<span class="token punctuation">,</span> image_std<span class="token punctuation">)</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> rpn<span class="token punctuation">,</span> roi_heads<span class="token punctuation">,</span> transform<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://Unicorn-acc.github.io">Miraclo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://unicorn-acc.github.io/posts/21243.html">http://unicorn-acc.github.io/posts/21243.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Unicorn-acc.github.io" target="_blank">Miraclo’s Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DeepLearning/">DeepLearning</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/vq/wallhaven-vqmyq3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3778.html"><img class="prev-cover" src="https://w.wallhaven.cc/full/x6/wallhaven-x619o3.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LC-1562.查找大小为 M 的最新分组</div></div></a></div><div class="next-post pull-right"><a href="/posts/36771.html"><img class="next-cover" src="https://w.wallhaven.cc/full/p9/wallhaven-p9273e.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LC-1488.避免洪水泛滥</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/32234.html" title="CV可解释性分析_CAM热力图"><img class="cover" src="https://w.wallhaven.cc/full/kx/wallhaven-kx3p1q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-03</div><div class="title">CV可解释性分析_CAM热力图</div></div></a></div><div><a href="/posts/11760.html" title="CV可解释性分析_Grad-CAM"><img class="cover" src="https://w.wallhaven.cc/full/d6/wallhaven-d65mzm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-03</div><div class="title">CV可解释性分析_Grad-CAM</div></div></a></div><div><a href="/posts/5074.html" title="图像分类_CIFAR10数据集"><img class="cover" src="https://w.wallhaven.cc/full/1p/wallhaven-1pjml1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">图像分类_CIFAR10数据集</div></div></a></div><div><a href="/posts/47625.html" title="图像分类_Fashion-MNIST数据集(ResNet18进行迁移学习)"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-04</div><div class="title">图像分类_Fashion-MNIST数据集(ResNet18进行迁移学习)</div></div></a></div><div><a href="/posts/56670.html" title="目标检测&#x2F;分割_PASCAL VOC2012数据集与制作自己的数据集(VOC格式)"><img class="cover" src="https://w.wallhaven.cc/full/x6/wallhaven-x619o3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-11</div><div class="title">目标检测&#x2F;分割_PASCAL VOC2012数据集与制作自己的数据集(VOC格式)</div></div></a></div><div><a href="/posts/2490.html" title="图像分类_花分类数据集"><img class="cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-06</div><div class="title">图像分类_花分类数据集</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">0 代码的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0pytorch%E5%AE%98%E6%96%B9%E7%9A%84%E6%A8%A1%E5%9E%8B%E6%BA%90%E7%A0%81"><span class="toc-text">0.1 如何找到PyTorch官方的模型源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0pytorch%E5%AE%98%E6%96%B9%E7%9A%84%E8%AE%AD%E7%BB%83%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-text">0.2 如何找到PyTorch官方的训练相关代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">0.3 环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">0.4 文件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pascal_voc_classes.json"><span class="toc-text">0.5 pascal_voc_classes.json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E8%AE%AD%E7%BB%83%E6%9D%83%E9%87%8D%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80%E4%B8%8B%E8%BD%BD%E5%90%8E%E6%94%BE%E5%85%A5backbone%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD"><span class="toc-text">0.6 预训练权重下载地址（下载后放入backbone文件夹中）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-text">0.7 数据集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%96%B9%E6%B3%95"><span class="toc-text">0.8 训练方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">0.9 注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83train.py"><span class="toc-text">0.10 训练train.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8mobilenetv2%E4%BD%9C%E4%B8%BAbackbone"><span class="toc-text">使用mobilenetv2作为backbone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8resnet50fpn%E4%BD%9C%E4%B8%BAbackbone"><span class="toc-text">使用resnet50+fpn作为BackBone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dataloader%E4%B8%ADcollate_fn%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">0.10.1 DataLoader中collate_fn的作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E6%B5%8Bpredict.py"><span class="toc-text">0.1 预测predict.py</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89dataset"><span class="toc-text">1. 自定义Dataset</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89dataset%E4%BB%A3%E7%A0%81"><span class="toc-text">1.1 自定义dataset代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89transform"><span class="toc-text">1.2 自定义transform</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89dataset%E7%9A%84%E9%87%8D%E7%82%B9"><span class="toc-text">1.3 自定义Dataset的重点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84dataset%E5%B9%B6%E6%9F%A5%E7%9C%8B%E5%9B%BE%E7%89%87"><span class="toc-text">1.4 测试自定义的Dataset并查看图片</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#faster-r-cnn%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">2. Faster R-CNN架构图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#transform---transform.py"><span class="toc-text">3、Transform - transform.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-text">3.1 训练预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E5%90%8E%E5%A4%84%E7%90%86"><span class="toc-text">3.2 训练后处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rpn%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3---rpn_function.py"><span class="toc-text">4、RPN源码讲解 - rpn_function.py</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rpn-head%E7%94%9F%E6%88%90%E7%9B%AE%E6%A0%87%E5%BE%97%E5%88%86%E6%A6%82%E7%8E%87%E5%92%8C%E5%9D%90%E6%A0%87%E5%9B%9E%E5%BD%92%E5%8F%82%E6%95%B0"><span class="toc-text">4.1 RPN Head生成目标得分概率和坐标回归参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#anchors-generator%E7%94%9F%E9%94%9A%E6%A1%86"><span class="toc-text">4.2 Anchors Generator生锚框</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#region-proposal-network"><span class="toc-text">4.3 Region Proposal Network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#detection-utils"><span class="toc-text">4.4 Detection utils</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roi-aligntwo-mlp-head-faster-r-cnn-predictor"><span class="toc-text">4.5 ROI Align、Two MLP Head、 Faster R-CNN Predictor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#roi-align"><span class="toc-text">4.5.1 ROI Align</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#two-mlp-head"><span class="toc-text">4.5.2 Two MLP Head</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#faster-r-cnn-predictor"><span class="toc-text">4.5.3 Faster R-CNN Predictor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fast-r-cnn%E6%AD%A3%E8%B4%9F%E6%A0%B7%E6%9C%AC%E5%88%92%E5%88%86%E5%8F%8A%E9%87%87%E6%A0%B7"><span class="toc-text">4.6 Fast R-CNN正负样本划分及采样</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#select_training_samples"><span class="toc-text">4.6.1 select_training_samples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fast-r-cnn%E7%9A%84%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97"><span class="toc-text">4.7 Fast R-CNN的损失计算</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By Miraclo</div><div class="footer_custom_text">人只有在走上坡路的时候才会累和迷茫。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.1},options:{renderActions:{findScript:[10,t=>{for(const n of document.querySelectorAll('script[type^="math/tex"]')){var e=!!n.type.match(/; *mode=display/),e=new t.options.MathItem(n.textContent,t.inputJax[0],e),a=document.createTextNode("");n.parentNode.replaceChild(a,n),e.start={node:a,delim:"",n:0},e.end={node:a,delim:"",n:0},t.math.push(e)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(t=>{t.hasAttribute("display")?btf.wrap(t,"div",{class:"mathjax-overflow"}):btf.wrap(t,"span",{class:"mathjax-overflow"})})},"",!1]}}};const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",a.id="MathJax-script",a.async=!0,document.head.appendChild(a)}</script></div><link rel="stylesheet" href="/css/Lete.css"><script src="/js/custom.js"></script><script src="/js/mouth.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax>var parent,child;document.getElementById("recent-posts")&&"/"===location.pathname&&(parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/Java技术栈/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Java技术栈相关 (53)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/深度学习笔记/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 深度学习笔记相关 (20)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/深度学习笔记/网络模型/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 网络模型 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/算法刷题记录/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">‍💻 算法刷题记录 (59)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://Unicorn-acc.github.io/categories/数据库/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">‍👓 数据库相关 (36)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="http://Unicorn-acc.github.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>',console.log("已挂载magnet"),parent.insertAdjacentHTML("afterbegin",child))</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(33.333333333333336% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:#b30070}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style></body></html>